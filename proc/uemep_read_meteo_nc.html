<!-- -*- mode: jinja2 -*- -->

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
      <meta name="description" content="Air quality dispersion model for high resolution downscaling of EMEP-MSC-W">
    <meta name="author" content="" >
    <link rel="icon" href="../favicon.png">

    <title>uEMEP_read_meteo_nc &ndash; uEMEP</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link href="../css/pygments.css" rel="stylesheet">
    <link href="../css/font-awesome.min.css" rel="stylesheet">
    <link href="../css/local.css" rel="stylesheet">
      <link  href="../tipuesearch/tipuesearch.css" rel="stylesheet">

    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="../js/svg-pan-zoom.min.js"></script>
  </head>

  <body>

    <!-- Fixed navbar -->
    <div class="container-fluid mb-sm-4 mb-xl-2">
      <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container">
          <a class="navbar-brand" href="../index.html">uEMEP </a>
          <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar"
                  aria-expanded="false" aria-controls="navbar" aria-label="Toggle navigation">
                  <span class="navbar-toggler-icon">
          </button>

          <div id="navbar" class="navbar-collapse collapse">
            <ul class="navbar-nav">
                <li class="nav-item"><a class="nav-link" href="../page/index.html">Model Documentation</a></li>
                  <li class="nav-item">
                    <a class="nav-link" href="../lists/files.html">Source Files</a>
                  </li>
                <li class="nav-item">
                  <a class="nav-link" href="../lists/modules.html">Modules</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="../lists/procedures.html">Procedures</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="../program/uemep_v6.html">Program</a>
                </li>
            </ul>
              <div class="d-flex align-items-end flex-grow-1">
                <form action="../search.html" role="search" class="ms-auto">
                  <input type="text" class="form-control" aria-label="Search" placeholder="Search" name="q" id="tipue_search_input" autocomplete="off" required>
                </form>
              </div>
          </div><!--/.nav-collapse -->
        </div>
      </nav>
    </div>

    <div class="container">
  <div class="row">
    <h1>uEMEP_read_meteo_nc
      <small>Subroutine</small>
      
    </h1>
      <div class="container p-2 mb-4 bg-light border rounded-3">
    <div class="row align-items-center justify-content-between" id="info-bar">
      <div class="col">
        <ul class="list-inline" style="margin-bottom:0px;display:inline">

            <li class="list-inline-item" id="statements"><i class="fa fa-list-ol"></i>
              <a data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-html="true"
                 title=" 2.5% of total for procedures.">494 statements</a>
            </li>

            <li class="list-inline-item" id="source-file">
              <i class="fa fa-code"></i>
              <a href="../src/uEMEP_read_meteo_nc.f90"> Source File</a>
            </li>
        </ul>
      </div>
      <div class="col">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb justify-content-end mb-0">
                <li class="breadcrumb-item"><a href='../sourcefile/uemep_read_meteo_nc.f90.html'>uEMEP_read_meteo_nc.f90</a></li>
                <li class="breadcrumb-item"><a href='../module/read_meteo_nc.html'>read_meteo_nc</a></li>
            <li class="breadcrumb-item active" aria-current="page">uEMEP_read_meteo_nc</li>
          </ol>
        </nav>
      </div>
    </div>
  </div>
  <script>
    $(function () {
    $('[data-bs-toggle="tooltip"]').tooltip()
    })
  </script>

  </div>
  
  <div class="row">
    <div class="col-md-3 hidden-xs hidden-sm visible-md visible-lg">
      <div id="sidebar">
      <h3>Contents</h3>
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
    <div class="card card-primary">
      <div class="card-header text-left"><h3 class="card-title">Source Code</h3></div>
      <div class="list-group">
        <a class="list-group-item" href="../proc/uemep_read_meteo_nc.html#src">uEMEP_read_meteo_nc</a>
      </div>
    </div>


  </div>

    </div>
    
    <div class="col-md-9" id='text'>
    <h2>public  subroutine uEMEP_read_meteo_nc()  
</h2>
    



    <h3>Arguments</h3>
    <em>None</em>
    <br>
    <br>


    
    

    
    



    
    <section>
    <h2><span class="anchor" id="src"></span>Source Code</h2>
    <div class="hl codehilite"><pre><span></span><span class="w">    </span><span class="k">subroutine </span><span class="n">uEMEP_read_meteo_nc</span>

<span class="w">        </span><span class="k">implicit none</span>

<span class="k">        </span><span class="kt">integer </span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">t</span>
<span class="w">        </span><span class="kt">integer </span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span>
<span class="w">        </span><span class="kt">logical </span><span class="n">exists</span>
<span class="w">        </span><span class="kt">integer </span><span class="n">status_nc</span><span class="w">     </span><span class="c">!Error message</span>
<span class="w">        </span><span class="kt">integer </span><span class="n">id_nc</span>
<span class="w">        </span><span class="kt">integer </span><span class="n">dim_id_nc</span><span class="p">(</span><span class="n">num_dims_meteo_nc</span><span class="p">)</span>
<span class="w">        </span><span class="kt">character</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span><span class="w"> </span><span class="n">dimname_temp</span><span class="p">,</span><span class="n">var_name_nc_temp</span><span class="p">,</span><span class="n">unit_name_nc_temp</span>
<span class="w">        </span><span class="kt">integer </span><span class="n">var_id_nc</span>
<span class="w">        </span><span class="kt">integer </span><span class="n">i_file</span><span class="p">,</span><span class="n">i_dim</span>
<span class="w">        </span><span class="kt">integer </span><span class="n">temp_num_dims</span>
<span class="w">        </span><span class="kt">integer </span><span class="n">temp_start_time_meteo_nc_index</span><span class="p">,</span><span class="n">temp_end_time_meteo_nc_index</span>
<span class="w">        </span><span class="kt">integer </span><span class="n">valid_dim_length_meteo_nc</span><span class="p">(</span><span class="n">num_dims_meteo_nc</span><span class="p">)</span><span class="w"> </span><span class="c">!dimensions of file 3</span>

<span class="w">        </span><span class="kt">real </span><span class="n">temp_lat</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="n">temp_lon</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="w">        </span><span class="kt">real </span><span class="n">temp_y</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="n">temp_x</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="w">        </span><span class="kt">real </span><span class="n">temp_x_min</span><span class="p">,</span><span class="n">temp_x_max</span><span class="p">,</span><span class="n">temp_y_min</span><span class="p">,</span><span class="n">temp_y_max</span>
<span class="w">        </span><span class="kt">integer </span><span class="n">i_temp_min</span><span class="p">,</span><span class="n">i_temp_max</span><span class="p">,</span><span class="n">j_temp_min</span><span class="p">,</span><span class="n">j_temp_max</span>
<span class="w">        </span><span class="kt">double precision </span><span class="n">temp_var1d_nc_dp</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="w">        </span><span class="kt">real </span><span class="n">temp_delta</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="w">        </span><span class="kt">real </span><span class="n">scale_grid_interpolation_size</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="w">        </span><span class="kt">real </span><span class="n">EMEP_temp_delta</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="w">        </span><span class="kt">real </span><span class="n">temp_lat_mean</span>

<span class="w">        </span><span class="kt">integer </span><span class="n">n_file</span><span class="p">,</span><span class="n">n_file_start</span>
<span class="w">        </span><span class="kt">double precision </span><span class="n">date_num_temp</span>
<span class="w">        </span><span class="kt">integer </span><span class="n">date_array</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<span class="w">        </span><span class="kt">double precision </span><span class="n">scale_factor_nc</span>

<span class="w">        </span><span class="kt">logical </span><span class="n">found_file</span>
<span class="w">        </span><span class="kt">integer</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">search_hour_step</span><span class="o">=</span><span class="mi">6</span>
<span class="w">        </span><span class="kt">integer </span><span class="n">new_start_date_input</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
<span class="w">        </span><span class="kt">character</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span><span class="w"> </span><span class="n">format_temp</span>

<span class="w">        </span><span class="kt">real </span><span class="n">EMEP_grid_interpolation_size_temp</span>

<span class="w">        </span><span class="c">!Temporary reading rvariables</span>
<span class="w">        </span><span class="kt">double precision</span><span class="p">,</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">var1d_nc_dp</span><span class="p">(:)</span>
<span class="w">        </span><span class="kt">double precision</span><span class="p">,</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">var2d_nc_dp</span><span class="p">(:,:)</span>

<span class="w">        </span><span class="c">!Temporary files for roatating wind field</span>
<span class="w">        </span><span class="kt">real</span><span class="p">,</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">temp_meteo_var3d_nc</span><span class="p">(:,:,:,:)</span>

<span class="w">        </span><span class="c">!Daily mean temperature variables</span>
<span class="w">        </span><span class="kt">integer </span><span class="n">DMT_start_time_nc_index</span><span class="p">,</span><span class="n">DMT_end_time_nc_index</span><span class="p">,</span><span class="n">DMT_dim_length_nc</span>


<span class="w">        </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;&#39;</span>
<span class="w">        </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;================================================================&#39;</span>
<span class="w">        </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Reading additional meteo data (uEMEP_read_meteo_nc)&#39;</span>
<span class="w">        </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;================================================================&#39;</span>


<span class="w">        </span><span class="c">!This if statement is already specified in uEMEP_define_subgrid and is not necessary here</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hourly_calculations</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            </span><span class="n">temp_start_time_meteo_nc_index</span><span class="o">=</span><span class="n">start_time_meteo_nc_index</span>
<span class="w">            </span><span class="n">temp_end_time_meteo_nc_index</span><span class="o">=</span><span class="n">end_time_meteo_nc_index</span>
<span class="w">        </span><span class="k">else</span>
<span class="k">            </span><span class="n">temp_start_time_meteo_nc_index</span><span class="o">=</span><span class="mi">1</span>
<span class="w">            </span><span class="n">temp_end_time_meteo_nc_index</span><span class="o">=</span><span class="mi">1</span>
<span class="w">        </span><span class="k">endif</span>

<span class="k">        if</span><span class="w"> </span><span class="p">(</span><span class="n">use_single_time_loop_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            </span><span class="n">temp_start_time_meteo_nc_index</span><span class="o">=</span><span class="n">start_time_meteo_nc_index</span><span class="o">+</span><span class="n">t_loop</span><span class="o">-</span><span class="mi">1</span>
<span class="w">            </span><span class="n">temp_end_time_meteo_nc_index</span><span class="o">=</span><span class="n">temp_start_time_meteo_nc_index</span>
<span class="w">        </span><span class="k">endif</span>

<span class="w">        </span><span class="c">!Presettng the surface level to 1. Valid when there is no inverting of layers</span>
<span class="w">        </span><span class="n">surface_level_nc</span><span class="o">=</span><span class="mi">1</span>
<span class="w">        </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A,I)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39; Surface level base set to: &#39;</span><span class="p">,</span><span class="n">surface_level_nc</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">val_dim_meteo_nc</span><span class="p">))</span><span class="w"> </span><span class="k">deallocate</span><span class="w"> </span><span class="p">(</span><span class="n">val_dim_meteo_nc</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">var1d_nc_dp</span><span class="p">))</span><span class="w"> </span><span class="k">deallocate</span><span class="w"> </span><span class="p">(</span><span class="n">var1d_nc_dp</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">var2d_nc_dp</span><span class="p">))</span><span class="w"> </span><span class="k">deallocate</span><span class="w"> </span><span class="p">(</span><span class="n">var2d_nc_dp</span><span class="p">)</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">meteo_var1d_nc</span><span class="p">))</span><span class="w"> </span><span class="k">deallocate</span><span class="w"> </span><span class="p">(</span><span class="n">meteo_var1d_nc</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">meteo_var2d_nc</span><span class="p">))</span><span class="w"> </span><span class="k">deallocate</span><span class="w"> </span><span class="p">(</span><span class="n">meteo_var2d_nc</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">meteo_var3d_nc</span><span class="p">))</span><span class="w"> </span><span class="k">deallocate</span><span class="w"> </span><span class="p">(</span><span class="n">meteo_var3d_nc</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">meteo_var4d_nc</span><span class="p">))</span><span class="w"> </span><span class="k">deallocate</span><span class="w"> </span><span class="p">(</span><span class="n">meteo_var4d_nc</span><span class="p">)</span>

<span class="w">        </span><span class="c">!Loop through the meteorological files containing the data</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">use_alternative_meteorology_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            </span><span class="n">n_file_start</span><span class="o">=</span><span class="mi">3</span>
<span class="w">            </span><span class="n">n_file</span><span class="o">=</span><span class="mi">3</span>
<span class="w">        </span><span class="k">endif</span>
<span class="k">        if</span><span class="w"> </span><span class="p">(</span><span class="n">use_alternative_z0_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            </span><span class="n">n_file_start</span><span class="o">=</span><span class="mi">4</span>
<span class="w">            </span><span class="n">n_file</span><span class="o">=</span><span class="mi">4</span>
<span class="w">        </span><span class="k">endif</span>
<span class="k">        if</span><span class="w"> </span><span class="p">(</span><span class="n">use_alternative_meteorology_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">use_alternative_z0_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            </span><span class="n">n_file_start</span><span class="o">=</span><span class="mi">3</span>
<span class="w">            </span><span class="n">n_file</span><span class="o">=</span><span class="mi">4</span>
<span class="w">        </span><span class="k">endif</span>

<span class="k">        do </span><span class="n">i_file</span><span class="o">=</span><span class="n">n_file_start</span><span class="p">,</span><span class="n">n_file</span>

<span class="w">            </span><span class="c">!Set the filename</span>
<span class="w">            </span><span class="n">pathfilename_EMEP</span><span class="p">(</span><span class="n">i_file</span><span class="p">)</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">pathname_EMEP</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_EMEP</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span>

<span class="w">            </span><span class="c">!Test existence of the filename 4. If does not exist then stop</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i_file</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                inquire</span><span class="p">(</span><span class="k">file</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">pathfilename_EMEP</span><span class="p">(</span><span class="n">i_file</span><span class="p">)),</span><span class="n">exist</span><span class="o">=</span><span class="n">exists</span><span class="p">)</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="n">exists</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A,A)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39; ERROR: Netcdf file does not exist: &#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">pathfilename_EMEP</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span>
<span class="w">                    </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;  STOPPING&#39;</span>
<span class="w">                    </span><span class="k">stop</span>
<span class="k">                endif</span>
<span class="k">            endif</span>

<span class="w">            </span><span class="c">!Test existence of the filename. If does not exist then try 6 hours before</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i_file</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>

<span class="k">                inquire</span><span class="p">(</span><span class="k">file</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">pathfilename_EMEP</span><span class="p">(</span><span class="n">i_file</span><span class="p">)),</span><span class="n">exist</span><span class="o">=</span><span class="n">exists</span><span class="p">)</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="n">exists</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A,A)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39; WARNING: Meteo netcdf file does not exist: &#39;</span><span class="p">,</span><span class="w">  </span><span class="nb">trim</span><span class="p">(</span><span class="n">pathfilename_EMEP</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span>
<span class="w">                    </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39; Will try 6 hours before 4 times&#39;</span>

<span class="w">                    </span><span class="c">!Start search back 6 hours</span>
<span class="w">                    </span><span class="n">found_file</span><span class="o">=</span><span class="p">.</span><span class="n">false</span><span class="p">.</span>
<span class="w">                    </span><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hourly_calculations</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                            </span><span class="n">temp_start_time_meteo_nc_index</span><span class="o">=</span><span class="n">start_time_meteo_nc_index</span><span class="o">+</span><span class="n">search_hour_step</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="w">                            </span><span class="n">temp_end_time_meteo_nc_index</span><span class="o">=</span><span class="n">end_time_meteo_nc_index</span><span class="o">+</span><span class="n">search_hour_step</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="w">                        </span><span class="k">endif</span>
<span class="k">                        if</span><span class="w"> </span><span class="p">(</span><span class="n">use_single_time_loop_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                            </span><span class="n">temp_start_time_meteo_nc_index</span><span class="o">=</span><span class="n">start_time_meteo_nc_index</span><span class="o">+</span><span class="n">t_loop</span><span class="o">-</span><span class="mi">1</span><span class="o">+</span><span class="n">search_hour_step</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="w">                            </span><span class="n">temp_end_time_meteo_nc_index</span><span class="o">=</span><span class="n">temp_start_time_meteo_nc_index</span><span class="o">+</span><span class="n">search_hour_step</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="w">                        </span><span class="k">endif</span>
<span class="w">                        </span><span class="c">!Create new date_str</span>
<span class="w">                        </span><span class="n">format_temp</span><span class="o">=</span><span class="s1">&#39;yyyymmddHH&#39;</span>
<span class="w">                        </span><span class="k">call </span><span class="n">datestr_to_date</span><span class="p">(</span><span class="n">config_date_str</span><span class="p">,</span><span class="n">format_temp</span><span class="p">,</span><span class="n">new_start_date_input</span><span class="p">)</span>
<span class="w">                        </span><span class="n">date_num_temp</span><span class="o">=</span><span class="n">date_to_number</span><span class="p">(</span><span class="n">new_start_date_input</span><span class="p">,</span><span class="n">ref_year_meteo</span><span class="p">)</span>
<span class="w">                        </span><span class="k">call </span><span class="n">number_to_date</span><span class="p">(</span><span class="n">date_num_temp</span><span class="o">-</span><span class="nb">dble</span><span class="p">(</span><span class="n">search_hour_step</span><span class="o">*</span><span class="n">i</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)</span><span class="o">/</span><span class="nb">dble</span><span class="p">(</span><span class="mi">2</span><span class="mf">4.</span><span class="p">),</span><span class="n">new_start_date_input</span><span class="p">,</span><span class="n">ref_year_meteo</span><span class="p">)</span>
<span class="w">                        </span><span class="c">!Replace replacement_date_str with &lt;yyyyhhmm&gt; so the new_start_date_input can be inserted</span>
<span class="w">                        </span><span class="n">format_temp</span><span class="o">=</span><span class="s1">&#39;&lt;yyyymmdd&gt;&#39;</span>
<span class="w">                        </span><span class="n">filename_EMEP</span><span class="p">(</span><span class="n">i_file</span><span class="p">)</span><span class="o">=</span><span class="n">replace_string_char</span><span class="p">(</span><span class="n">format_temp</span><span class="p">,</span><span class="n">replacement_date_str</span><span class="p">,</span><span class="n">original_filename_EMEP</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span>
<span class="w">                        </span><span class="n">pathname_EMEP</span><span class="p">(</span><span class="n">i_file</span><span class="p">)</span><span class="o">=</span><span class="n">replace_string_char</span><span class="p">(</span><span class="n">format_temp</span><span class="p">,</span><span class="n">replacement_date_str</span><span class="p">,</span><span class="n">original_pathname_EMEP</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span>
<span class="w">                        </span><span class="c">!write(*,*) trim(filename_EMEP(i_file)),&#39;  &#39;,trim(replacement_date_str)</span>
<span class="w">                        </span><span class="c">!Replace replacement_hour_str with &lt;HH&gt; so the forecast hour can be inserted</span>
<span class="w">                        </span><span class="n">format_temp</span><span class="o">=</span><span class="s1">&#39;&lt;HH&gt;&#39;</span>
<span class="w">                        </span><span class="n">filename_EMEP</span><span class="p">(</span><span class="n">i_file</span><span class="p">)</span><span class="o">=</span><span class="n">replace_string_char</span><span class="p">(</span><span class="n">format_temp</span><span class="p">,</span><span class="n">replacement_hour_str</span><span class="p">,</span><span class="n">filename_EMEP</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span>
<span class="w">                        </span><span class="n">pathname_EMEP</span><span class="p">(</span><span class="n">i_file</span><span class="p">)</span><span class="o">=</span><span class="n">replace_string_char</span><span class="p">(</span><span class="n">format_temp</span><span class="p">,</span><span class="n">replacement_hour_str</span><span class="p">,</span><span class="n">pathname_EMEP</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span>
<span class="w">                        </span><span class="c">!write(*,*) trim(filename_EMEP(i_file)),&#39;  &#39;,trim(forecast_hour_str)</span>
<span class="w">                        </span><span class="c">!Replace datestr twice for both forecast_hour and config_date</span>
<span class="w">                        </span><span class="k">call </span><span class="n">date_to_datestr_bracket</span><span class="p">(</span><span class="n">new_start_date_input</span><span class="p">,</span><span class="n">filename_EMEP</span><span class="p">(</span><span class="n">i_file</span><span class="p">),</span><span class="n">filename_EMEP</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span>
<span class="w">                        </span><span class="k">call </span><span class="n">date_to_datestr_bracket</span><span class="p">(</span><span class="n">new_start_date_input</span><span class="p">,</span><span class="n">pathname_EMEP</span><span class="p">(</span><span class="n">i_file</span><span class="p">),</span><span class="n">pathname_EMEP</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span>
<span class="w">                        </span><span class="k">call </span><span class="n">date_to_datestr_bracket</span><span class="p">(</span><span class="n">new_start_date_input</span><span class="p">,</span><span class="n">filename_EMEP</span><span class="p">(</span><span class="n">i_file</span><span class="p">),</span><span class="n">filename_EMEP</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span>
<span class="w">                        </span><span class="k">call </span><span class="n">date_to_datestr_bracket</span><span class="p">(</span><span class="n">new_start_date_input</span><span class="p">,</span><span class="n">pathname_EMEP</span><span class="p">(</span><span class="n">i_file</span><span class="p">),</span><span class="n">pathname_EMEP</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span>
<span class="w">                        </span><span class="n">pathfilename_EMEP</span><span class="p">(</span><span class="n">i_file</span><span class="p">)</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">pathname_EMEP</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_EMEP</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span>
<span class="w">                        </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A,A)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39; Trying: &#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">pathfilename_EMEP</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span>
<span class="w">                        </span><span class="k">inquire</span><span class="p">(</span><span class="k">file</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">pathfilename_EMEP</span><span class="p">(</span><span class="n">i_file</span><span class="p">)),</span><span class="n">exist</span><span class="o">=</span><span class="n">exists</span><span class="p">)</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">exists</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                            </span><span class="n">found_file</span><span class="o">=</span><span class="p">.</span><span class="n">true</span><span class="p">.</span>
<span class="w">                            </span><span class="k">exit</span>
<span class="k">                        else</span>
<span class="k">                            </span><span class="n">found_file</span><span class="o">=</span><span class="p">.</span><span class="n">false</span><span class="p">.</span>
<span class="w">                        </span><span class="k">endif</span>
<span class="k">                    enddo</span>

<span class="k">                    if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="n">found_file</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                        write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A,A)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39; ERROR: Meteo netcdf file still does not exist: &#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">pathfilename_EMEP</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span>
<span class="w">                        </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39; STOPPING&#39;</span>
<span class="w">                        </span><span class="k">stop</span>
<span class="k">                    else</span>
<span class="k">                        write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A,A)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39; Found earlier meteo netcdf file: &#39;</span><span class="p">,</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">pathfilename_EMEP</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span>
<span class="w">                        </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A,2i6)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39; New start and end index: &#39;</span><span class="p">,</span><span class="w"> </span><span class="n">temp_start_time_meteo_nc_index</span><span class="p">,</span><span class="n">temp_end_time_meteo_nc_index</span>
<span class="w">                    </span><span class="k">endif</span>

<span class="k">                endif</span>

<span class="k">            endif</span>

<span class="w">            </span><span class="c">!Open the netcdf file for reading</span>
<span class="w">            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(2A)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39; Opening netcdf file: &#39;</span><span class="p">,</span><span class="nb">trim</span><span class="p">(</span><span class="n">pathfilename_EMEP</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span>
<span class="w">            </span><span class="n">status_nc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_OPEN</span><span class="w"> </span><span class="p">(</span><span class="n">pathfilename_EMEP</span><span class="p">(</span><span class="n">i_file</span><span class="p">),</span><span class="w"> </span><span class="n">nf90_nowrite</span><span class="p">,</span><span class="w"> </span><span class="n">id_nc</span><span class="p">)</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">status_nc</span><span class="w"> </span><span class="p">.</span><span class="n">NE</span><span class="p">.</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A,I)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;ERROR opening netcdf file. Stopping: &#39;</span><span class="p">,</span><span class="n">status_nc</span>
<span class="w">                </span><span class="k">stop</span>
<span class="k">            endif</span>

<span class="k">            </span><span class="n">meteo_nc_projection_type</span><span class="o">=</span><span class="n">LL_projection_index</span>

<span class="w">            </span><span class="c">!Find the projection. If no projection then in lat lon coordinates</span>
<span class="w">            </span><span class="n">status_nc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_INQ_VARID</span><span class="w"> </span><span class="p">(</span><span class="n">id_nc</span><span class="p">,</span><span class="s1">&#39;projection_lambert&#39;</span><span class="p">,</span><span class="n">var_id_nc</span><span class="p">)</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">status_nc</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">                </span><span class="c">!If there is a projection then read in the attributes. All these are doubles</span>
<span class="w">                </span><span class="c">!status_nc = nf90_inquire_variable(id_nc, var_id_nc, natts = numAtts_projection)</span>
<span class="w">                </span><span class="n">status_nc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nf90_get_att</span><span class="p">(</span><span class="n">id_nc</span><span class="p">,</span><span class="w"> </span><span class="n">var_id_nc</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;standard_parallel&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">meteo_nc_projection_attributes</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">))</span>
<span class="w">                </span><span class="n">status_nc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nf90_get_att</span><span class="p">(</span><span class="n">id_nc</span><span class="p">,</span><span class="w"> </span><span class="n">var_id_nc</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;longitude_of_central_meridian&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">meteo_nc_projection_attributes</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
<span class="w">                </span><span class="n">status_nc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nf90_get_att</span><span class="p">(</span><span class="n">id_nc</span><span class="p">,</span><span class="w"> </span><span class="n">var_id_nc</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;latitude_of_projection_origin&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">meteo_nc_projection_attributes</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
<span class="w">                </span><span class="n">status_nc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nf90_get_att</span><span class="p">(</span><span class="n">id_nc</span><span class="p">,</span><span class="w"> </span><span class="n">var_id_nc</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;earth_radius&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">meteo_nc_projection_attributes</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
<span class="w">                </span><span class="n">meteo_nc_projection_type</span><span class="o">=</span><span class="n">LCC_projection_index</span>

<span class="w">                </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A,5f12.2)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Reading lambert_conformal_conic projection. &#39;</span><span class="p">,</span><span class="n">meteo_nc_projection_attributes</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">meteo_nc_projection_attributes</span><span class="p">(</span><span class="mi">1</span><span class="p">).</span><span class="n">ne</span><span class="p">.</span><span class="n">meteo_nc_projection_attributes</span><span class="p">(</span><span class="mi">4</span><span class="p">).</span><span class="nb">or</span><span class="p">.</span><span class="n">meteo_nc_projection_attributes</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="n">ne</span><span class="p">.</span><span class="n">meteo_nc_projection_attributes</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    </span><span class="n">use_alternative_LCC_projection_flag</span><span class="o">=</span><span class="p">.</span><span class="n">true</span><span class="p">.</span>
<span class="w">                    </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A,l)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Using alternative lambert_conformal_conic projection: &#39;</span><span class="p">,</span><span class="n">use_alternative_LCC_projection_flag</span>
<span class="w">                </span><span class="k">else</span>
<span class="k">                    </span><span class="n">use_alternative_LCC_projection_flag</span><span class="o">=</span><span class="p">.</span><span class="n">false</span><span class="p">.</span>
<span class="w">                </span><span class="k">endif</span>
<span class="w">                </span><span class="c">!Always set to true. i.e. not use anymore</span>
<span class="w">                </span><span class="n">use_alternative_LCC_projection_flag</span><span class="o">=</span><span class="p">.</span><span class="n">true</span><span class="p">.</span>
<span class="w">            </span><span class="k">endif</span>

<span class="w">            </span><span class="c">!Find the projection. If no projection then in lat lon coordinates</span>
<span class="w">            </span><span class="n">status_nc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_INQ_VARID</span><span class="w"> </span><span class="p">(</span><span class="n">id_nc</span><span class="p">,</span><span class="s1">&#39;Polar_Stereographic&#39;</span><span class="p">,</span><span class="n">var_id_nc</span><span class="p">)</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">status_nc</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>

<span class="k">                </span><span class="n">EMEP_projection_attributes</span><span class="o">=</span><span class="mf">0.</span>
<span class="w">                </span><span class="n">EMEP_projection_attributes</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">=</span><span class="mf">6.370e6</span>
<span class="w">                </span><span class="n">status_nc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nf90_get_att</span><span class="p">(</span><span class="n">id_nc</span><span class="p">,</span><span class="w"> </span><span class="n">var_id_nc</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;straight_vertical_longitude_from_pole&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">meteo_nc_projection_attributes</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="w">                </span><span class="n">status_nc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nf90_get_att</span><span class="p">(</span><span class="n">id_nc</span><span class="p">,</span><span class="w"> </span><span class="n">var_id_nc</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;latitude_of_projection_origin&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">meteo_nc_projection_attributes</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
<span class="w">                </span><span class="n">status_nc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nf90_get_att</span><span class="p">(</span><span class="n">id_nc</span><span class="p">,</span><span class="w"> </span><span class="n">var_id_nc</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;false_easting&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">meteo_nc_projection_attributes</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
<span class="w">                </span><span class="n">status_nc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nf90_get_att</span><span class="p">(</span><span class="n">id_nc</span><span class="p">,</span><span class="w"> </span><span class="n">var_id_nc</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;false_northing&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">meteo_nc_projection_attributes</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
<span class="w">                </span><span class="n">status_nc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nf90_get_att</span><span class="p">(</span><span class="n">id_nc</span><span class="p">,</span><span class="w"> </span><span class="n">var_id_nc</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;earth_radius&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">meteo_nc_projection_attributes</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
<span class="w">                </span><span class="n">status_nc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nf90_get_att</span><span class="p">(</span><span class="n">id_nc</span><span class="p">,</span><span class="w"> </span><span class="n">var_id_nc</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;scale_factor_at_projection_origin&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">meteo_nc_projection_attributes</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>

<span class="w">                </span><span class="n">meteo_nc_projection_type</span><span class="o">=</span><span class="n">PS_projection_index</span>

<span class="w">                </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A,5f12.2)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Reading Polar_Stereographic projection. &#39;</span><span class="p">,</span><span class="n">meteo_nc_projection_attributes</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span>

<span class="w">            </span><span class="k">endif</span>

<span class="w">            </span><span class="c">!Find the (x,y,z,time) dimensions of the file</span>
<span class="w">            </span><span class="k">do </span><span class="n">i_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">num_dims_meteo_nc</span>
<span class="w">                </span><span class="n">status_nc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_INQ_DIMID</span><span class="w"> </span><span class="p">(</span><span class="n">id_nc</span><span class="p">,</span><span class="n">dim_name_meteo_nc</span><span class="p">(</span><span class="n">i_dim</span><span class="p">),</span><span class="n">dim_id_nc</span><span class="p">(</span><span class="n">i_dim</span><span class="p">))</span>
<span class="w">                </span><span class="n">status_nc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_INQUIRE_DIMENSION</span><span class="w"> </span><span class="p">(</span><span class="n">id_nc</span><span class="p">,</span><span class="n">dim_id_nc</span><span class="p">(</span><span class="n">i_dim</span><span class="p">),</span><span class="n">dimname_temp</span><span class="p">,</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">i_dim</span><span class="p">))</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">status_nc</span><span class="w"> </span><span class="p">.</span><span class="n">NE</span><span class="p">.</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A,A,A,I)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;No dimension information available for &#39;</span><span class="p">,</span><span class="nb">trim</span><span class="p">(</span><span class="n">dim_name_meteo_nc</span><span class="p">(</span><span class="n">i_dim</span><span class="p">)),</span><span class="s1">&#39; Setting to 1 with status: &#39;</span><span class="p">,</span><span class="n">status_nc</span>
<span class="w">                    </span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">i_dim</span><span class="p">)</span><span class="o">=</span><span class="mi">1</span>
<span class="w">                </span><span class="k">endif</span>
<span class="k">            enddo</span>

<span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">i_file</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                </span><span class="n">valid_dim_length_meteo_nc</span><span class="o">=</span><span class="n">dim_length_meteo_nc</span>
<span class="w">            </span><span class="k">endif</span>

<span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">i_file</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                if</span><span class="w"> </span><span class="p">(</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">).</span><span class="n">gt</span><span class="p">.</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">time_dim_nc_index</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A,2I)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;ERROR: Specified time dimensions are greater than meteo netcdf dimensions. Stopping &#39;</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">),</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">time_dim_nc_index</span><span class="p">)</span>
<span class="w">                    </span><span class="k">stop</span>
<span class="k">                endif</span>
<span class="k">                if</span><span class="w"> </span><span class="p">(</span><span class="n">temp_end_time_meteo_nc_index</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">time_dim_nc_index</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A,2I)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;ERROR: Required meteo time dimension larger than available meteo time dimension. Stopping &#39;</span><span class="p">,</span><span class="n">temp_end_time_meteo_nc_index</span><span class="p">,</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">time_dim_nc_index</span><span class="p">)</span>
<span class="w">                    </span><span class="k">stop</span>
<span class="k">                endif</span>
<span class="k">            endif</span>


<span class="k">            write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A,6I)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39; Size of meteo dimensions (x,y,z,t): &#39;</span><span class="p">,</span><span class="n">dim_length_meteo_nc</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i_file</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                </span><span class="n">dim_start_meteo_nc</span><span class="p">(</span><span class="n">time_dim_nc_index</span><span class="p">)</span><span class="o">=</span><span class="n">temp_start_time_meteo_nc_index</span>
<span class="w">                </span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">time_dim_nc_index</span><span class="p">)</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">time_dim_nc_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">))</span>
<span class="w">            </span><span class="k">elseif</span><span class="w"> </span><span class="p">(</span><span class="n">i_file</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                </span><span class="n">dim_start_meteo_nc</span><span class="p">(</span><span class="n">time_dim_nc_index</span><span class="p">)</span><span class="o">=</span><span class="mi">1</span>
<span class="w">                </span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">time_dim_nc_index</span><span class="p">)</span><span class="o">=</span><span class="mi">1</span>
<span class="w">            </span><span class="k">endif</span>

<span class="k">            write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A,6I)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39; New size of meteo dimensions (x,y,z,t): &#39;</span><span class="p">,</span><span class="n">dim_length_meteo_nc</span>


<span class="w">            </span><span class="c">!Calculate the necessary extent of the meteo_nc grid region and only read these grids</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">reduce_EMEP_region_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">                </span><span class="c">!Determine the LL cordinates of the target grid</span>
<span class="w">                </span><span class="c">!EMEP_grid_interpolation_size_temp=max(EMEP_grid_interpolation_size*local_fraction_grid_size_scaling,EMEP_additional_grid_interpolation_size_original*local_fraction_grid_size_scaling)</span>
<span class="w">                </span><span class="n">EMEP_grid_interpolation_size_temp</span><span class="o">=</span><span class="n">EMEP_grid_interpolation_size</span><span class="o">*</span><span class="n">local_fraction_grid_size_scaling</span>

<span class="w">                </span><span class="c">!Retrieve the four corners of the target grid in lat and lon</span>
<span class="w">                </span><span class="k">call </span><span class="n">PROJ2LL</span><span class="p">(</span><span class="n">init_subgrid_min</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">init_subgrid_min</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">temp_lon</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">temp_lat</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">projection_attributes</span><span class="p">,</span><span class="n">projection_type</span><span class="p">)</span>
<span class="w">                </span><span class="k">call </span><span class="n">PROJ2LL</span><span class="p">(</span><span class="n">init_subgrid_max</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">init_subgrid_max</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">temp_lon</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">temp_lat</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">projection_attributes</span><span class="p">,</span><span class="n">projection_type</span><span class="p">)</span>
<span class="w">                </span><span class="k">call </span><span class="n">PROJ2LL</span><span class="p">(</span><span class="n">init_subgrid_min</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">init_subgrid_max</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">temp_lon</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="n">temp_lat</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="n">projection_attributes</span><span class="p">,</span><span class="n">projection_type</span><span class="p">)</span>
<span class="w">                </span><span class="k">call </span><span class="n">PROJ2LL</span><span class="p">(</span><span class="n">init_subgrid_max</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">init_subgrid_min</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">temp_lon</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="n">temp_lat</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="n">projection_attributes</span><span class="p">,</span><span class="n">projection_type</span><span class="p">)</span>
<span class="w">                </span><span class="c">!call UTM2LL(utm_zone,init_subgrid_min(y_dim_index),init_subgrid_min(x_dim_index),temp_lat(1),temp_lon(1))</span>
<span class="w">                </span><span class="c">!call UTM2LL(utm_zone,init_subgrid_max(y_dim_index),init_subgrid_max(x_dim_index),temp_lat(2),temp_lon(2))</span>
<span class="w">                </span><span class="c">!call UTM2LL(utm_zone,init_subgrid_max(y_dim_index),init_subgrid_min(x_dim_index),temp_lat(3),temp_lon(3))</span>
<span class="w">                </span><span class="c">!call UTM2LL(utm_zone,init_subgrid_min(y_dim_index),init_subgrid_max(x_dim_index),temp_lat(4),temp_lon(4))</span>

<span class="w">                </span><span class="c">!Find the average for use later</span>
<span class="w">                </span><span class="n">temp_lat_mean</span><span class="o">=</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_lat</span><span class="p">)</span><span class="o">/</span><span class="mf">4.</span>

<span class="w">                </span><span class="n">temp_x_min</span><span class="o">=</span><span class="mf">1.e32</span><span class="p">;</span><span class="n">temp_y_min</span><span class="o">=</span><span class="mf">1.e32</span>
<span class="w">                </span><span class="n">temp_x_max</span><span class="o">=-</span><span class="mf">1.e32</span><span class="p">;</span><span class="n">temp_y_max</span><span class="o">=-</span><span class="mf">1.e32</span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">meteo_nc_projection_type</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">LCC_projection_index</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">                    </span><span class="c">!Convert lat lon corners to lambert</span>
<span class="w">                    </span><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span>
<span class="w">                        </span><span class="k">call </span><span class="n">lb2lambert2_uEMEP</span><span class="p">(</span><span class="n">temp_x</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">temp_y</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">temp_lon</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">temp_lat</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">meteo_nc_projection_attributes</span><span class="p">)</span>
<span class="w">                    </span><span class="k">enddo</span>
<span class="k">                elseif</span><span class="w"> </span><span class="p">(</span><span class="n">meteo_nc_projection_type</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">PS_projection_index</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">                    </span><span class="c">!Convert lat lon corners to lambert</span>
<span class="w">                    </span><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span>
<span class="w">                        </span><span class="k">call </span><span class="n">LL2PS_spherical</span><span class="p">(</span><span class="n">temp_x</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">temp_y</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">temp_lon</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">temp_lat</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">meteo_nc_projection_attributes</span><span class="p">)</span>
<span class="w">                    </span><span class="k">enddo</span>
<span class="k">                elseif</span><span class="w"> </span><span class="p">(</span><span class="n">meteo_nc_projection_type</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">LL_projection_index</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">                    </span><span class="c">!Set lat lon corners if EMEP is in lat lon</span>
<span class="w">                    </span><span class="n">temp_x</span><span class="o">=</span><span class="n">temp_lon</span><span class="p">;</span><span class="n">temp_y</span><span class="o">=</span><span class="n">temp_lat</span>
<span class="w">                </span><span class="k">else</span>
<span class="w">                    </span><span class="c">!Otherwise assume the same coordinate system</span>
<span class="w">                    </span><span class="n">temp_x</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">init_subgrid_min</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">);</span><span class="n">temp_y</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">init_subgrid_min</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">)</span>
<span class="w">                    </span><span class="n">temp_x</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="n">init_subgrid_max</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">);</span><span class="n">temp_y</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="n">init_subgrid_min</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">)</span>
<span class="w">                    </span><span class="n">temp_x</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span><span class="n">init_subgrid_min</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">);</span><span class="n">temp_y</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span><span class="n">init_subgrid_max</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">)</span>
<span class="w">                    </span><span class="n">temp_x</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">=</span><span class="n">init_subgrid_max</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">);</span><span class="n">temp_y</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">=</span><span class="n">init_subgrid_max</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">)</span>
<span class="w">                </span><span class="k">endif</span>

<span class="k">                do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">temp_x</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="n">lt</span><span class="p">.</span><span class="n">temp_x_min</span><span class="p">)</span><span class="w"> </span><span class="n">temp_x_min</span><span class="o">=</span><span class="n">temp_x</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">temp_y</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="n">lt</span><span class="p">.</span><span class="n">temp_y_min</span><span class="p">)</span><span class="w"> </span><span class="n">temp_y_min</span><span class="o">=</span><span class="n">temp_y</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">temp_x</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="n">gt</span><span class="p">.</span><span class="n">temp_x_max</span><span class="p">)</span><span class="w"> </span><span class="n">temp_x_max</span><span class="o">=</span><span class="n">temp_x</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">temp_y</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="n">gt</span><span class="p">.</span><span class="n">temp_y_max</span><span class="p">)</span><span class="w"> </span><span class="n">temp_y_max</span><span class="o">=</span><span class="n">temp_y</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="w">                </span><span class="k">enddo</span>

<span class="w">                </span><span class="c">!Read in the first 2 x and y position values from the nc file to get min values and delta values</span>
<span class="w">                </span><span class="c">!write(*,*) temp_x_min,temp_x_max,temp_y_min,temp_y_max</span>

<span class="w">                </span><span class="n">status_nc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_INQ_VARID</span><span class="w"> </span><span class="p">(</span><span class="n">id_nc</span><span class="p">,</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">dim_name_meteo_nc</span><span class="p">(</span><span class="n">x_dim_nc_index</span><span class="p">)),</span><span class="w"> </span><span class="n">var_id_nc</span><span class="p">)</span>
<span class="w">                </span><span class="n">status_nc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="w"> </span><span class="p">(</span><span class="n">id_nc</span><span class="p">,</span><span class="w"> </span><span class="n">var_id_nc</span><span class="p">,</span><span class="n">temp_var1d_nc_dp</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">),</span><span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="mi">1</span><span class="o">/</span><span class="p">),</span><span class="nb">count</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="p">))</span>
<span class="w">                </span><span class="n">status_nc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_INQ_VARID</span><span class="w"> </span><span class="p">(</span><span class="n">id_nc</span><span class="p">,</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">dim_name_meteo_nc</span><span class="p">(</span><span class="n">y_dim_nc_index</span><span class="p">)),</span><span class="w"> </span><span class="n">var_id_nc</span><span class="p">)</span>
<span class="w">                </span><span class="n">status_nc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="w"> </span><span class="p">(</span><span class="n">id_nc</span><span class="p">,</span><span class="w"> </span><span class="n">var_id_nc</span><span class="p">,</span><span class="n">temp_var1d_nc_dp</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">),</span><span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="mi">1</span><span class="o">/</span><span class="p">),</span><span class="nb">count</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="p">))</span>
<span class="w">                </span><span class="n">status_nc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nf90_get_att</span><span class="p">(</span><span class="n">id_nc</span><span class="p">,</span><span class="w"> </span><span class="n">var_id_nc</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;units&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">unit_name_nc_temp</span><span class="p">)</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">trim</span><span class="p">(</span><span class="n">unit_name_nc_temp</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="s1">&#39;km&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Units of x y data are in kilometres. Converting to metres&#39;</span>
<span class="w">                    </span><span class="n">temp_var1d_nc_dp</span><span class="o">=</span><span class="n">temp_var1d_nc_dp</span><span class="o">*</span><span class="mi">100</span><span class="mf">0.</span>
<span class="w">                </span><span class="k">endif</span>

<span class="w">                </span><span class="c">!HERE FIX. The EMEP_grid_interpolation_size is too small when using EMEP is a different grid to the meteo grid. Need to rescale this somehow</span>
<span class="w">                </span><span class="c">!By using meteo_dgrid_nc(lon_nc_index), not defined yet, and dgrid_nc(lon_nc_index)</span>
<span class="w">                </span><span class="c">!For example  dx_temp=111000.*dgrid_nc(lon_nc_index)*cos(lat_temp*pi/180.) and dy_temp=111000.*dgrid_nc(lat_nc_index)</span>

<span class="w">                </span><span class="c">!write(*,*) temp_var1d_nc_dp</span>
<span class="w">                </span><span class="n">temp_delta</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">temp_var1d_nc_dp</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">temp_var1d_nc_dp</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="w">                </span><span class="n">temp_delta</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="n">temp_var1d_nc_dp</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="n">temp_var1d_nc_dp</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="w">                </span><span class="c">!write(*,*) temp_delta</span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">meteo_nc_projection_type</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">LCC_projection_index</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">EMEP_projection_type</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">LCC_projection_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">.</span><span class="nb">or</span><span class="p">.(</span><span class="n">meteo_nc_projection_type</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">LL_projection_index</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">EMEP_projection_type</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">LL_projection_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">.</span><span class="nb">or</span><span class="p">.(</span><span class="n">meteo_nc_projection_type</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">PS_projection_index</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">EMEP_projection_type</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">PS_projection_index</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="w">                    </span><span class="c">!If both EMEP and meteo are in the same coordinates then set the EMEP size to be the same as the meteo siz</span>
<span class="w">                    </span><span class="n">EMEP_temp_delta</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">dgrid_nc</span><span class="p">(</span><span class="n">lon_nc_index</span><span class="p">)</span>
<span class="w">                    </span><span class="n">EMEP_temp_delta</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="n">dgrid_nc</span><span class="p">(</span><span class="n">lat_nc_index</span><span class="p">)</span>
<span class="w">                </span><span class="k">elseif</span><span class="w"> </span><span class="p">((</span><span class="n">meteo_nc_projection_type</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">LCC_projection_index</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">EMEP_projection_type</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">LL_projection_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">.</span><span class="nb">or</span><span class="p">.(</span><span class="n">meteo_nc_projection_type</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">PS_projection_index</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">EMEP_projection_type</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">LL_projection_index</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="w">                    </span><span class="c">!EMEP is in latlon, convert to local coordinates</span>
<span class="w">                    </span><span class="n">EMEP_temp_delta</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">dgrid_nc</span><span class="p">(</span><span class="n">lon_nc_index</span><span class="p">)</span><span class="o">*</span><span class="mi">11100</span><span class="mf">0.</span><span class="o">*</span><span class="nb">cos</span><span class="p">(</span><span class="n">temp_lat_mean</span><span class="o">*</span><span class="mf">3.14159</span><span class="o">/</span><span class="mi">18</span><span class="mf">0.</span><span class="p">)</span>
<span class="w">                    </span><span class="n">EMEP_temp_delta</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="n">dgrid_nc</span><span class="p">(</span><span class="n">lat_nc_index</span><span class="p">)</span><span class="o">*</span><span class="mi">11100</span><span class="mf">0.</span>
<span class="w">                </span><span class="k">elseif</span><span class="w"> </span><span class="p">((</span><span class="n">meteo_nc_projection_type</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">LL_projection_index</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">EMEP_projection_type</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">LCC_projection_index</span><span class="p">)&amp;</span>
<span class="w">                    </span><span class="p">.</span><span class="nb">or</span><span class="p">.(</span><span class="n">meteo_nc_projection_type</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">LL_projection_index</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">EMEP_projection_type</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">PS_projection_index</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="w">                    </span><span class="c">!This conversion not available</span>
<span class="w">                    </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A,3I)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Use of lat lon projection in meteo data, together with Lambert or PS in EMEP not available. Stopping&#39;</span>
<span class="w">                    </span><span class="k">stop</span>
<span class="k">                else</span>
<span class="k">                    write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A,3I)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Use of current projections in meteo and EMEP data not available. Stopping&#39;</span>
<span class="w">                    </span><span class="k">stop</span>
<span class="k">                endif</span>

<span class="k">                </span><span class="n">scale_grid_interpolation_size</span><span class="o">=</span><span class="n">EMEP_temp_delta</span><span class="o">/</span><span class="n">temp_delta</span>
<span class="w">                </span><span class="c">!write(*,*) dgrid_nc(lon_nc_index),dgrid_nc(lat_nc_index)</span>
<span class="w">                </span><span class="c">!write(*,*) EMEP_temp_delta</span>
<span class="w">                </span><span class="c">!write(*,*) scale_grid_interpolation_size</span>
<span class="w">                </span><span class="c">!stop</span>

<span class="w">                </span><span class="c">!Find grid position of the max and min coordinates and add2 grids*EMEP_grid_interpolation_size</span>
<span class="w">                </span><span class="n">i_temp_min</span><span class="o">=</span><span class="mi">1</span><span class="o">+</span><span class="nb">floor</span><span class="p">((</span><span class="n">temp_x_min</span><span class="o">-</span><span class="n">temp_var1d_nc_dp</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="n">temp_delta</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)</span>
<span class="w">                </span><span class="n">i_temp_max</span><span class="o">=</span><span class="mi">1</span><span class="o">+</span><span class="nb">floor</span><span class="p">((</span><span class="n">temp_x_max</span><span class="o">-</span><span class="n">temp_var1d_nc_dp</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="n">temp_delta</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)</span>
<span class="w">                </span><span class="n">j_temp_min</span><span class="o">=</span><span class="mi">1</span><span class="o">+</span><span class="nb">floor</span><span class="p">((</span><span class="n">temp_y_min</span><span class="o">-</span><span class="n">temp_var1d_nc_dp</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="n">temp_delta</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)</span>
<span class="w">                </span><span class="n">j_temp_max</span><span class="o">=</span><span class="mi">1</span><span class="o">+</span><span class="nb">floor</span><span class="p">((</span><span class="n">temp_y_max</span><span class="o">-</span><span class="n">temp_var1d_nc_dp</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">/</span><span class="n">temp_delta</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)</span>
<span class="w">                </span><span class="c">!write(unit_logfile,&#39;(A,2I)&#39;) &#39; Reading EMEP i grids: &#39;,i_temp_min,i_temp_max</span>
<span class="w">                </span><span class="c">!write(unit_logfile,&#39;(A,2I)&#39;) &#39; Reading EMEP j grids: &#39;,j_temp_min,j_temp_max</span>
<span class="w">                </span><span class="n">i_temp_min</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">i_temp_min</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="nb">ceiling</span><span class="p">(</span><span class="n">scale_grid_interpolation_size</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">EMEP_grid_interpolation_size_temp</span><span class="p">))</span>
<span class="w">                </span><span class="n">i_temp_max</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">x_dim_nc_index</span><span class="p">),</span><span class="n">i_temp_max</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="nb">ceiling</span><span class="p">(</span><span class="n">scale_grid_interpolation_size</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">EMEP_grid_interpolation_size_temp</span><span class="p">))</span>
<span class="w">                </span><span class="n">j_temp_min</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">j_temp_min</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="nb">ceiling</span><span class="p">(</span><span class="n">scale_grid_interpolation_size</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">EMEP_grid_interpolation_size_temp</span><span class="p">))</span>
<span class="w">                </span><span class="n">j_temp_max</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">y_dim_nc_index</span><span class="p">),</span><span class="n">j_temp_max</span><span class="o">+</span><span class="mi">1</span><span class="o">+</span><span class="nb">ceiling</span><span class="p">(</span><span class="n">scale_grid_interpolation_size</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">EMEP_grid_interpolation_size_temp</span><span class="p">))</span>
<span class="w">                </span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">x_dim_nc_index</span><span class="p">)</span><span class="o">=</span><span class="n">i_temp_max</span><span class="o">-</span><span class="n">i_temp_min</span><span class="o">+</span><span class="mi">1</span>
<span class="w">                </span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">y_dim_nc_index</span><span class="p">)</span><span class="o">=</span><span class="n">j_temp_max</span><span class="o">-</span><span class="n">j_temp_min</span><span class="o">+</span><span class="mi">1</span>
<span class="w">                </span><span class="n">dim_start_meteo_nc</span><span class="p">(</span><span class="n">x_dim_nc_index</span><span class="p">)</span><span class="o">=</span><span class="n">i_temp_min</span>
<span class="w">                </span><span class="n">dim_start_meteo_nc</span><span class="p">(</span><span class="n">y_dim_nc_index</span><span class="p">)</span><span class="o">=</span><span class="n">j_temp_min</span>
<span class="w">                </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A,3I)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39; Reading meteo x grids: &#39;</span><span class="p">,</span><span class="n">i_temp_min</span><span class="p">,</span><span class="n">i_temp_max</span><span class="p">,</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">x_dim_nc_index</span><span class="p">)</span>
<span class="w">                </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A,3I)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39; Reading meteo y grids: &#39;</span><span class="p">,</span><span class="n">j_temp_min</span><span class="p">,</span><span class="n">j_temp_max</span><span class="p">,</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">y_dim_nc_index</span><span class="p">)</span>

<span class="w">                </span><span class="c">!Set the new valid meteo dimensions</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i_file</span><span class="p">.</span><span class="n">ge</span><span class="p">.</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    </span><span class="n">valid_dim_length_meteo_nc</span><span class="p">(</span><span class="n">x_dim_nc_index</span><span class="p">)</span><span class="o">=</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">x_dim_nc_index</span><span class="p">)</span>
<span class="w">                    </span><span class="n">valid_dim_length_meteo_nc</span><span class="p">(</span><span class="n">y_dim_nc_index</span><span class="p">)</span><span class="o">=</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">y_dim_nc_index</span><span class="p">)</span>
<span class="w">                </span><span class="k">endif</span>

<span class="k">            endif</span>

<span class="w">            </span><span class="c">!Allocate the nc arrays for reading</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="nb">allocated</span><span class="p">(</span><span class="n">val_dim_meteo_nc</span><span class="p">))</span><span class="w"> </span><span class="k">allocate</span><span class="w"> </span><span class="p">(</span><span class="n">val_dim_meteo_nc</span><span class="p">(</span><span class="nb">maxval</span><span class="p">(</span><span class="n">dim_length_meteo_nc</span><span class="p">),</span><span class="n">num_dims_meteo_nc</span><span class="p">))</span><span class="w"> </span><span class="c">!x, y, z and time dimension values</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="nb">allocated</span><span class="p">(</span><span class="n">unit_dim_meteo_nc</span><span class="p">))</span><span class="w"> </span><span class="k">allocate</span><span class="w"> </span><span class="p">(</span><span class="n">unit_dim_meteo_nc</span><span class="p">(</span><span class="n">num_dims_meteo_nc</span><span class="p">))</span><span class="w"> </span><span class="c">!x, y, z and time dimension values</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="nb">allocated</span><span class="p">(</span><span class="n">var1d_nc_dp</span><span class="p">))</span><span class="w"> </span><span class="k">allocate</span><span class="w"> </span><span class="p">(</span><span class="n">var1d_nc_dp</span><span class="p">(</span><span class="nb">maxval</span><span class="p">(</span><span class="n">dim_length_meteo_nc</span><span class="p">)))</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="nb">allocated</span><span class="p">(</span><span class="n">var2d_nc_dp</span><span class="p">))</span><span class="w"> </span><span class="k">allocate</span><span class="w"> </span><span class="p">(</span><span class="n">var2d_nc_dp</span><span class="p">(</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">x_dim_nc_index</span><span class="p">),</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">y_dim_nc_index</span><span class="p">)))</span><span class="w"> </span><span class="c">!Lat and lon</span>

<span class="w">            </span><span class="c">!Allocate array for the alternative meteo files</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i_file</span><span class="p">.</span><span class="n">ge</span><span class="p">.</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="nb">allocated</span><span class="p">(</span><span class="n">meteo_var1d_nc</span><span class="p">))</span><span class="w"> </span><span class="k">allocate</span><span class="w"> </span><span class="p">(</span><span class="n">meteo_var1d_nc</span><span class="p">(</span><span class="nb">maxval</span><span class="p">(</span><span class="n">dim_length_meteo_nc</span><span class="p">),</span><span class="n">num_dims_meteo_nc</span><span class="p">))</span><span class="w"> </span><span class="c">!x, y, z and time maximum dimensions</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="nb">allocated</span><span class="p">(</span><span class="n">meteo_var2d_nc</span><span class="p">))</span><span class="w"> </span><span class="k">allocate</span><span class="w"> </span><span class="p">(</span><span class="n">meteo_var2d_nc</span><span class="p">(</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">x_dim_nc_index</span><span class="p">),</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">y_dim_nc_index</span><span class="p">),</span><span class="mi">2</span><span class="p">))</span><span class="w"> </span><span class="c">!Lat and lon</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="nb">allocated</span><span class="p">(</span><span class="n">meteo_var3d_nc</span><span class="p">))</span><span class="w"> </span><span class="k">allocate</span><span class="w"> </span><span class="p">(</span><span class="n">meteo_var3d_nc</span><span class="p">(</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">x_dim_nc_index</span><span class="p">),</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">y_dim_nc_index</span><span class="p">),</span><span class="mi">0</span><span class="p">:</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">time_dim_nc_index</span><span class="p">),</span><span class="n">num_var_meteo_nc</span><span class="p">))</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="nb">allocated</span><span class="p">(</span><span class="n">meteo_var4d_nc</span><span class="p">))</span><span class="w"> </span><span class="k">allocate</span><span class="w"> </span><span class="p">(</span><span class="n">meteo_var4d_nc</span><span class="p">(</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">x_dim_nc_index</span><span class="p">),</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">y_dim_nc_index</span><span class="p">),</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">z_dim_nc_index</span><span class="p">),</span><span class="mi">0</span><span class="p">:</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">time_dim_nc_index</span><span class="p">),</span><span class="n">num_var_meteo_nc</span><span class="p">))</span>

<span class="w">            </span><span class="k">endif</span>

<span class="w">            </span><span class="c">!Read in the dimensions and check values of the dimensions.</span>
<span class="w">            </span><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">num_dims_meteo_nc</span>
<span class="w">                </span><span class="n">status_nc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_INQ_VARID</span><span class="w"> </span><span class="p">(</span><span class="n">id_nc</span><span class="p">,</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">dim_name_meteo_nc</span><span class="p">(</span><span class="n">i</span><span class="p">)),</span><span class="w"> </span><span class="n">var_id_nc</span><span class="p">)</span>
<span class="w">                </span><span class="c">!write(*,*) id_nc, trim(dim_name_nc(i)), var_id_nc(i),dim_length_nc(i)</span>
<span class="w">                </span><span class="n">var1d_nc_dp</span><span class="o">=</span><span class="mf">0.</span>
<span class="w">                </span><span class="c">!write(*,*) &#39;HERE&#39;,i,dim_start_nc(i),dim_length_nc(i)</span>
<span class="w">                </span><span class="n">unit_dim_meteo_nc</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">status_nc</span><span class="w"> </span><span class="p">.</span><span class="n">EQ</span><span class="p">.</span><span class="w"> </span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    </span><span class="n">status_nc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nf90_get_att</span><span class="p">(</span><span class="n">id_nc</span><span class="p">,</span><span class="w"> </span><span class="n">var_id_nc</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;units&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">unit_dim_meteo_nc</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
<span class="w">                    </span><span class="n">status_nc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="w"> </span><span class="p">(</span><span class="n">id_nc</span><span class="p">,</span><span class="w"> </span><span class="n">var_id_nc</span><span class="p">,</span><span class="n">var1d_nc_dp</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">i</span><span class="p">)),</span><span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">dim_start_meteo_nc</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">/</span><span class="p">),</span><span class="nb">count</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">/</span><span class="p">));</span><span class="n">meteo_var1d_nc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">i</span><span class="p">)</span><span class="o">=</span><span class="kt">real</span><span class="p">(</span><span class="n">var1d_nc_dp</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span>
<span class="w">                    </span><span class="c">!Use the first file to give valid time stamps</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i_file</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mf">3.</span><span class="nb">and</span><span class="p">.</span><span class="n">i</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">time_dim_nc_index</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                        </span><span class="n">val_dim_meteo_nc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">i</span><span class="p">)</span><span class="o">=</span><span class="kt">real</span><span class="p">(</span><span class="n">var1d_nc_dp</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span>
<span class="w">                        </span><span class="n">valid_dim_length_meteo_nc</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">=</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="w">                    </span><span class="k">endif</span>
<span class="w">                    </span><span class="c">!Use first file to get the valid height of the wind measurements (height3)</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i_file</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mf">3.</span><span class="nb">and</span><span class="p">.</span><span class="n">i</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">z_dim_nc_index</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                        </span><span class="n">val_dim_meteo_nc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">i</span><span class="p">)</span><span class="o">=</span><span class="kt">real</span><span class="p">(</span><span class="n">var1d_nc_dp</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span>
<span class="w">                        </span><span class="n">valid_dim_length_meteo_nc</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">=</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="w">                    </span><span class="k">endif</span>

<span class="w">                    </span><span class="c">!Convert from meters to km for AROME data if necessary</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">i</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">x_dim_nc_index</span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="n">i</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">y_dim_nc_index</span><span class="p">).</span><span class="nb">and</span><span class="p">.</span><span class="nb">trim</span><span class="p">(</span><span class="n">unit_dim_meteo_nc</span><span class="p">(</span><span class="n">i</span><span class="p">)).</span><span class="n">eq</span><span class="p">.</span><span class="s1">&#39;km&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                        write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Units of x y data are in kilometres. Converting to metres&#39;</span>
<span class="w">                        </span><span class="n">val_dim_meteo_nc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">i</span><span class="p">)</span><span class="o">=</span><span class="n">val_dim_meteo_nc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="mf">0.</span>
<span class="w">                        </span><span class="n">meteo_var1d_nc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">i</span><span class="p">)</span><span class="o">=</span><span class="n">meteo_var1d_nc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="mf">0.</span>
<span class="w">                    </span><span class="k">endif</span>

<span class="k">                    write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(3A,2es12.4)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="nb">trim</span><span class="p">(</span><span class="n">dim_name_meteo_nc</span><span class="p">(</span><span class="n">i</span><span class="p">)),</span><span class="s1">&#39; (min, max): &#39;</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="nb">minval</span><span class="p">(</span><span class="n">meteo_var1d_nc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">i</span><span class="p">)),</span><span class="nb">maxval</span><span class="p">(</span><span class="n">meteo_var1d_nc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">i</span><span class="p">))</span>

<span class="w">                </span><span class="k">else</span>
<span class="w">                    </span><span class="c">!meteo_var1d_nc(1:dim_length_meteo_nc(i),i)=0.</span>
<span class="w">                    </span><span class="c">!val_dim_meteo_nc(1:dim_length_meteo_nc(i),i)=0.</span>
<span class="w">                </span><span class="k">endif</span>
<span class="k">            enddo</span>


<span class="w">            </span><span class="c">!i_conc=compound_index</span>

<span class="w">            </span><span class="c">!Loop through the meteo_variables</span>
<span class="w">            </span><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">num_var_meteo_nc</span>

<span class="w">                </span><span class="c">!Identify the variable name and ID in the nc file</span>
<span class="w">                </span><span class="n">var_name_nc_temp</span><span class="o">=</span><span class="n">var_name_meteo_nc</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="w">                </span><span class="n">status_nc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_INQ_VARID</span><span class="w"> </span><span class="p">(</span><span class="n">id_nc</span><span class="p">,</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_nc_temp</span><span class="p">),</span><span class="w"> </span><span class="n">var_id_nc</span><span class="p">)</span>
<span class="w">                </span><span class="c">!write(*,*) &#39;Status1: &#39;,status_nc,var_id_nc,trim(var_name_nc_temp),i_source</span>

<span class="w">                </span><span class="c">!If a variable name is found in the file then go further</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">status_nc</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    </span><span class="n">scale_factor_nc</span><span class="o">=</span><span class="mf">1.</span>
<span class="w">                    </span><span class="c">!Find the dimensions of the variable (temp_num_dims)</span>
<span class="w">                    </span><span class="n">status_nc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_INQUIRE_VARIABLE</span><span class="p">(</span><span class="n">id_nc</span><span class="p">,</span><span class="w"> </span><span class="n">var_id_nc</span><span class="p">,</span><span class="w"> </span><span class="n">ndims</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">temp_num_dims</span><span class="p">)</span>
<span class="w">                    </span><span class="c">!write(*,*) temp_num_dims,status_nc</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">temp_num_dims</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mf">2.</span><span class="nb">and</span><span class="p">.</span><span class="n">i_file</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">                        </span><span class="c">!Read latitude and longitude data into a 2d grid if available. Only lat lon is 2d?</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">lat_nc_index</span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="n">i</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">lon_nc_index</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                            </span><span class="n">status_nc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="w"> </span><span class="p">(</span><span class="n">id_nc</span><span class="p">,</span><span class="w"> </span><span class="n">var_id_nc</span><span class="p">,</span><span class="w"> </span><span class="n">var2d_nc_dp</span><span class="p">);</span><span class="n">meteo_var2d_nc</span><span class="p">(:,:,</span><span class="n">i</span><span class="p">)</span><span class="o">=</span><span class="kt">real</span><span class="p">(</span><span class="n">var2d_nc_dp</span><span class="p">)</span>
<span class="w">                            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A,i3,A,2A,2f16.4)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39; Reading: &#39;</span><span class="p">,</span><span class="n">temp_num_dims</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_nc_temp</span><span class="p">),</span><span class="s1">&#39; (min, max): &#39;</span><span class="p">,</span><span class="nb">minval</span><span class="p">(</span><span class="n">meteo_var2d_nc</span><span class="p">(:,:,</span><span class="n">i</span><span class="p">)),</span><span class="nb">maxval</span><span class="p">(</span><span class="n">meteo_var2d_nc</span><span class="p">(:,:,</span><span class="n">i</span><span class="p">))</span>
<span class="w">                        </span><span class="k">endif</span>
<span class="k">                    elseif</span><span class="w"> </span><span class="p">(</span><span class="n">temp_num_dims</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mf">3.</span><span class="nb">and</span><span class="p">.</span><span class="n">i_file</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">                        </span><span class="c">!Special case for z0 file as they are scaled integers and a single time file</span>
<span class="w">                        </span><span class="c">!write(*,&#39;(6i)&#39;) dim_start_nc(x_dim_nc_index),dim_start_nc(y_dim_nc_index),dim_start_nc(time_dim_nc_index),dim_length_nc(x_dim_nc_index),dim_length_nc(y_dim_nc_index),dim_length_nc(time_dim_nc_index)</span>
<span class="w">                        </span><span class="n">status_nc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nf90_get_att</span><span class="p">(</span><span class="n">id_nc</span><span class="p">,</span><span class="w"> </span><span class="n">var_id_nc</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;scale_factor&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">scale_factor_nc</span><span class="p">)</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">status_nc</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="n">scale_factor_nc</span><span class="o">=</span><span class="mf">1.</span>
<span class="w">                        </span><span class="c">!write(*,*) &#39;scale_factor=&#39;,scale_factor_nc</span>
<span class="w">                        </span><span class="n">status_nc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="w"> </span><span class="p">(</span><span class="n">id_nc</span><span class="p">,</span><span class="w"> </span><span class="n">var_id_nc</span><span class="p">,</span><span class="w"> </span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">),</span><span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">dim_start_meteo_nc</span><span class="p">(</span><span class="n">x_dim_nc_index</span><span class="p">),</span><span class="n">dim_start_meteo_nc</span><span class="p">(</span><span class="n">y_dim_nc_index</span><span class="p">),</span><span class="n">dim_start_meteo_nc</span><span class="p">(</span><span class="n">time_dim_nc_index</span><span class="p">)</span><span class="o">/</span><span class="p">),</span><span class="nb">count</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">x_dim_nc_index</span><span class="p">),</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">y_dim_nc_index</span><span class="p">),</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">time_dim_nc_index</span><span class="p">)</span><span class="o">/</span><span class="p">))</span>
<span class="w">                        </span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">i</span><span class="p">)</span><span class="o">=</span><span class="kt">real</span><span class="p">(</span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">scale_factor_nc</span><span class="p">)</span>
<span class="w">                        </span><span class="c">!write(*,*) status_nc</span>
<span class="w">                        </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A,I,3A,2f16.4)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39; Reading: &#39;</span><span class="p">,</span><span class="n">temp_num_dims</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_nc_temp</span><span class="p">),</span><span class="s1">&#39; (min, max): &#39;</span><span class="p">,</span><span class="nb">minval</span><span class="p">(</span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,</span><span class="mi">1</span><span class="p">:</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">time_dim_nc_index</span><span class="p">),</span><span class="n">i</span><span class="p">)),</span><span class="nb">maxval</span><span class="p">(</span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,</span><span class="mi">1</span><span class="p">:</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">time_dim_nc_index</span><span class="p">),</span><span class="n">i</span><span class="p">))</span>
<span class="w">                    </span><span class="k">elseif</span><span class="w"> </span><span class="p">(</span><span class="n">temp_num_dims</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mf">4.</span><span class="nb">and</span><span class="p">.</span><span class="n">i_file</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">                        </span><span class="c">!write(*,*) dim_start_nc(z_dim_nc_index),dim_start_nc(z_dim_nc_index)+dim_length_nc(z_dim_nc_index)-1</span>
<span class="w">                        </span><span class="c">!write(*,*) dim_start_nc(x_dim_nc_index),dim_start_nc(y_dim_nc_index),dim_start_nc(z_dim_nc_index),dim_start_nc(time_dim_nc_index)</span>
<span class="w">                        </span><span class="c">!write(*,*) dim_length_nc(x_dim_nc_index),dim_length_nc(y_dim_nc_index),dim_length_nc(z_dim_nc_index),dim_length_nc(time_dim_nc_index)</span>
<span class="w">                        </span><span class="n">status_nc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="w"> </span><span class="p">(</span><span class="n">id_nc</span><span class="p">,</span><span class="w"> </span><span class="n">var_id_nc</span><span class="p">,</span><span class="w"> </span><span class="n">meteo_var4d_nc</span><span class="p">(:,:,</span><span class="n">dim_start_meteo_nc</span><span class="p">(</span><span class="n">z_dim_nc_index</span><span class="p">):</span><span class="n">dim_start_meteo_nc</span><span class="p">(</span><span class="n">z_dim_nc_index</span><span class="p">)</span><span class="o">+</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">z_dim_nc_index</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,:,</span><span class="n">i</span><span class="p">),</span><span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">dim_start_meteo_nc</span><span class="p">(</span><span class="n">x_dim_nc_index</span><span class="p">),</span><span class="n">dim_start_meteo_nc</span><span class="p">(</span><span class="n">y_dim_nc_index</span><span class="p">),</span><span class="n">dim_start_meteo_nc</span><span class="p">(</span><span class="n">z_dim_nc_index</span><span class="p">),</span><span class="n">dim_start_meteo_nc</span><span class="p">(</span><span class="n">time_dim_nc_index</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="p">),</span><span class="nb">count</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">x_dim_nc_index</span><span class="p">),</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">y_dim_nc_index</span><span class="p">),</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">z_dim_nc_index</span><span class="p">),</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">time_dim_nc_index</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="o">/</span><span class="p">))</span>
<span class="w">                        </span><span class="c">!status_nc = NF90_GET_VAR (id_nc, var_id_nc, meteo_var4d_nc(:,:,dim_start_meteo_nc(z_dim_nc_index):dim_start_meteo_nc(z_dim_nc_index)+dim_length_meteo_nc(z_dim_nc_index)-1,dim_start_meteo_nc(time_dim_nc_index)-1:dim_start_meteo_nc(time_dim_nc_index)+dim_length_meteo_nc(time_dim_nc_index)-1,i),start=(/dim_start_meteo_nc(x_dim_nc_index),dim_start_meteo_nc(y_dim_nc_index),dim_start_meteo_nc(z_dim_nc_index),dim_start_meteo_nc(time_dim_nc_index)-1/),count=(/dim_length_meteo_nc(x_dim_nc_index),dim_length_meteo_nc(y_dim_nc_index),dim_length_meteo_nc(z_dim_nc_index),dim_length_meteo_nc(time_dim_nc_index)+1/))</span>
<span class="w">                        </span><span class="c">!status_nc = NF90_GET_VAR (id_nc, var_id_nc, meteo_var4d_nc(:,:,1,dim_start_meteo_nc(time_dim_nc_index):dim_length_meteo_nc(time_dim_nc_index),i),start=(/dim_start_meteo_nc(x_dim_nc_index),dim_start_meteo_nc(y_dim_nc_index),1,dim_start_meteo_nc(time_dim_nc_index)/),count=(/dim_length_meteo_nc(x_dim_nc_index),dim_length_meteo_nc(y_dim_nc_index),1,dim_length_meteo_nc(time_dim_nc_index)/))</span>
<span class="w">                        </span><span class="c">!status_nc = NF90_GET_VAR (id_nc, var_id_nc, temp_var4d_nc(:,:,:,:),start=(/dim_start_nc(x_dim_nc_index),dim_start_nc(y_dim_nc_index),dim_start_nc(z_dim_nc_index),temp_start_time_nc_index/),count=(/dim_length_nc(x_dim_nc_index),dim_length_nc(y_dim_nc_index),dim_length_nc(z_dim_nc_index),dim_length_nc(time_dim_nc_index)/))</span>
<span class="w">                        </span><span class="c">!var4d_nc(:,val_dim_nc:,:,:,i,i_source)=real(temp_var4d_nc(:,:,:,:))</span>
<span class="w">                        </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A,I,3A,2f16.4)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39; Reading: &#39;</span><span class="p">,</span><span class="n">temp_num_dims</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_nc_temp</span><span class="p">),</span><span class="s1">&#39; (min, max): &#39;</span><span class="p">,</span><span class="nb">minval</span><span class="p">(</span><span class="n">meteo_var4d_nc</span><span class="p">(:,:,</span><span class="n">dim_start_meteo_nc</span><span class="p">(</span><span class="n">z_dim_nc_index</span><span class="p">):</span><span class="n">dim_start_meteo_nc</span><span class="p">(</span><span class="n">z_dim_nc_index</span><span class="p">)</span><span class="o">+</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">z_dim_nc_index</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">time_dim_nc_index</span><span class="p">),</span><span class="n">i</span><span class="p">)),</span><span class="nb">maxval</span><span class="p">(</span><span class="n">meteo_var4d_nc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">x_dim_nc_index</span><span class="p">),</span><span class="mi">1</span><span class="p">:</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">y_dim_nc_index</span><span class="p">),</span><span class="n">dim_start_meteo_nc</span><span class="p">(</span><span class="n">z_dim_nc_index</span><span class="p">):</span><span class="n">dim_start_meteo_nc</span><span class="p">(</span><span class="n">z_dim_nc_index</span><span class="p">)</span><span class="o">+</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">z_dim_nc_index</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">time_dim_nc_index</span><span class="p">),</span><span class="n">i</span><span class="p">))</span>
<span class="w">                        </span><span class="c">!write(*,*) dim_start_meteo_nc(time_dim_nc_index)-1,dim_length_meteo_nc(time_dim_nc_index)+1,dim_start_meteo_nc(z_dim_nc_index),dim_start_meteo_nc(z_dim_nc_index)+dim_length_meteo_nc(z_dim_nc_index)-1</span>
<span class="w">                    </span><span class="k">elseif</span><span class="w"> </span><span class="p">(</span><span class="n">temp_num_dims</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mf">3.</span><span class="nb">and</span><span class="p">.</span><span class="n">i_file</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">                        </span><span class="c">!NBV meteo data</span>
<span class="w">                        </span><span class="n">status_nc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nf90_get_att</span><span class="p">(</span><span class="n">id_nc</span><span class="p">,</span><span class="w"> </span><span class="n">var_id_nc</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;scale_factor&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">scale_factor_nc</span><span class="p">)</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">status_nc</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="n">NF90_NOERR</span><span class="p">)</span><span class="w"> </span><span class="n">scale_factor_nc</span><span class="o">=</span><span class="mf">1.</span>
<span class="w">                        </span><span class="c">!write(*,*) dim_start_nc(z_dim_nc_index),dim_start_nc(z_dim_nc_index)+dim_length_nc(z_dim_nc_index)-1</span>
<span class="w">                        </span><span class="c">!write(*,*) dim_start_nc(x_dim_nc_index),dim_start_nc(y_dim_nc_index),dim_start_nc(z_dim_nc_index),dim_start_nc(time_dim_nc_index)</span>
<span class="w">                        </span><span class="c">!write(*,*) dim_length_nc(x_dim_nc_index),dim_length_nc(y_dim_nc_index),dim_length_nc(z_dim_nc_index),dim_length_nc(time_dim_nc_index)</span>
<span class="w">                        </span><span class="c">!status_nc = NF90_GET_VAR (id_nc, var_id_nc, meteo_var4d_nc(:,:,1,:,i),start=(/dim_start_meteo_nc(x_dim_nc_index),dim_start_meteo_nc(y_dim_nc_index),dim_start_meteo_nc(time_dim_nc_index)-1/),count=(/dim_length_meteo_nc(x_dim_nc_index),dim_length_meteo_nc(y_dim_nc_index),dim_length_meteo_nc(time_dim_nc_index)+1/))</span>
<span class="w">                        </span><span class="n">status_nc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="w"> </span><span class="p">(</span><span class="n">id_nc</span><span class="p">,</span><span class="w"> </span><span class="n">var_id_nc</span><span class="p">,</span><span class="w"> </span><span class="n">meteo_var4d_nc</span><span class="p">(:,:,</span><span class="mi">1</span><span class="p">,</span><span class="n">dim_start_meteo_nc</span><span class="p">(</span><span class="n">time_dim_nc_index</span><span class="p">):</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">time_dim_nc_index</span><span class="p">),</span><span class="n">i</span><span class="p">),</span><span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">dim_start_meteo_nc</span><span class="p">(</span><span class="n">x_dim_nc_index</span><span class="p">),</span><span class="n">dim_start_meteo_nc</span><span class="p">(</span><span class="n">y_dim_nc_index</span><span class="p">),</span><span class="n">dim_start_meteo_nc</span><span class="p">(</span><span class="n">time_dim_nc_index</span><span class="p">)</span><span class="o">/</span><span class="p">),</span><span class="nb">count</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">x_dim_nc_index</span><span class="p">),</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">y_dim_nc_index</span><span class="p">),</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">time_dim_nc_index</span><span class="p">)</span><span class="o">/</span><span class="p">))</span>
<span class="w">                        </span><span class="c">!status_nc = NF90_GET_VAR (id_nc, var_id_nc, temp_var4d_nc(:,:,:,:),start=(/dim_start_nc(x_dim_nc_index),dim_start_nc(y_dim_nc_index),dim_start_nc(z_dim_nc_index),temp_start_time_nc_index/),count=(/dim_length_nc(x_dim_nc_index),dim_length_nc(y_dim_nc_index),dim_length_nc(z_dim_nc_index),dim_length_nc(time_dim_nc_index)/))</span>
<span class="w">                        </span><span class="n">meteo_var4d_nc</span><span class="p">(:,:,:,:,</span><span class="n">i</span><span class="p">)</span><span class="o">=</span><span class="kt">real</span><span class="p">(</span><span class="n">meteo_var4d_nc</span><span class="p">(:,:,:,:,</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="n">scale_factor_nc</span><span class="p">)</span>
<span class="w">                        </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A,I,3A,2f16.4)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39; Reading: &#39;</span><span class="p">,</span><span class="n">temp_num_dims</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_nc_temp</span><span class="p">),</span><span class="s1">&#39; (min, max): &#39;</span><span class="p">,</span><span class="nb">minval</span><span class="p">(</span><span class="n">meteo_var4d_nc</span><span class="p">(:,:,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">time_dim_nc_index</span><span class="p">),</span><span class="n">i</span><span class="p">)),</span><span class="nb">maxval</span><span class="p">(</span><span class="n">meteo_var4d_nc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">x_dim_nc_index</span><span class="p">),</span><span class="mi">1</span><span class="p">:</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">y_dim_nc_index</span><span class="p">),</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">time_dim_nc_index</span><span class="p">),</span><span class="n">i</span><span class="p">))</span>
<span class="w">                        </span><span class="c">!write(*,*) dim_start_meteo_nc(time_dim_nc_index)-1,dim_length_meteo_nc(time_dim_nc_index)+1,dim_start_meteo_nc(z_dim_nc_index),dim_start_meteo_nc(z_dim_nc_index)+dim_length_meteo_nc(z_dim_nc_index)-1</span>
<span class="w">                    </span><span class="k">elseif</span><span class="w"> </span><span class="p">(</span><span class="n">temp_num_dims</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mf">5.</span><span class="nb">and</span><span class="p">.</span><span class="n">i_file</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">                        </span><span class="c">!This is the case when there is an ensemble member in the format</span>
<span class="w">                        </span><span class="c">!write(*,*) dim_start_nc(z_dim_nc_index),dim_start_nc(z_dim_nc_index)+dim_length_nc(z_dim_nc_index)-1</span>
<span class="w">                        </span><span class="c">!write(*,*) dim_start_nc(x_dim_nc_index),dim_start_nc(y_dim_nc_index),dim_start_nc(z_dim_nc_index),dim_start_nc(time_dim_nc_index)</span>
<span class="w">                        </span><span class="c">!write(*,*) dim_length_nc(x_dim_nc_index),dim_length_nc(y_dim_nc_index),dim_length_nc(z_dim_nc_index),dim_length_nc(time_dim_nc_index)</span>
<span class="w">                        </span><span class="n">status_nc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="w"> </span><span class="p">(</span><span class="n">id_nc</span><span class="p">,</span><span class="w"> </span><span class="n">var_id_nc</span><span class="p">,</span><span class="w"> </span><span class="n">meteo_var4d_nc</span><span class="p">(:,:,</span><span class="n">dim_start_meteo_nc</span><span class="p">(</span><span class="n">z_dim_nc_index</span><span class="p">):</span><span class="n">dim_start_meteo_nc</span><span class="p">(</span><span class="n">z_dim_nc_index</span><span class="p">)</span><span class="o">+</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">z_dim_nc_index</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,:,</span><span class="n">i</span><span class="p">),</span><span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">dim_start_meteo_nc</span><span class="p">(</span><span class="n">x_dim_nc_index</span><span class="p">),</span><span class="n">dim_start_meteo_nc</span><span class="p">(</span><span class="n">y_dim_nc_index</span><span class="p">),</span><span class="mi">1</span><span class="p">,</span><span class="n">dim_start_meteo_nc</span><span class="p">(</span><span class="n">z_dim_nc_index</span><span class="p">),</span><span class="n">dim_start_meteo_nc</span><span class="p">(</span><span class="n">time_dim_nc_index</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="p">),</span><span class="nb">count</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">x_dim_nc_index</span><span class="p">),</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">y_dim_nc_index</span><span class="p">),</span><span class="mi">1</span><span class="p">,</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">z_dim_nc_index</span><span class="p">),</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">time_dim_nc_index</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="o">/</span><span class="p">))</span>
<span class="w">                        </span><span class="c">!status_nc = NF90_GET_VAR (id_nc, var_id_nc, temp_var4d_nc(:,:,:,:),start=(/dim_start_nc(x_dim_nc_index),dim_start_nc(y_dim_nc_index),dim_start_nc(z_dim_nc_index),temp_start_time_nc_index/),count=(/dim_length_nc(x_dim_nc_index),dim_length_nc(y_dim_nc_index),dim_length_nc(z_dim_nc_index),dim_length_nc(time_dim_nc_index)/))</span>
<span class="w">                        </span><span class="c">!var4d_nc(:,val_dim_nc:,:,:,i,i_source)=real(temp_var4d_nc(:,:,:,:))</span>
<span class="w">                        </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A,I,3A,2f16.4)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39; Reading: &#39;</span><span class="p">,</span><span class="n">temp_num_dims</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_nc_temp</span><span class="p">),</span><span class="s1">&#39; (min, max): &#39;</span><span class="p">,</span><span class="nb">minval</span><span class="p">(</span><span class="n">meteo_var4d_nc</span><span class="p">(:,:,</span><span class="n">dim_start_meteo_nc</span><span class="p">(</span><span class="n">z_dim_nc_index</span><span class="p">):</span><span class="n">dim_start_meteo_nc</span><span class="p">(</span><span class="n">z_dim_nc_index</span><span class="p">)</span><span class="o">+</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">z_dim_nc_index</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">time_dim_nc_index</span><span class="p">),</span><span class="n">i</span><span class="p">)),</span><span class="nb">maxval</span><span class="p">(</span><span class="n">meteo_var4d_nc</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">x_dim_nc_index</span><span class="p">),</span><span class="mi">1</span><span class="p">:</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">y_dim_nc_index</span><span class="p">),</span><span class="n">dim_start_meteo_nc</span><span class="p">(</span><span class="n">z_dim_nc_index</span><span class="p">):</span><span class="n">dim_start_meteo_nc</span><span class="p">(</span><span class="n">z_dim_nc_index</span><span class="p">)</span><span class="o">+</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">z_dim_nc_index</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">time_dim_nc_index</span><span class="p">),</span><span class="n">i</span><span class="p">))</span>
<span class="w">                        </span><span class="c">!write(*,*) dim_start_meteo_nc(time_dim_nc_index)-1,dim_length_meteo_nc(time_dim_nc_index)+1,dim_start_meteo_nc(z_dim_nc_index),dim_start_meteo_nc(z_dim_nc_index)+dim_length_meteo_nc(z_dim_nc_index)-1</span>
<span class="w">                    </span><span class="k">else</span>
<span class="k">                        write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(8A,8A)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39; Cannot find a correct dimension for: &#39;</span><span class="p">,</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_nc_temp</span><span class="p">)</span>
<span class="w">                    </span><span class="k">endif</span>

<span class="k">                else</span>
<span class="w">                    </span><span class="c">!write(unit_logfile,&#39;(8A,8A)&#39;) &#39; Cannot read: &#39;,trim(var_name_nc_temp)</span>
<span class="w">                </span><span class="k">endif</span>

<span class="k">            enddo</span>

<span class="w">            </span><span class="c">!Read in 2m temperature completely to get the daily average for home heating</span>
<span class="w">            </span><span class="c">!if (use_RWC_emission_data.and.save_emissions_for_EMEP(heating_index).and.i_file.eq.3) then</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">use_RWC_emission_data</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">i_file</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                </span><span class="n">DMT_start_time_nc_index</span><span class="o">=</span><span class="n">start_time_meteo_nc_index</span>
<span class="w">                </span><span class="n">DMT_end_time_nc_index</span><span class="o">=</span><span class="n">end_time_meteo_nc_index</span>
<span class="w">                </span><span class="c">!DMT_start_time_nc_index=save_emissions_start_index</span>
<span class="w">                </span><span class="c">!DMT_end_time_nc_index=save_emissions_end_index</span>

<span class="w">                </span><span class="n">DMT_dim_length_nc</span><span class="o">=</span><span class="n">DMT_end_time_nc_index</span><span class="o">-</span><span class="n">DMT_start_time_nc_index</span><span class="o">+</span><span class="mi">1</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">DMT_EMEP_grid_nc</span><span class="p">))</span><span class="w"> </span><span class="k">deallocate</span><span class="w"> </span><span class="p">(</span><span class="n">DMT_EMEP_grid_nc</span><span class="p">)</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="nb">allocated</span><span class="p">(</span><span class="n">DMT_EMEP_grid_nc</span><span class="p">))</span><span class="w"> </span><span class="k">allocate</span><span class="w"> </span><span class="p">(</span><span class="n">DMT_EMEP_grid_nc</span><span class="p">(</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">x_dim_nc_index</span><span class="p">),</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">y_dim_nc_index</span><span class="p">),</span><span class="n">DMT_dim_length_nc</span><span class="p">))</span>

<span class="w">                </span><span class="c">!write(*,*) DMT_start_time_nc_index,DMT_end_time_nc_index,DMT_dim_length_nc</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">calculate_source</span><span class="p">(</span><span class="n">heating_index</span><span class="p">).</span><span class="nb">and</span><span class="p">.</span><span class="n">i_file</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    </span><span class="n">var_name_nc_temp</span><span class="o">=</span><span class="n">var_name_meteo_nc</span><span class="p">(</span><span class="n">t2m_nc_index</span><span class="p">)</span>
<span class="w">                    </span><span class="n">status_nc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_INQ_VARID</span><span class="w"> </span><span class="p">(</span><span class="n">id_nc</span><span class="p">,</span><span class="w"> </span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_nc_temp</span><span class="p">),</span><span class="w"> </span><span class="n">var_id_nc</span><span class="p">)</span>
<span class="w">                    </span><span class="n">status_nc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_INQUIRE_VARIABLE</span><span class="p">(</span><span class="n">id_nc</span><span class="p">,</span><span class="w"> </span><span class="n">var_id_nc</span><span class="p">,</span><span class="w"> </span><span class="n">ndims</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">temp_num_dims</span><span class="p">)</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">temp_num_dims</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                        </span><span class="n">status_nc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="w"> </span><span class="p">(</span><span class="n">id_nc</span><span class="p">,</span><span class="w"> </span><span class="n">var_id_nc</span><span class="p">,</span><span class="w"> </span><span class="n">DMT_EMEP_grid_nc</span><span class="p">(:,:,:),</span><span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">dim_start_meteo_nc</span><span class="p">(</span><span class="n">x_dim_nc_index</span><span class="p">),</span><span class="n">dim_start_meteo_nc</span><span class="p">(</span><span class="n">y_dim_nc_index</span><span class="p">),</span><span class="mi">1</span><span class="p">,</span><span class="n">DMT_start_time_nc_index</span><span class="o">/</span><span class="p">),</span><span class="nb">count</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">x_dim_nc_index</span><span class="p">),</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">y_dim_nc_index</span><span class="p">),</span><span class="mi">1</span><span class="p">,</span><span class="n">DMT_dim_length_nc</span><span class="o">/</span><span class="p">))</span>
<span class="w">                    </span><span class="k">elseif</span><span class="w"> </span><span class="p">(</span><span class="n">temp_num_dims</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">                        </span><span class="c">!NBV meteo data</span>
<span class="w">                        </span><span class="n">status_nc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="w"> </span><span class="p">(</span><span class="n">id_nc</span><span class="p">,</span><span class="w"> </span><span class="n">var_id_nc</span><span class="p">,</span><span class="w"> </span><span class="n">DMT_EMEP_grid_nc</span><span class="p">(:,:,:),</span><span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">dim_start_meteo_nc</span><span class="p">(</span><span class="n">x_dim_nc_index</span><span class="p">),</span><span class="n">dim_start_meteo_nc</span><span class="p">(</span><span class="n">y_dim_nc_index</span><span class="p">),</span><span class="n">DMT_start_time_nc_index</span><span class="o">/</span><span class="p">),</span><span class="nb">count</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">x_dim_nc_index</span><span class="p">),</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">y_dim_nc_index</span><span class="p">),</span><span class="n">DMT_dim_length_nc</span><span class="o">/</span><span class="p">))</span>
<span class="w">                    </span><span class="k">elseif</span><span class="w"> </span><span class="p">(</span><span class="n">temp_num_dims</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                        </span><span class="n">status_nc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_GET_VAR</span><span class="w"> </span><span class="p">(</span><span class="n">id_nc</span><span class="p">,</span><span class="w"> </span><span class="n">var_id_nc</span><span class="p">,</span><span class="w"> </span><span class="n">DMT_EMEP_grid_nc</span><span class="p">(:,:,:),</span><span class="n">start</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">dim_start_meteo_nc</span><span class="p">(</span><span class="n">x_dim_nc_index</span><span class="p">),</span><span class="n">dim_start_meteo_nc</span><span class="p">(</span><span class="n">y_dim_nc_index</span><span class="p">),</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">DMT_start_time_nc_index</span><span class="o">/</span><span class="p">),</span><span class="nb">count</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">x_dim_nc_index</span><span class="p">),</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">y_dim_nc_index</span><span class="p">),</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">DMT_dim_length_nc</span><span class="o">/</span><span class="p">))</span>
<span class="w">                    </span><span class="k">else</span>
<span class="k">                        write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(8A,8A)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39; Cannot find a correct dimension for: &#39;</span><span class="p">,</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_nc_temp</span><span class="p">)</span>
<span class="w">                    </span><span class="k">endif</span>

<span class="k">                    write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A,i,3A,2f16.4)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39; Reading: &#39;</span><span class="p">,</span><span class="n">temp_num_dims</span><span class="p">,</span><span class="s1">&#39; &#39;</span><span class="p">,</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_nc_temp</span><span class="p">),</span><span class="s1">&#39; (min, max): &#39;</span><span class="p">,</span><span class="nb">minval</span><span class="p">(</span><span class="n">DMT_EMEP_grid_nc</span><span class="p">),</span><span class="nb">maxval</span><span class="p">(</span><span class="n">DMT_EMEP_grid_nc</span><span class="p">)</span>
<span class="w">                    </span><span class="n">DMT_EMEP_grid_nc</span><span class="p">(:,:,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="nb">sum</span><span class="p">(</span><span class="n">DMT_EMEP_grid_nc</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="n">DMT_dim_length_nc</span><span class="o">-</span><span class="mi">27</span><span class="mf">3.13</span>
<span class="w">                    </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(3A,2f16.4)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39; Calculating mean: &#39;</span><span class="p">,</span><span class="nb">trim</span><span class="p">(</span><span class="s1">&#39;Daily mean temperature&#39;</span><span class="p">),</span><span class="s1">&#39; (min, max): &#39;</span><span class="p">,</span><span class="nb">minval</span><span class="p">(</span><span class="n">DMT_EMEP_grid_nc</span><span class="p">(:,:,</span><span class="mi">1</span><span class="p">)),</span><span class="nb">maxval</span><span class="p">(</span><span class="n">DMT_EMEP_grid_nc</span><span class="p">(:,:,</span><span class="mi">1</span><span class="p">))</span>

<span class="w">                </span><span class="k">endif</span>

<span class="k">            endif</span>

<span class="k">            </span><span class="n">status_nc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NF90_CLOSE</span><span class="w"> </span><span class="p">(</span><span class="n">id_nc</span><span class="p">)</span>

<span class="w">        </span><span class="k">enddo</span><span class="w"> </span><span class="c">!End file loop</span>

<span class="w">        </span><span class="c">!Set the correct time dimensions to the first file value</span>
<span class="w">        </span><span class="n">dim_length_meteo_nc</span><span class="o">=</span><span class="n">valid_dim_length_meteo_nc</span>

<span class="w">        </span><span class="c">!Set the grid spacing</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">meteo_nc_projection_type</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">LL_projection_index</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            </span><span class="n">meteo_dgrid_nc</span><span class="p">(</span><span class="n">lon_nc_index</span><span class="p">)</span><span class="o">=</span><span class="n">meteo_var1d_nc</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">x_dim_nc_index</span><span class="p">)</span><span class="o">-</span><span class="n">meteo_var1d_nc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">x_dim_nc_index</span><span class="p">)</span>
<span class="w">            </span><span class="n">meteo_dgrid_nc</span><span class="p">(</span><span class="n">lat_nc_index</span><span class="p">)</span><span class="o">=</span><span class="n">meteo_var1d_nc</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">y_dim_nc_index</span><span class="p">)</span><span class="o">-</span><span class="n">meteo_var1d_nc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">y_dim_nc_index</span><span class="p">)</span>
<span class="w">            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A,2f16.4)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39; Grid spacing meteo (lon,lat): &#39;</span><span class="p">,</span><span class="n">meteo_dgrid_nc</span><span class="p">(</span><span class="n">lon_nc_index</span><span class="p">),</span><span class="n">meteo_dgrid_nc</span><span class="p">(</span><span class="n">lat_nc_index</span><span class="p">)</span>
<span class="w">        </span><span class="k">else</span>
<span class="k">            </span><span class="n">meteo_dgrid_nc</span><span class="p">(</span><span class="n">lon_nc_index</span><span class="p">)</span><span class="o">=</span><span class="n">meteo_var1d_nc</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">x_dim_nc_index</span><span class="p">)</span><span class="o">-</span><span class="n">meteo_var1d_nc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">x_dim_nc_index</span><span class="p">)</span>
<span class="w">            </span><span class="n">meteo_dgrid_nc</span><span class="p">(</span><span class="n">lat_nc_index</span><span class="p">)</span><span class="o">=</span><span class="n">meteo_var1d_nc</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">y_dim_nc_index</span><span class="p">)</span><span class="o">-</span><span class="n">meteo_var1d_nc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">y_dim_nc_index</span><span class="p">)</span>
<span class="w">            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A,2f16.4)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39; Grid spacing meteo (x,y) in meters: &#39;</span><span class="p">,</span><span class="n">meteo_dgrid_nc</span><span class="p">(</span><span class="n">lon_nc_index</span><span class="p">),</span><span class="n">meteo_dgrid_nc</span><span class="p">(</span><span class="n">lat_nc_index</span><span class="p">)</span>
<span class="w">        </span><span class="k">endif</span>


<span class="w">        </span><span class="c">!Do manipulations when the additional meteorology is read in</span>
<span class="w">        </span><span class="c">!Put everything in 3d data since it is all surface values</span>
<span class="w">        </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39; Calculating alternative meteorological data&#39;</span>
<span class="w">        </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A,4i)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39; Dimensions: &#39;</span><span class="p">,</span><span class="n">dim_length_meteo_nc</span>
<span class="w">        </span><span class="c">!logz0 is read in as z0 and must be converted to logz0</span>
<span class="w">        </span><span class="k">do </span><span class="n">t</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">time_dim_nc_index</span><span class="p">)</span>
<span class="w">            </span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,</span><span class="n">t</span><span class="p">,</span><span class="n">logz0_nc_index</span><span class="p">)</span><span class="o">=</span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,</span><span class="mi">1</span><span class="p">,</span><span class="n">logz0_nc_index</span><span class="p">)</span>
<span class="w">            </span><span class="c">!write(*,*) t,sum(meteo_var3d_nc(:,:,t,logz0_nc_index))/dim_length_meteo_nc(x_dim_nc_index)/dim_length_meteo_nc(y_dim_nc_index)</span>
<span class="w">        </span><span class="k">enddo</span>
<span class="k">        where</span><span class="w"> </span><span class="p">(</span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">logz0_nc_index</span><span class="p">).</span><span class="n">lt</span><span class="p">.</span><span class="mf">0.001</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">logz0_nc_index</span><span class="p">)</span><span class="o">=</span><span class="mf">0.001</span>
<span class="w">        </span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">logz0_nc_index</span><span class="p">)</span><span class="o">=</span><span class="nb">log</span><span class="p">(</span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">logz0_nc_index</span><span class="p">))</span>

<span class="w">        </span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">t2m_nc_index</span><span class="p">)</span><span class="o">=</span><span class="n">meteo_var4d_nc</span><span class="p">(:,:,</span><span class="n">surface_level_nc</span><span class="p">,:,</span><span class="n">t2m_nc_index</span><span class="p">)</span>
<span class="w">        </span><span class="c">!Assumes that the first step is 0 and data is hourly. So that the start time step for meteo must correspond to the second hour of any calculation</span>
<span class="w">        </span><span class="c">!t=1</span>
<span class="w">        </span><span class="c">!meteo_var3d_nc(:,:,t,Hflux_nc_index)=meteo_var4d_nc(:,:,surface_level_nc,t,Hflux_nc_index)/3600.</span>
<span class="w">        </span><span class="c">!meteo_var3d_nc(:,:,t,uw_nc_index)=meteo_var4d_nc(:,:,surface_level_nc,t,uw_nc_index)/3600.</span>
<span class="w">        </span><span class="c">!meteo_var3d_nc(:,:,t,vw_nc_index)=meteo_var4d_nc(:,:,surface_level_nc,t,vw_nc_index)/3600.</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">index</span><span class="p">(</span><span class="n">alternative_meteorology_type</span><span class="p">,</span><span class="s1">&#39;nbv&#39;</span><span class="p">).</span><span class="n">gt</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="c">!Flux is upward and not integrated. Stress is not integrated</span>
<span class="w">            </span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">Hflux_nc_index</span><span class="p">)</span><span class="o">=-</span><span class="n">meteo_var4d_nc</span><span class="p">(:,:,</span><span class="n">surface_level_nc</span><span class="p">,:,</span><span class="n">Hflux_nc_index</span><span class="p">)</span>
<span class="w">            </span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">uw_nc_index</span><span class="p">)</span><span class="o">=</span><span class="n">meteo_var4d_nc</span><span class="p">(:,:,</span><span class="n">surface_level_nc</span><span class="p">,:,</span><span class="n">uw_nc_index</span><span class="p">)</span>
<span class="w">            </span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">vw_nc_index</span><span class="p">)</span><span class="o">=</span><span class="n">meteo_var4d_nc</span><span class="p">(:,:,</span><span class="n">surface_level_nc</span><span class="p">,:,</span><span class="n">vw_nc_index</span><span class="p">)</span>
<span class="w">            </span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">precip_nc_index</span><span class="p">)</span><span class="o">=</span><span class="n">meteo_var4d_nc</span><span class="p">(:,:,</span><span class="n">surface_level_nc</span><span class="p">,:,</span><span class="n">precip_nc_index</span><span class="p">)</span>
<span class="w">        </span><span class="k">else</span>
<span class="k">            do </span><span class="n">t</span><span class="o">=</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">time_dim_nc_index</span><span class="p">),</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span>
<span class="w">                </span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,</span><span class="n">t</span><span class="p">,</span><span class="n">Hflux_nc_index</span><span class="p">)</span><span class="o">=</span><span class="p">(</span><span class="n">meteo_var4d_nc</span><span class="p">(:,:,</span><span class="n">surface_level_nc</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">Hflux_nc_index</span><span class="p">)</span><span class="o">-</span><span class="n">meteo_var4d_nc</span><span class="p">(:,:,</span><span class="n">surface_level_nc</span><span class="p">,</span><span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">Hflux_nc_index</span><span class="p">))</span><span class="o">/</span><span class="mi">360</span><span class="mf">0.</span>
<span class="w">                </span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,</span><span class="n">t</span><span class="p">,</span><span class="n">uw_nc_index</span><span class="p">)</span><span class="o">=</span><span class="p">(</span><span class="n">meteo_var4d_nc</span><span class="p">(:,:,</span><span class="n">surface_level_nc</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">uw_nc_index</span><span class="p">)</span><span class="o">-</span><span class="n">meteo_var4d_nc</span><span class="p">(:,:,</span><span class="n">surface_level_nc</span><span class="p">,</span><span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">uw_nc_index</span><span class="p">))</span><span class="o">/</span><span class="mi">360</span><span class="mf">0.</span>
<span class="w">                </span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,</span><span class="n">t</span><span class="p">,</span><span class="n">vw_nc_index</span><span class="p">)</span><span class="o">=</span><span class="p">(</span><span class="n">meteo_var4d_nc</span><span class="p">(:,:,</span><span class="n">surface_level_nc</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">vw_nc_index</span><span class="p">)</span><span class="o">-</span><span class="n">meteo_var4d_nc</span><span class="p">(:,:,</span><span class="n">surface_level_nc</span><span class="p">,</span><span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">vw_nc_index</span><span class="p">))</span><span class="o">/</span><span class="mi">360</span><span class="mf">0.</span>
<span class="w">                </span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,</span><span class="n">t</span><span class="p">,</span><span class="n">precip_nc_index</span><span class="p">)</span><span class="o">=</span><span class="p">(</span><span class="n">meteo_var4d_nc</span><span class="p">(:,:,</span><span class="n">surface_level_nc</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">precip_nc_index</span><span class="p">)</span><span class="o">-</span><span class="n">meteo_var4d_nc</span><span class="p">(:,:,</span><span class="n">surface_level_nc</span><span class="p">,</span><span class="n">t</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">precip_nc_index</span><span class="p">))</span>
<span class="w">                </span><span class="c">!write(*,*) t,sum(meteo_var3d_nc(:,:,t,Hflux_nc_index))/dim_length_meteo_nc(x_dim_nc_index)/dim_length_meteo_nc(y_dim_nc_index) &amp;</span>
<span class="w">                </span><span class="c">!    ,sum(meteo_var4d_nc(:,:,surface_level_nc,t,hmix_nc_index))/dim_length_meteo_nc(x_dim_nc_index)/dim_length_meteo_nc(y_dim_nc_index)</span>
<span class="w">            </span><span class="k">enddo</span>
<span class="k">        endif</span>

<span class="w">        </span><span class="c">!Approximate density of air used (1.2 kg/m^3 +/- 10%)</span>
<span class="w">        </span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">ustar_nc_index</span><span class="p">)</span><span class="o">=</span><span class="nb">sqrt</span><span class="p">(</span><span class="nb">sqrt</span><span class="p">(</span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">uw_nc_index</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">vw_nc_index</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mf">1.2</span><span class="p">)</span>
<span class="w">        </span><span class="k">where</span><span class="w"> </span><span class="p">(</span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">ustar_nc_index</span><span class="p">).</span><span class="n">lt</span><span class="p">.</span><span class="n">ustar_min</span><span class="p">)</span><span class="w"> </span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">ustar_nc_index</span><span class="p">)</span><span class="o">=</span><span class="n">ustar_min</span>
<span class="w">        </span><span class="c">!do t=dim_length_meteo_nc(time_dim_nc_index),0,-1</span>
<span class="w">        </span><span class="c">!     write(*,*) t,sum(meteo_var3d_nc(:,:,t,ustar_nc_index))/dim_length_meteo_nc(x_dim_nc_index)/dim_length_meteo_nc(y_dim_nc_index) &amp;</span>
<span class="w">        </span><span class="c">!        ,sum(meteo_var3d_nc(:,:,t,uw_nc_index))/dim_length_meteo_nc(x_dim_nc_index)/dim_length_meteo_nc(y_dim_nc_index) &amp;</span>
<span class="w">        </span><span class="c">!        ,sum(meteo_var3d_nc(:,:,t,vw_nc_index))/dim_length_meteo_nc(x_dim_nc_index)/dim_length_meteo_nc(y_dim_nc_index)</span>
<span class="w">        </span><span class="c">!enddo</span>

<span class="w">        </span><span class="c">!Approximate temperature (273 +/- 10%)</span>
<span class="w">        </span><span class="c">!Have inserted the correct temperature now</span>
<span class="w">        </span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">invL_nc_index</span><span class="p">)</span><span class="o">=</span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">Hflux_nc_index</span><span class="p">)</span><span class="o">*</span><span class="mf">0.4</span><span class="o">*</span><span class="mf">9.8</span><span class="o">/</span><span class="mf">1.2</span><span class="o">/</span><span class="mi">100</span><span class="mf">4.</span><span class="o">/</span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">t2m_nc_index</span><span class="p">)</span><span class="o">/</span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">ustar_nc_index</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span>
<span class="w">        </span><span class="c">!Limit stable L to lowest_stable_L and to lowest_unstable_L (negative number) for unstable.</span>
<span class="w">        </span><span class="k">where</span><span class="w"> </span><span class="p">(</span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">invL_nc_index</span><span class="p">).</span><span class="n">lt</span><span class="p">.</span><span class="mf">1.0</span><span class="o">/</span><span class="n">lowest_unstable_L</span><span class="p">)</span><span class="w"> </span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">invL_nc_index</span><span class="p">)</span><span class="o">=</span><span class="mf">1.0</span><span class="o">/</span><span class="n">lowest_unstable_L</span>
<span class="w">        </span><span class="k">where</span><span class="w"> </span><span class="p">(</span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">invL_nc_index</span><span class="p">).</span><span class="n">gt</span><span class="p">.</span><span class="mf">1.0</span><span class="o">/</span><span class="n">lowest_stable_L</span><span class="p">)</span><span class="w"> </span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">invL_nc_index</span><span class="p">)</span><span class="o">=</span><span class="mf">1.0</span><span class="o">/</span><span class="n">lowest_stable_L</span>

<span class="w">        </span><span class="c">!Put the 10 m wind vectors as the lowest grid level</span>
<span class="w">        </span><span class="c">!H_meteo=val_dim_meteo_nc(surface_level_nc,z_dim_nc_index)</span>
<span class="w">        </span><span class="n">H_meteo</span><span class="o">=</span><span class="mi">1</span><span class="mf">0.</span>
<span class="w">        </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A,f8.2)&#39;</span><span class="p">)</span><span class="s1">&#39; Alternative meteo: setting lowest meteo grid height = &#39;</span><span class="p">,</span><span class="n">H_meteo</span>
<span class="w">        </span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">ugrid_nc_index</span><span class="p">)</span><span class="o">=</span><span class="n">meteo_var4d_nc</span><span class="p">(:,:,</span><span class="n">surface_level_nc</span><span class="p">,:,</span><span class="n">u10_nc_index</span><span class="p">)</span>
<span class="w">        </span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">vgrid_nc_index</span><span class="p">)</span><span class="o">=</span><span class="n">meteo_var4d_nc</span><span class="p">(:,:,</span><span class="n">surface_level_nc</span><span class="p">,:,</span><span class="n">v10_nc_index</span><span class="p">)</span>
<span class="w">        </span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">FF10_nc_index</span><span class="p">)</span><span class="o">=</span><span class="n">meteo_var4d_nc</span><span class="p">(:,:,</span><span class="n">surface_level_nc</span><span class="p">,:,</span><span class="n">FF10_nc_index</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">FF10_nc_index</span><span class="p">))).</span><span class="n">eq</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">            </span><span class="c">!Calculate wind speed if it can&#39;t read it</span>
<span class="w">            </span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">FF10_nc_index</span><span class="p">)</span><span class="o">=</span><span class="nb">sqrt</span><span class="p">(</span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">ugrid_nc_index</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">vgrid_nc_index</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="w">        </span><span class="k">else</span>
<span class="k">            </span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">FF10_nc_index</span><span class="p">)</span><span class="o">=</span><span class="nb">sqrt</span><span class="p">(</span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">u10_nc_index</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">v10_nc_index</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="w">        </span><span class="k">endif</span>

<span class="w">        </span><span class="c">!Smooth the boundary layer height (running mean) and set minimum</span>
<span class="w">        </span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">hmix_nc_index</span><span class="p">)</span><span class="o">=</span><span class="mf">0.</span>
<span class="w">        </span><span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">y_dim_nc_index</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
<span class="w">            </span><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">x_dim_nc_index</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
<span class="w">                </span><span class="k">do </span><span class="n">jj</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span>
<span class="w">                    </span><span class="k">do </span><span class="n">ii</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span>
<span class="w">                        </span><span class="n">meteo_var3d_nc</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,:,</span><span class="n">hmix_nc_index</span><span class="p">)</span><span class="o">=</span><span class="n">meteo_var3d_nc</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,:,</span><span class="n">hmix_nc_index</span><span class="p">)</span><span class="o">+</span><span class="n">meteo_var4d_nc</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">ii</span><span class="p">,</span><span class="n">j</span><span class="o">+</span><span class="n">jj</span><span class="p">,</span><span class="n">surface_level_nc</span><span class="p">,:,</span><span class="n">hmix_nc_index</span><span class="p">)</span><span class="o">/</span><span class="mf">9.</span>
<span class="w">                        </span><span class="c">!if (ii.ne.0.and.jj.ne.0) then</span>
<span class="w">                        </span><span class="c">!    var3d_nc(i,j,:,hmix_nc_index,allsource_index)=var3d_nc(i,j,:,hmix_nc_index,allsource_index)-var3d_nc(i+ii,j+jj,:,hmix_nc_index,traffic_index)/8.</span>
<span class="w">                        </span><span class="c">!endif</span>
<span class="w">                    </span><span class="k">enddo</span>
<span class="k">                enddo</span>

<span class="k">            enddo</span>
<span class="k">        enddo</span>
<span class="k">        where</span><span class="w"> </span><span class="p">(</span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">hmix_nc_index</span><span class="p">).</span><span class="n">lt</span><span class="p">.</span><span class="n">hmix_min</span><span class="p">)</span><span class="w"> </span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">hmix_nc_index</span><span class="p">)</span><span class="o">=</span><span class="n">hmix_min</span>
<span class="w">        </span><span class="k">where</span><span class="w"> </span><span class="p">(</span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">hmix_nc_index</span><span class="p">).</span><span class="n">gt</span><span class="p">.</span><span class="n">hmix_max</span><span class="p">)</span><span class="w"> </span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">hmix_nc_index</span><span class="p">)</span><span class="o">=</span><span class="n">hmix_max</span>
<span class="w">        </span><span class="k">where</span><span class="w"> </span><span class="p">(</span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">ustar_nc_index</span><span class="p">).</span><span class="n">lt</span><span class="p">.</span><span class="n">ustar_min</span><span class="p">)</span><span class="w"> </span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">ustar_nc_index</span><span class="p">)</span><span class="o">=</span><span class="n">ustar_min</span>
<span class="w">        </span><span class="c">!do t=dim_length_nc(time_dim_nc_index),2,-1</span>
<span class="w">        </span><span class="c">!    write(*,*) t,sum(var3d_nc(:,:,t,hmix_nc_index,allsource_nc_index))/dim_length_nc(x_dim_nc_index)/dim_length_nc(y_dim_nc_index)</span>
<span class="w">        </span><span class="c">!enddo</span>

<span class="w">        </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(3A,2f16.4)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39; Alternative meteo: &#39;</span><span class="p">,</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_meteo_nc</span><span class="p">(</span><span class="n">logz0_nc_index</span><span class="p">)),</span><span class="s1">&#39; (min, max): &#39;</span><span class="p">,</span><span class="nb">minval</span><span class="p">(</span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,</span><span class="mi">1</span><span class="p">:</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">time_dim_nc_index</span><span class="p">),</span><span class="n">logz0_nc_index</span><span class="p">)),</span><span class="nb">maxval</span><span class="p">(</span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,</span><span class="mi">1</span><span class="p">:</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">time_dim_nc_index</span><span class="p">),</span><span class="n">logz0_nc_index</span><span class="p">))</span>
<span class="w">        </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(3A,2f16.4)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39; Alternative meteo: &#39;</span><span class="p">,</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_meteo_nc</span><span class="p">(</span><span class="n">ustar_nc_index</span><span class="p">)),</span><span class="s1">&#39; (min, max): &#39;</span><span class="p">,</span><span class="nb">minval</span><span class="p">(</span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,</span><span class="mi">1</span><span class="p">:</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">time_dim_nc_index</span><span class="p">),</span><span class="n">ustar_nc_index</span><span class="p">)),</span><span class="nb">maxval</span><span class="p">(</span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,</span><span class="mi">1</span><span class="p">:</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">time_dim_nc_index</span><span class="p">),</span><span class="n">ustar_nc_index</span><span class="p">))</span>
<span class="w">        </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(3A,2f16.4)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39; Alternative meteo: &#39;</span><span class="p">,</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_meteo_nc</span><span class="p">(</span><span class="n">Hflux_nc_index</span><span class="p">)),</span><span class="s1">&#39; (min, max): &#39;</span><span class="p">,</span><span class="nb">minval</span><span class="p">(</span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,</span><span class="mi">1</span><span class="p">:</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">time_dim_nc_index</span><span class="p">),</span><span class="n">Hflux_nc_index</span><span class="p">)),</span><span class="nb">maxval</span><span class="p">(</span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,</span><span class="mi">1</span><span class="p">:</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">time_dim_nc_index</span><span class="p">),</span><span class="n">Hflux_nc_index</span><span class="p">))</span>
<span class="w">        </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(3A,2f16.4)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39; Alternative meteo: &#39;</span><span class="p">,</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_meteo_nc</span><span class="p">(</span><span class="n">invL_nc_index</span><span class="p">)),</span><span class="s1">&#39; (min, max): &#39;</span><span class="p">,</span><span class="nb">minval</span><span class="p">(</span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,</span><span class="mi">1</span><span class="p">:</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">time_dim_nc_index</span><span class="p">),</span><span class="n">invL_nc_index</span><span class="p">)),</span><span class="nb">maxval</span><span class="p">(</span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,</span><span class="mi">1</span><span class="p">:</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">time_dim_nc_index</span><span class="p">),</span><span class="n">invL_nc_index</span><span class="p">))</span>
<span class="w">        </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(3A,2f16.4)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39; Alternative meteo: &#39;</span><span class="p">,</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_meteo_nc</span><span class="p">(</span><span class="n">ugrid_nc_index</span><span class="p">)),</span><span class="s1">&#39; (min, max): &#39;</span><span class="p">,</span><span class="nb">minval</span><span class="p">(</span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,</span><span class="mi">1</span><span class="p">:</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">time_dim_nc_index</span><span class="p">),</span><span class="n">ugrid_nc_index</span><span class="p">)),</span><span class="nb">maxval</span><span class="p">(</span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,</span><span class="mi">1</span><span class="p">:</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">time_dim_nc_index</span><span class="p">),</span><span class="n">ugrid_nc_index</span><span class="p">))</span>
<span class="w">        </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(3A,2f16.4)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39; Alternative meteo: &#39;</span><span class="p">,</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_meteo_nc</span><span class="p">(</span><span class="n">vgrid_nc_index</span><span class="p">)),</span><span class="s1">&#39; (min, max): &#39;</span><span class="p">,</span><span class="nb">minval</span><span class="p">(</span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,</span><span class="mi">1</span><span class="p">:</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">time_dim_nc_index</span><span class="p">),</span><span class="n">vgrid_nc_index</span><span class="p">)),</span><span class="nb">maxval</span><span class="p">(</span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,</span><span class="mi">1</span><span class="p">:</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">time_dim_nc_index</span><span class="p">),</span><span class="n">vgrid_nc_index</span><span class="p">))</span>
<span class="w">        </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(3A,2f16.4)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39; Alternative meteo: &#39;</span><span class="p">,</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_meteo_nc</span><span class="p">(</span><span class="n">FF10_nc_index</span><span class="p">)),</span><span class="s1">&#39; (min, max): &#39;</span><span class="p">,</span><span class="nb">minval</span><span class="p">(</span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,</span><span class="mi">1</span><span class="p">:</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">time_dim_nc_index</span><span class="p">),</span><span class="n">FF10_nc_index</span><span class="p">)),</span><span class="nb">maxval</span><span class="p">(</span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,</span><span class="mi">1</span><span class="p">:</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">time_dim_nc_index</span><span class="p">),</span><span class="n">FF10_nc_index</span><span class="p">))</span>
<span class="w">        </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(3A,2f16.4)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39; Alternative meteo: &#39;</span><span class="p">,</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_meteo_nc</span><span class="p">(</span><span class="n">hmix_nc_index</span><span class="p">)),</span><span class="s1">&#39; (min, max): &#39;</span><span class="p">,</span><span class="nb">minval</span><span class="p">(</span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,</span><span class="mi">1</span><span class="p">:</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">time_dim_nc_index</span><span class="p">),</span><span class="n">hmix_nc_index</span><span class="p">)),</span><span class="nb">maxval</span><span class="p">(</span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,</span><span class="mi">1</span><span class="p">:</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">time_dim_nc_index</span><span class="p">),</span><span class="n">hmix_nc_index</span><span class="p">))</span>
<span class="w">        </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(3A,2f16.4)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39; Alternative meteo: &#39;</span><span class="p">,</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_meteo_nc</span><span class="p">(</span><span class="n">t2m_nc_index</span><span class="p">)),</span><span class="s1">&#39; (min, max): &#39;</span><span class="p">,</span><span class="nb">minval</span><span class="p">(</span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,</span><span class="mi">1</span><span class="p">:</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">time_dim_nc_index</span><span class="p">),</span><span class="n">t2m_nc_index</span><span class="p">)),</span><span class="nb">maxval</span><span class="p">(</span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,</span><span class="mi">1</span><span class="p">:</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">time_dim_nc_index</span><span class="p">),</span><span class="n">t2m_nc_index</span><span class="p">))</span>


<span class="w">        </span><span class="c">!If no logz0 available. Set to log(0.1)</span>
<span class="w">        </span><span class="c">!For urban areas a value of 0.3 is used</span>
<span class="w">        </span><span class="c">!where (var3d_nc(:,:,:,logz0_nc_index,:).eq.0.0) var3d_nc(:,:,:,logz0_nc_index,:)=log(0.3)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">replace_z0</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="n">NODATA_value</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A,f8.4)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39; Replacing z0 everywhere with: &#39;</span><span class="p">,</span><span class="n">replace_z0</span>
<span class="w">            </span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">logz0_nc_index</span><span class="p">)</span><span class="o">=</span><span class="nb">log</span><span class="p">(</span><span class="n">replace_z0</span><span class="p">)</span>
<span class="w">        </span><span class="k">endif</span>
<span class="k">        if</span><span class="w"> </span><span class="p">(</span><span class="n">replace_invL</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="n">NODATA_value</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A,f8.4)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39; Replacing inverse L everywhere with: &#39;</span><span class="p">,</span><span class="n">replace_invL</span>
<span class="w">            </span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">invL_nc_index</span><span class="p">)</span><span class="o">=</span><span class="n">replace_invL</span>
<span class="w">        </span><span class="k">endif</span>
<span class="k">        if</span><span class="w"> </span><span class="p">(</span><span class="n">replace_hmix</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="n">NODATA_value</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A,f8.4)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39; Replacing HMIX everywhere with: &#39;</span><span class="p">,</span><span class="n">replace_hmix</span>
<span class="w">            </span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">hmix_nc_index</span><span class="p">)</span><span class="o">=</span><span class="n">replace_hmix</span>
<span class="w">        </span><span class="k">endif</span>
<span class="k">        if</span><span class="w"> </span><span class="p">(</span><span class="n">FF_scale</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="n">NODATA_value</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A,f8.4)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39; Rescaling wind fields everywhere with factor: &#39;</span><span class="p">,</span><span class="n">FF_scale</span>
<span class="w">            </span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">ustar_nc_index</span><span class="p">)</span><span class="o">=</span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">ustar_nc_index</span><span class="p">)</span><span class="o">*</span><span class="n">FF_scale</span>
<span class="w">            </span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">FF10_nc_index</span><span class="p">)</span><span class="o">=</span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">FF10_nc_index</span><span class="p">)</span><span class="o">*</span><span class="n">FF_scale</span>
<span class="w">            </span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">inv_FF10_nc_index</span><span class="p">)</span><span class="o">=</span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">inv_FF10_nc_index</span><span class="p">)</span><span class="o">/</span><span class="n">FF_scale</span>
<span class="w">            </span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">ugrid_nc_index</span><span class="p">)</span><span class="o">=</span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">ugrid_nc_index</span><span class="p">)</span><span class="o">*</span><span class="n">FF_scale</span>
<span class="w">            </span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">vgrid_nc_index</span><span class="p">)</span><span class="o">=</span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">vgrid_nc_index</span><span class="p">)</span><span class="o">*</span><span class="n">FF_scale</span>
<span class="w">            </span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">inv_FFgrid_nc_index</span><span class="p">)</span><span class="o">=</span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">inv_FFgrid_nc_index</span><span class="p">)</span><span class="o">/</span><span class="n">FF_scale</span>
<span class="w">            </span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">ugrid_nc_index</span><span class="p">)</span><span class="o">=</span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">ugrid_nc_index</span><span class="p">)</span><span class="o">*</span><span class="n">FF_scale</span>
<span class="w">            </span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">vgrid_nc_index</span><span class="p">)</span><span class="o">=</span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">vgrid_nc_index</span><span class="p">)</span><span class="o">*</span><span class="n">FF_scale</span>
<span class="w">        </span><span class="k">endif</span>
<span class="k">        if</span><span class="w"> </span><span class="p">(</span><span class="n">FF10_offset</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="n">NODATA_value</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A,f8.4)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39; Offsetting 10 m wind fields everywhere with a value: &#39;</span><span class="p">,</span><span class="n">FF10_offset</span>
<span class="w">            </span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">FF10_nc_index</span><span class="p">)</span><span class="o">=</span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">FF10_nc_index</span><span class="p">)</span><span class="o">+</span><span class="n">FF10_offset</span>
<span class="w">        </span><span class="k">endif</span>
<span class="k">        if</span><span class="w"> </span><span class="p">(</span><span class="n">DD_offset</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="n">NODATA_value</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A,f8.4)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39; Rotating wind fields everywhere with a value: &#39;</span><span class="p">,</span><span class="n">DD_offset</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="nb">allocated</span><span class="p">(</span><span class="n">temp_meteo_var3d_nc</span><span class="p">))</span><span class="w"> </span><span class="k">allocate</span><span class="w"> </span><span class="p">(</span><span class="n">temp_meteo_var3d_nc</span><span class="p">(</span><span class="n">valid_dim_length_meteo_nc</span><span class="p">(</span><span class="n">x_dim_nc_index</span><span class="p">),</span><span class="n">valid_dim_length_meteo_nc</span><span class="p">(</span><span class="n">y_dim_nc_index</span><span class="p">),</span><span class="n">valid_dim_length_meteo_nc</span><span class="p">(</span><span class="n">time_dim_nc_index</span><span class="p">),</span><span class="mi">2</span><span class="p">))</span>
<span class="w">            </span><span class="n">temp_meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">ugrid_nc_index</span><span class="p">)</span><span class="o">*</span><span class="nb">cos</span><span class="p">(</span><span class="n">DD_offset</span><span class="o">/</span><span class="mi">18</span><span class="mf">0.</span><span class="o">*</span><span class="mf">3.14159</span><span class="p">)</span><span class="o">+</span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">vgrid_nc_index</span><span class="p">)</span><span class="o">*</span><span class="nb">sin</span><span class="p">(</span><span class="n">DD_offset</span><span class="o">/</span><span class="mi">18</span><span class="mf">0.</span><span class="o">*</span><span class="mf">3.14159</span><span class="p">)</span>
<span class="w">            </span><span class="n">temp_meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">=-</span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">ugrid_nc_index</span><span class="p">)</span><span class="o">*</span><span class="nb">sin</span><span class="p">(</span><span class="n">DD_offset</span><span class="o">/</span><span class="mi">18</span><span class="mf">0.</span><span class="o">*</span><span class="mf">3.14159</span><span class="p">)</span><span class="o">+</span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">vgrid_nc_index</span><span class="p">)</span><span class="o">*</span><span class="nb">cos</span><span class="p">(</span><span class="n">DD_offset</span><span class="o">/</span><span class="mi">18</span><span class="mf">0.</span><span class="o">*</span><span class="mf">3.14159</span><span class="p">)</span>
<span class="w">            </span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">ugrid_nc_index</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">temp_meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="mi">1</span><span class="p">)</span>
<span class="w">            </span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">vgrid_nc_index</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">temp_meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="mi">2</span><span class="p">)</span>
<span class="w">        </span><span class="k">endif</span>

<span class="w">        </span><span class="c">!Set the magnitude of the gridded wind fields. Should probably be done after subgridding?</span>
<span class="w">        </span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">FFgrid_nc_index</span><span class="p">)</span><span class="o">=</span><span class="nb">sqrt</span><span class="p">(</span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">ugrid_nc_index</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">meteo_var3d_nc</span><span class="p">(:,:,:,</span><span class="n">vgrid_nc_index</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

<span class="w">        </span><span class="c">!Check meteo time which comes in seconds since 1970. Converts to days.</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">use_alternative_meteorology_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            </span><span class="n">date_num_temp</span><span class="o">=</span><span class="n">val_dim_meteo_nc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">time_dim_nc_index</span><span class="p">)</span><span class="o">/</span><span class="mi">360</span><span class="mf">0.</span><span class="o">/</span><span class="mi">2</span><span class="mf">4.</span><span class="o">+</span><span class="mi">3</span><span class="mf">0.</span><span class="o">/</span><span class="mi">2</span><span class="mf">4.</span><span class="o">/</span><span class="mi">360</span><span class="mf">0.</span>
<span class="w">            </span><span class="k">call </span><span class="n">number_to_date</span><span class="p">(</span><span class="n">date_num_temp</span><span class="p">,</span><span class="n">date_array</span><span class="p">,</span><span class="n">ref_year_meteo</span><span class="p">)</span>
<span class="w">            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,i6)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39; Time dimension meteo: &#39;</span><span class="p">,</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">time_dim_nc_index</span><span class="p">)</span>
<span class="w">            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,6i6)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39; Date start meteo = &#39;</span><span class="p">,</span><span class="n">date_array</span>
<span class="w">            </span><span class="c">!date_num_temp=dble(ceiling(val_dim_meteo_nc(dim_length_meteo_nc(time_dim_nc_index),time_dim_nc_index)/3600.))/24.</span>
<span class="w">            </span><span class="n">date_num_temp</span><span class="o">=</span><span class="n">val_dim_meteo_nc</span><span class="p">(</span><span class="n">dim_length_meteo_nc</span><span class="p">(</span><span class="n">time_dim_nc_index</span><span class="p">),</span><span class="n">time_dim_nc_index</span><span class="p">)</span><span class="o">/</span><span class="mi">360</span><span class="mf">0.</span><span class="o">/</span><span class="mi">2</span><span class="mf">4.</span><span class="o">+</span><span class="mi">3</span><span class="mf">0.</span><span class="o">/</span><span class="mi">2</span><span class="mf">4.</span><span class="o">/</span><span class="mi">360</span><span class="mf">0.</span>
<span class="w">            </span><span class="k">call </span><span class="n">number_to_date</span><span class="p">(</span><span class="n">date_num_temp</span><span class="p">,</span><span class="n">date_array</span><span class="p">,</span><span class="n">ref_year_meteo</span><span class="p">)</span>
<span class="w">            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,6i6)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39; Date end meteo =   &#39;</span><span class="p">,</span><span class="n">date_array</span>
<span class="w">            </span><span class="c">!write(*,*) start_time_meteo_nc_index,valid_dim_length_meteo_nc(time_dim_nc_index)</span>
<span class="w">        </span><span class="k">endif</span>
<span class="w">        </span><span class="c">!do t=1,dim_length_meteo_nc(time_dim_nc_index)</span>
<span class="w">        </span><span class="c">!    date_num_temp=val_dim_meteo_nc(t,time_dim_nc_index)/3600./24.+0.1/24.</span>
<span class="w">        </span><span class="c">!    call number_to_date(date_num_temp,date_array,ref_year_meteo)</span>
<span class="w">        </span><span class="c">!    write(unit_logfile,&#39;(a,i4,6i6,f12.4)&#39;) &#39; Date end meteo =   &#39;,t,date_array,date_num_temp</span>
<span class="w">        </span><span class="c">!enddo</span>
<span class="w">        </span><span class="c">!stop</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">var1d_nc_dp</span><span class="p">))</span><span class="w"> </span><span class="k">deallocate</span><span class="w"> </span><span class="p">(</span><span class="n">var1d_nc_dp</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">var2d_nc_dp</span><span class="p">))</span><span class="w"> </span><span class="k">deallocate</span><span class="w"> </span><span class="p">(</span><span class="n">var2d_nc_dp</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">temp_meteo_var3d_nc</span><span class="p">))</span><span class="w"> </span><span class="k">deallocate</span><span class="w"> </span><span class="p">(</span><span class="n">temp_meteo_var3d_nc</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">meteo_var4d_nc</span><span class="p">))</span><span class="w"> </span><span class="k">deallocate</span><span class="w"> </span><span class="p">(</span><span class="n">meteo_var4d_nc</span><span class="p">)</span>

<span class="w">    </span><span class="k">end subroutine </span><span class="n">uEMEP_read_meteo_nc</span>
</pre></div>

    </section>
    <br>
    
    </div>
  </div>

      <hr>
    </div> <!-- /container -->
    <footer>
      <div class="container">
        <div class="row justify-content-between">
          <div class="col">
            <p>
              uEMEP
              &copy; 2024 
</p>
          </div>
          <div class="col">
            <p class="text-end">
              Documentation generated by
              <a href="https://github.com/Fortran-FOSS-Programmers/ford">FORD</a>
            </p>
          </div>
        </div>
        <br>
      </div> <!-- /container -->
    </footer>

    <!-- Bootstrap core JavaScript -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>    

    <!-- MathJax JavaScript
             ================================================== -->
             <!-- Placed at the end of the document so the pages load faster -->
        <script type="text/x-mathjax-config">
          MathJax.Hub.Config({
          TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } },
          jax: ['input/TeX','input/MathML','output/HTML-CSS'],
          extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']
          });
        </script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

          <script src="../tipuesearch/tipuesearch_content.js"></script>
          <script src="../tipuesearch/tipuesearch_set.js"></script>
          <script src="../tipuesearch/tipuesearch.js"></script>

  </body>
</html>
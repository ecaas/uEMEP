<!-- -*- mode: jinja2 -*- -->

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
      <meta name="description" content="Air quality dispersion model for high resolution downscaling of EMEP-MSC-W">
    <meta name="author" content="Norwegian Meteorological Institute" >
    <link rel="icon" href="../favicon.png">

    <title>uEMEP_save_netcdf_control &ndash; uEMEP</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link href="../css/pygments.css" rel="stylesheet">
    <link href="../css/font-awesome.min.css" rel="stylesheet">
    <link href="../css/local.css" rel="stylesheet">
      <link  href="../tipuesearch/tipuesearch.css" rel="stylesheet">

    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="../js/svg-pan-zoom.min.js"></script>
  </head>

  <body>

    <!-- Fixed navbar -->
    <div class="container-fluid mb-sm-4 mb-xl-2">
      <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container">
          <a class="navbar-brand" href="../index.html">uEMEP <small>7.0.0</small></a>
          <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar"
                  aria-expanded="false" aria-controls="navbar" aria-label="Toggle navigation">
                  <span class="navbar-toggler-icon">
          </button>

          <div id="navbar" class="navbar-collapse collapse">
            <ul class="navbar-nav">
                <li class="nav-item"><a class="nav-link" href="../page/index.html">Documentation</a></li>
                  <li class="nav-item">
                    <a class="nav-link" href="../lists/files.html">Source Files</a>
                  </li>
                <li class="nav-item">
                  <a class="nav-link" href="../lists/modules.html">Modules</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="../lists/procedures.html">Procedures</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="../program/uemep_v6.html">Program</a>
                </li>
            </ul>
              <div class="d-flex align-items-end flex-grow-1">
                <form action="../search.html" role="search" class="ms-auto">
                  <input type="text" class="form-control" aria-label="Search" placeholder="Search" name="q" id="tipue_search_input" autocomplete="off" required>
                </form>
              </div>
          </div><!--/.nav-collapse -->
        </div>
      </nav>
    </div>

    <div class="container">
  <div class="row">
    <h1>uEMEP_save_netcdf_control
      <small>Subroutine</small>
      
    </h1>
      <div class="container p-2 mb-4 bg-light border rounded-3">
    <div class="row align-items-center justify-content-between" id="info-bar">
      <div class="col">
        <ul class="list-inline" style="margin-bottom:0px;display:inline">

            <li class="list-inline-item" id="statements"><i class="fa fa-list-ol"></i>
              <a data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-html="true"
                 title=" 7.0% of total for procedures.">1390 statements</a>
            </li>

            <li class="list-inline-item" id="source-file">
              <i class="fa fa-code"></i>
              <a href="../src/uEMEP_save_netcdf_file.f90"> Source File</a>
            </li>
        </ul>
      </div>
      <div class="col">
        <nav aria-label="breadcrumb">
          <ol class="breadcrumb justify-content-end mb-0">
                <li class="breadcrumb-item"><a href='../sourcefile/uemep_save_netcdf_file.f90.html'>uEMEP_save_netcdf_file.f90</a></li>
                <li class="breadcrumb-item"><a href='../module/save_netcdf_file.html'>save_netcdf_file</a></li>
            <li class="breadcrumb-item active" aria-current="page">uEMEP_save_netcdf_control</li>
          </ol>
        </nav>
      </div>
    </div>
  </div>
  <script>
    $(function () {
    $('[data-bs-toggle="tooltip"]').tooltip()
    })
  </script>

  </div>
  
  <div class="row">
    <div class="col-md-3 hidden-xs hidden-sm visible-md visible-lg">
      <div id="sidebar">
      <h3>Contents</h3>
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
    <div class="card card-primary">
      <div class="card-header text-left"><h3 class="card-title">Source Code</h3></div>
      <div class="list-group">
        <a class="list-group-item" href="../proc/uemep_save_netcdf_control.html#src">uEMEP_save_netcdf_control</a>
      </div>
    </div>


  </div>

    </div>
    
    <div class="col-md-9" id='text'>
    <h2>public  subroutine uEMEP_save_netcdf_control()  
</h2>
        <div class="card mb-4">
      <h3 class="card-header card-title bg-light">Uses</h3>
      <div class="card-body">
        <ul class="list-group list-group-flush">
            <li class="list-group-item">
              <ul class="list-inline">
                  <li class="list-inline-item"><a href='../module/uemep_definitions.html'>uEMEP_definitions</a></li>
              </ul>
            </li>
            <li class="list-group-item">
              <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.43.0 (0)
 -->
<!-- Title: proc~~uemep_save_netcdf_control~~UsesGraph Pages: 1 -->
<svg id="procuemep_save_netcdf_controlUsesGraph" width="312pt" height="32pt"
 viewBox="0.00 0.00 312.00 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="proc~~uemep_save_netcdf_control~~UsesGraph" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>proc~~uemep_save_netcdf_control~~UsesGraph</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-28 308,-28 308,4 -4,4"/>
<!-- proc~uemep_save_netcdf_control -->
<g id="proc~~uemep_save_netcdf_control~~UsesGraph_node1" class="node">
<title>proc~uemep_save_netcdf_control</title>
<polygon fill="none" stroke="black" points="304,-24 145,-24 145,0 304,0 304,-24"/>
<text text-anchor="middle" x="224.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50">uEMEP_save_netcdf_control</text>
</g>
<!-- module~uemep_definitions -->
<g id="proc~~uemep_save_netcdf_control~~UsesGraph_node2" class="node">
<title>module~uemep_definitions</title>
<g id="a_proc~~uemep_save_netcdf_control~~UsesGraph_node2"><a xlink:href="../module/uemep_definitions.html" xlink:title="uEMEP_definitions">
<polygon fill="#337ab7" stroke="#337ab7" points="109,-24 0,-24 0,0 109,0 109,-24"/>
<text text-anchor="middle" x="54.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">uEMEP_definitions</text>
</a>
</g>
</g>
<!-- proc~uemep_save_netcdf_control&#45;&gt;module~uemep_definitions -->
<g id="proc~~uemep_save_netcdf_control~~UsesGraph_edge1" class="edge">
<title>proc~uemep_save_netcdf_control&#45;&gt;module~uemep_definitions</title>
<path fill="none" stroke="#000000" stroke-dasharray="5,2" d="M144.91,-12C136.29,-12 127.59,-12 119.18,-12"/>
<polygon fill="#000000" stroke="#000000" points="119.09,-8.5 109.09,-12 119.09,-15.5 119.09,-8.5"/>
</g>
</g>
</svg>
</div>          <div>
            <a type="button" class="graph-help" data-bs-toggle="modal" href="#UsesGraph-help-text">Help</a>
          </div>
          <div class="modal fade" id="UsesGraph-help-text" tabindex="-1" role="dialog">
            <div class="modal-dialog modal-lg" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h4 class="modal-title" id="-graph-help-label">Graph Key</h4>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
<p>Nodes of different colours represent the following: </p>
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.43.0 (0)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="518pt" height="32pt"
 viewBox="0.00 0.00 517.50 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-28 513.5,-28 513.5,4 -4,4"/>
<!-- Module -->
<g id="node1" class="node">
<title>Module</title>
<polygon fill="#337ab7" stroke="#337ab7" points="54,-24 0,-24 0,0 54,0 54,-24"/>
<text text-anchor="middle" x="27" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Module</text>
</g>
<!-- Submodule -->
<g id="node2" class="node">
<title>Submodule</title>
<polygon fill="#5bc0de" stroke="#5bc0de" points="145.5,-24 72.5,-24 72.5,0 145.5,0 145.5,-24"/>
<text text-anchor="middle" x="109" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Submodule</text>
</g>
<!-- Subroutine -->
<g id="node3" class="node">
<title>Subroutine</title>
<polygon fill="#d9534f" stroke="#d9534f" points="234,-24 164,-24 164,0 234,0 234,-24"/>
<text text-anchor="middle" x="199" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Subroutine</text>
</g>
<!-- Function -->
<g id="node4" class="node">
<title>Function</title>
<polygon fill="#d94e8f" stroke="#d94e8f" points="310,-24 252,-24 252,0 310,0 310,-24"/>
<text text-anchor="middle" x="281" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Function</text>
</g>
<!-- Program -->
<g id="node5" class="node">
<title>Program</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="386,-24 328,-24 328,0 386,0 386,-24"/>
<text text-anchor="middle" x="357" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Program</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node6" class="node">
<title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="black" points="509.5,-24 404.5,-24 404.5,0 509.5,0 509.5,-24"/>
<text text-anchor="middle" x="457" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50">This Page&#39;s Entity</text>
</g>
</g>
</svg>

<p>Solid arrows point from a submodule to the (sub)module which it is
descended from. Dashed arrows point from a module or program unit to 
modules which it uses.
</p>
 </div>
            </div>
          </div>
        </div>
            </li>
        </ul>
      </div>
    </div>


    <p>.or. use_region_select_and_mask_flag ??
!!!!! what to write here???</p>


    <h3>Arguments</h3>
    <em>None</em>
    <br>
    <br>
    <div class="card">
      <div class="card-header">
  <h3 class="card-title">Calls</h3>
      </div>
      <div class="card-body">
  <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.43.0 (0)
 -->
<!-- Title: proc~~uemep_save_netcdf_control~~CallsGraph Pages: 1 -->
<svg id="procuemep_save_netcdf_controlCallsGraph" width="641pt" height="769pt"
 viewBox="0.00 0.00 641.00 768.86" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="proc~~uemep_save_netcdf_control~~CallsGraph" class="graph" transform="scale(0.84 0.84) rotate(0) translate(4 910)">
<title>proc~~uemep_save_netcdf_control~~CallsGraph</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-910 758,-910 758,4 -4,4"/>
<!-- proc~uemep_save_netcdf_control -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_node1" class="node">
<title>proc~uemep_save_netcdf_control</title>
<polygon fill="none" stroke="black" points="159,-591 0,-591 0,-567 159,-567 159,-591"/>
<text text-anchor="middle" x="79.5" y="-576.6" font-family="Helvetica,sans-Serif" font-size="10.50">uEMEP_save_netcdf_control</text>
</g>
<!-- proc~direction -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_node2" class="node">
<title>proc~direction</title>
<g id="a_proc~~uemep_save_netcdf_control~~CallsGraph_node2"><a xlink:href="../proc/direction.html" xlink:title="DIRECTION">
<polygon fill="#d94e8f" stroke="#d94e8f" points="327,-696 256,-696 256,-672 327,-672 327,-696"/>
<text text-anchor="middle" x="291.5" y="-681.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">DIRECTION</text>
</a>
</g>
</g>
<!-- proc~uemep_save_netcdf_control&#45;&gt;proc~direction -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_edge1" class="edge">
<title>proc~uemep_save_netcdf_control&#45;&gt;proc~direction</title>
<path fill="none" stroke="#000000" d="M93.09,-591.06C113.05,-609.47 153.89,-644.41 195,-663 210.88,-670.18 229.39,-674.98 245.86,-678.15"/>
<polygon fill="#000000" stroke="#000000" points="245.35,-681.62 255.81,-679.93 246.58,-674.73 245.35,-681.62"/>
</g>
<!-- proc~mean_mask -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_node3" class="node">
<title>proc~mean_mask</title>
<g id="a_proc~~uemep_save_netcdf_control~~CallsGraph_node3"><a xlink:href="../proc/mean_mask.html" xlink:title="mean_mask">
<polygon fill="#d94e8f" stroke="#d94e8f" points="330,-654 253,-654 253,-630 330,-630 330,-654"/>
<text text-anchor="middle" x="291.5" y="-639.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">mean_mask</text>
</a>
</g>
</g>
<!-- proc~uemep_save_netcdf_control&#45;&gt;proc~mean_mask -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_edge2" class="edge">
<title>proc~uemep_save_netcdf_control&#45;&gt;proc~mean_mask</title>
<path fill="none" stroke="#000000" d="M110.26,-591.18C133.16,-600.24 165.73,-612.46 195,-621 210.37,-625.49 227.38,-629.52 242.74,-632.82"/>
<polygon fill="#000000" stroke="#000000" points="242.05,-636.25 252.56,-634.88 243.49,-629.4 242.05,-636.25"/>
</g>
<!-- proc~uemep_save_netcdf_file -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_node4" class="node">
<title>proc~uemep_save_netcdf_file</title>
<g id="a_proc~~uemep_save_netcdf_control~~CallsGraph_node4"><a xlink:href="../proc/uemep_save_netcdf_file.html" xlink:title="uEMEP_save_netcdf_file">
<polygon fill="#d9534f" stroke="#d9534f" points="361,-570 222,-570 222,-546 361,-546 361,-570"/>
<text text-anchor="middle" x="291.5" y="-555.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">uEMEP_save_netcdf_file</text>
</a>
</g>
</g>
<!-- proc~uemep_save_netcdf_control&#45;&gt;proc~uemep_save_netcdf_file -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_edge3" class="edge">
<title>proc~uemep_save_netcdf_control&#45;&gt;proc~uemep_save_netcdf_file</title>
<path fill="none" stroke="#000000" d="M159.29,-571.12C176.51,-569.4 194.74,-567.58 211.95,-565.86"/>
<polygon fill="#000000" stroke="#000000" points="212.35,-569.33 221.95,-564.85 211.65,-562.37 212.35,-569.33"/>
</g>
<!-- proc~uemep_save_netcdf_receptor_file -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_node5" class="node">
<title>proc~uemep_save_netcdf_receptor_file</title>
<g id="a_proc~~uemep_save_netcdf_control~~CallsGraph_node5"><a xlink:href="../proc/uemep_save_netcdf_receptor_file.html" xlink:title="uEMEP_save_netcdf_receptor_file">
<polygon fill="#d9534f" stroke="#d9534f" points="386,-612 197,-612 197,-588 386,-588 386,-612"/>
<text text-anchor="middle" x="291.5" y="-597.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">uEMEP_save_netcdf_receptor_file</text>
</a>
</g>
</g>
<!-- proc~uemep_save_netcdf_control&#45;&gt;proc~uemep_save_netcdf_receptor_file -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_edge4" class="edge">
<title>proc~uemep_save_netcdf_control&#45;&gt;proc~uemep_save_netcdf_receptor_file</title>
<path fill="none" stroke="#000000" d="M159.29,-586.88C168.27,-587.78 177.52,-588.7 186.75,-589.62"/>
<polygon fill="#000000" stroke="#000000" points="186.45,-593.11 196.75,-590.63 187.15,-586.15 186.45,-593.11"/>
</g>
<!-- proc~uemep_source_fraction_chemistry -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_node6" class="node">
<title>proc~uemep_source_fraction_chemistry</title>
<g id="a_proc~~uemep_save_netcdf_control~~CallsGraph_node6"><a xlink:href="../proc/uemep_source_fraction_chemistry.html" xlink:title="uEMEP_source_fraction_chemistry">
<polygon fill="#d9534f" stroke="#d9534f" points="388,-171 195,-171 195,-147 388,-147 388,-171"/>
<text text-anchor="middle" x="291.5" y="-156.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">uEMEP_source_fraction_chemistry</text>
</a>
</g>
</g>
<!-- proc~uemep_save_netcdf_control&#45;&gt;proc~uemep_source_fraction_chemistry -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_edge5" class="edge">
<title>proc~uemep_save_netcdf_control&#45;&gt;proc~uemep_source_fraction_chemistry</title>
<path fill="none" stroke="#000000" d="M86.56,-566.88C115.78,-508.44 242.27,-255.45 279.9,-180.19"/>
<polygon fill="#000000" stroke="#000000" points="283.08,-181.68 284.42,-171.17 276.81,-178.55 283.08,-181.68"/>
</g>
<!-- proc~write_esri_ascii_file -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_node7" class="node">
<title>proc~write_esri_ascii_file</title>
<g id="a_proc~~uemep_save_netcdf_control~~CallsGraph_node7"><a xlink:href="../proc/write_esri_ascii_file.html" xlink:title="write_esri_ascii_file">
<polygon fill="#d9534f" stroke="#d9534f" points="349,-129 234,-129 234,-105 349,-105 349,-129"/>
<text text-anchor="middle" x="291.5" y="-114.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">write_esri_ascii_file</text>
</a>
</g>
</g>
<!-- proc~uemep_save_netcdf_control&#45;&gt;proc~write_esri_ascii_file -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_edge6" class="edge">
<title>proc~uemep_save_netcdf_control&#45;&gt;proc~write_esri_ascii_file</title>
<path fill="none" stroke="#000000" d="M81.93,-567C89.79,-502.81 129.91,-200.69 195,-138 202.96,-130.34 213.04,-125.21 223.65,-121.83"/>
<polygon fill="#000000" stroke="#000000" points="224.75,-125.16 233.51,-119.19 222.94,-118.4 224.75,-125.16"/>
</g>
<!-- nf90_close -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_node8" class="node">
<title>nf90_close</title>
<polygon fill="#777777" stroke="#777777" points="565.5,-570 495.5,-570 495.5,-546 565.5,-546 565.5,-570"/>
<text text-anchor="middle" x="530.5" y="-555.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">nf90_close</text>
</g>
<!-- proc~uemep_save_netcdf_file&#45;&gt;nf90_close -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_edge7" class="edge">
<title>proc~uemep_save_netcdf_file&#45;&gt;nf90_close</title>
<path fill="none" stroke="#000000" d="M361.05,-558C400.94,-558 450.08,-558 484.97,-558"/>
<polygon fill="#000000" stroke="#000000" points="485.31,-561.5 495.31,-558 485.31,-554.5 485.31,-561.5"/>
</g>
<!-- nf90_create -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_node9" class="node">
<title>nf90_create</title>
<polygon fill="#777777" stroke="#777777" points="568.5,-528 492.5,-528 492.5,-504 568.5,-504 568.5,-528"/>
<text text-anchor="middle" x="530.5" y="-513.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">nf90_create</text>
</g>
<!-- proc~uemep_save_netcdf_file&#45;&gt;nf90_create -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_edge8" class="edge">
<title>proc~uemep_save_netcdf_file&#45;&gt;nf90_create</title>
<path fill="none" stroke="#000000" d="M360.41,-545.96C399.51,-539.04 447.64,-530.51 482.54,-524.32"/>
<polygon fill="#000000" stroke="#000000" points="483.23,-527.75 492.47,-522.56 482.01,-520.86 483.23,-527.75"/>
</g>
<!-- nf90_def_dim -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_node10" class="node">
<title>nf90_def_dim</title>
<polygon fill="#777777" stroke="#777777" points="573,-486 488,-486 488,-462 573,-462 573,-486"/>
<text text-anchor="middle" x="530.5" y="-471.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">nf90_def_dim</text>
</g>
<!-- proc~uemep_save_netcdf_file&#45;&gt;nf90_def_dim -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_edge9" class="edge">
<title>proc~uemep_save_netcdf_file&#45;&gt;nf90_def_dim</title>
<path fill="none" stroke="#000000" d="M313.68,-545.8C339.1,-531.65 383.41,-508.52 424,-495 441.18,-489.28 460.48,-484.87 477.83,-481.62"/>
<polygon fill="#000000" stroke="#000000" points="478.57,-485.04 487.79,-479.83 477.33,-478.15 478.57,-485.04"/>
</g>
<!-- nf90_def_var -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_node11" class="node">
<title>nf90_def_var</title>
<polygon fill="#777777" stroke="#777777" points="571.5,-444 489.5,-444 489.5,-420 571.5,-420 571.5,-444"/>
<text text-anchor="middle" x="530.5" y="-429.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">nf90_def_var</text>
</g>
<!-- proc~uemep_save_netcdf_file&#45;&gt;nf90_def_var -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_edge10" class="edge">
<title>proc~uemep_save_netcdf_file&#45;&gt;nf90_def_var</title>
<path fill="none" stroke="#000000" d="M303.84,-545.68C325.1,-523.39 373.4,-476.52 424,-453 441.14,-445.03 461.21,-440.08 479.23,-437.01"/>
<polygon fill="#000000" stroke="#000000" points="479.93,-440.44 489.27,-435.45 478.85,-433.53 479.93,-440.44"/>
</g>
<!-- nf90_def_var_chunking -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_node12" class="node">
<title>nf90_def_var_chunking</title>
<polygon fill="#777777" stroke="#777777" points="598.5,-318 462.5,-318 462.5,-294 598.5,-294 598.5,-318"/>
<text text-anchor="middle" x="530.5" y="-303.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">nf90_def_var_chunking</text>
</g>
<!-- proc~uemep_save_netcdf_file&#45;&gt;nf90_def_var_chunking -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_edge11" class="edge">
<title>proc~uemep_save_netcdf_file&#45;&gt;nf90_def_var_chunking</title>
<path fill="none" stroke="#000000" d="M295.56,-545.78C306.01,-506.8 344.09,-384.64 424,-327 432.49,-320.87 442.33,-316.42 452.51,-313.21"/>
<polygon fill="#000000" stroke="#000000" points="453.64,-316.53 462.34,-310.49 451.77,-309.78 453.64,-316.53"/>
</g>
<!-- nf90_def_var_deflate -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_node13" class="node">
<title>nf90_def_var_deflate</title>
<polygon fill="#777777" stroke="#777777" points="592.5,-276 468.5,-276 468.5,-252 592.5,-252 592.5,-276"/>
<text text-anchor="middle" x="530.5" y="-261.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">nf90_def_var_deflate</text>
</g>
<!-- proc~uemep_save_netcdf_file&#45;&gt;nf90_def_var_deflate -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_edge12" class="edge">
<title>proc~uemep_save_netcdf_file&#45;&gt;nf90_def_var_deflate</title>
<path fill="none" stroke="#000000" d="M294.44,-545.79C302.02,-502.46 333.76,-354.92 424,-285 433.96,-277.28 446,-272.18 458.32,-268.84"/>
<polygon fill="#000000" stroke="#000000" points="459.3,-272.2 468.24,-266.52 457.71,-265.39 459.3,-272.2"/>
</g>
<!-- nf90_enddef -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_node14" class="node">
<title>nf90_enddef</title>
<polygon fill="#777777" stroke="#777777" points="570,-402 491,-402 491,-378 570,-378 570,-402"/>
<text text-anchor="middle" x="530.5" y="-387.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">nf90_enddef</text>
</g>
<!-- proc~uemep_save_netcdf_file&#45;&gt;nf90_enddef -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_edge13" class="edge">
<title>proc~uemep_save_netcdf_file&#45;&gt;nf90_enddef</title>
<path fill="none" stroke="#000000" d="M299.57,-545.71C316.78,-516.99 363.93,-445.29 424,-411 441.11,-401.23 462.02,-395.95 480.71,-393.11"/>
<polygon fill="#000000" stroke="#000000" points="481.37,-396.56 490.82,-391.78 480.45,-389.62 481.37,-396.56"/>
</g>
<!-- nf90_inq_dimid -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_node15" class="node">
<title>nf90_inq_dimid</title>
<polygon fill="#777777" stroke="#777777" points="577.5,-360 483.5,-360 483.5,-336 577.5,-336 577.5,-360"/>
<text text-anchor="middle" x="530.5" y="-345.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">nf90_inq_dimid</text>
</g>
<!-- proc~uemep_save_netcdf_file&#45;&gt;nf90_inq_dimid -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_edge14" class="edge">
<title>proc~uemep_save_netcdf_file&#45;&gt;nf90_inq_dimid</title>
<path fill="none" stroke="#000000" d="M297.1,-545.86C310.69,-511.78 354.1,-414.76 424,-369 438.43,-359.55 456.17,-354.19 472.96,-351.19"/>
<polygon fill="#000000" stroke="#000000" points="473.9,-354.59 483.26,-349.62 472.84,-347.67 473.9,-354.59"/>
</g>
<!-- nf90_inq_varid -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_node16" class="node">
<title>nf90_inq_varid</title>
<polygon fill="#777777" stroke="#777777" points="576,-864 485,-864 485,-840 576,-840 576,-864"/>
<text text-anchor="middle" x="530.5" y="-849.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">nf90_inq_varid</text>
</g>
<!-- proc~uemep_save_netcdf_file&#45;&gt;nf90_inq_varid -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_edge15" class="edge">
<title>proc~uemep_save_netcdf_file&#45;&gt;nf90_inq_varid</title>
<path fill="none" stroke="#000000" d="M361.09,-562.44C371.25,-565.91 380.72,-571.16 388,-579 464.96,-661.93 346.21,-748.85 424,-831 437,-844.73 456.22,-850.88 474.71,-853.31"/>
<polygon fill="#000000" stroke="#000000" points="474.57,-856.81 484.86,-854.29 475.24,-849.84 474.57,-856.81"/>
</g>
<!-- nf90_inquire_dimension -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_node17" class="node">
<title>nf90_inquire_dimension</title>
<polygon fill="#777777" stroke="#777777" points="600,-822 461,-822 461,-798 600,-798 600,-822"/>
<text text-anchor="middle" x="530.5" y="-807.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">nf90_inquire_dimension</text>
</g>
<!-- proc~uemep_save_netcdf_file&#45;&gt;nf90_inquire_dimension -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_edge16" class="edge">
<title>proc~uemep_save_netcdf_file&#45;&gt;nf90_inquire_dimension</title>
<path fill="none" stroke="#000000" d="M361.39,-562.78C371.38,-566.23 380.73,-571.39 388,-579 453.38,-647.5 357.94,-721.15 424,-789 431.45,-796.66 440.85,-801.94 450.94,-805.53"/>
<polygon fill="#000000" stroke="#000000" points="450.2,-808.96 460.79,-808.47 452.21,-802.25 450.2,-808.96"/>
</g>
<!-- nf90_open -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_node18" class="node">
<title>nf90_open</title>
<polygon fill="#777777" stroke="#777777" points="565,-780 496,-780 496,-756 565,-756 565,-780"/>
<text text-anchor="middle" x="530.5" y="-765.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">nf90_open</text>
</g>
<!-- proc~uemep_save_netcdf_file&#45;&gt;nf90_open -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_edge17" class="edge">
<title>proc~uemep_save_netcdf_file&#45;&gt;nf90_open</title>
<path fill="none" stroke="#000000" d="M361.12,-563.05C371.15,-566.46 380.58,-571.54 388,-579 441.85,-633.14 369.61,-693.4 424,-747 440,-762.77 464.27,-768.36 485.49,-769.85"/>
<polygon fill="#000000" stroke="#000000" points="485.48,-773.35 495.62,-770.28 485.77,-766.36 485.48,-773.35"/>
</g>
<!-- nf90_put_att -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_node19" class="node">
<title>nf90_put_att</title>
<polygon fill="#777777" stroke="#777777" points="570,-738 491,-738 491,-714 570,-714 570,-738"/>
<text text-anchor="middle" x="530.5" y="-723.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">nf90_put_att</text>
</g>
<!-- proc~uemep_save_netcdf_file&#45;&gt;nf90_put_att -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_edge18" class="edge">
<title>proc~uemep_save_netcdf_file&#45;&gt;nf90_put_att</title>
<path fill="none" stroke="#000000" d="M361.18,-563.65C371.08,-567 380.45,-571.91 388,-579 430.44,-618.89 381.17,-665.54 424,-705 439.2,-719.01 460.99,-724.83 480.82,-726.92"/>
<polygon fill="#000000" stroke="#000000" points="480.72,-730.43 490.96,-727.7 481.26,-723.45 480.72,-730.43"/>
</g>
<!-- nf90_put_var -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_node20" class="node">
<title>nf90_put_var</title>
<polygon fill="#777777" stroke="#777777" points="571.5,-696 489.5,-696 489.5,-672 571.5,-672 571.5,-696"/>
<text text-anchor="middle" x="530.5" y="-681.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">nf90_put_var</text>
</g>
<!-- proc~uemep_save_netcdf_file&#45;&gt;nf90_put_var -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_edge19" class="edge">
<title>proc~uemep_save_netcdf_file&#45;&gt;nf90_put_var</title>
<path fill="none" stroke="#000000" d="M361.41,-564.83C371.05,-568.06 380.28,-572.62 388,-579 419.3,-604.89 392.45,-637.42 424,-663 439.43,-675.51 460.26,-681.25 479.33,-683.69"/>
<polygon fill="#000000" stroke="#000000" points="479.1,-687.18 489.4,-684.7 479.8,-680.21 479.1,-687.18"/>
</g>
<!-- nf90_redef -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_node21" class="node">
<title>nf90_redef</title>
<polygon fill="#777777" stroke="#777777" points="565.5,-654 495.5,-654 495.5,-630 565.5,-630 565.5,-654"/>
<text text-anchor="middle" x="530.5" y="-639.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">nf90_redef</text>
</g>
<!-- proc~uemep_save_netcdf_file&#45;&gt;nf90_redef -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_edge20" class="edge">
<title>proc~uemep_save_netcdf_file&#45;&gt;nf90_redef</title>
<path fill="none" stroke="#000000" d="M361.1,-567.41C370.52,-570.3 379.77,-574.07 388,-579 409.1,-591.63 402.78,-608.59 424,-621 442.39,-631.76 465.35,-637.1 485.15,-639.71"/>
<polygon fill="#000000" stroke="#000000" points="484.84,-643.2 495.17,-640.85 485.63,-636.25 484.84,-643.2"/>
</g>
<!-- proc~check -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_node23" class="node">
<title>proc~check</title>
<g id="a_proc~~uemep_save_netcdf_control~~CallsGraph_node23"><a xlink:href="../proc/check.html" xlink:title="check">
<polygon fill="#d9534f" stroke="#d9534f" points="557.5,-612 503.5,-612 503.5,-588 557.5,-588 557.5,-612"/>
<text text-anchor="middle" x="530.5" y="-597.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">check</text>
</a>
</g>
</g>
<!-- proc~uemep_save_netcdf_file&#45;&gt;proc~check -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_edge21" class="edge">
<title>proc~uemep_save_netcdf_file&#45;&gt;proc~check</title>
<path fill="none" stroke="#000000" d="M360.41,-570.04C403.55,-577.68 457.7,-587.28 492.93,-593.52"/>
<polygon fill="#000000" stroke="#000000" points="492.76,-597.04 503.22,-595.34 493.98,-590.15 492.76,-597.04"/>
</g>
<!-- proc~uemep_save_netcdf_receptor_file&#45;&gt;nf90_close -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_edge22" class="edge">
<title>proc~uemep_save_netcdf_receptor_file&#45;&gt;nf90_close</title>
<path fill="none" stroke="#000000" d="M360.41,-587.96C400.63,-580.84 450.41,-572.02 485.51,-565.8"/>
<polygon fill="#000000" stroke="#000000" points="486.21,-569.23 495.45,-564.03 484.99,-562.33 486.21,-569.23"/>
</g>
<!-- proc~uemep_save_netcdf_receptor_file&#45;&gt;nf90_create -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_edge23" class="edge">
<title>proc~uemep_save_netcdf_receptor_file&#45;&gt;nf90_create</title>
<path fill="none" stroke="#000000" d="M369.29,-587.83C375.84,-585.4 382.17,-582.49 388,-579 409.1,-566.37 402.78,-549.41 424,-537 441.49,-526.77 463.11,-521.44 482.21,-518.69"/>
<polygon fill="#000000" stroke="#000000" points="482.73,-522.15 492.22,-517.45 481.87,-515.21 482.73,-522.15"/>
</g>
<!-- proc~uemep_save_netcdf_receptor_file&#45;&gt;nf90_def_dim -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_edge24" class="edge">
<title>proc~uemep_save_netcdf_receptor_file&#45;&gt;nf90_def_dim</title>
<path fill="none" stroke="#000000" d="M374.28,-587.86C379.18,-585.39 383.81,-582.46 388,-579 419.3,-553.11 392.45,-520.58 424,-495 438.99,-482.84 459.08,-477.08 477.7,-474.53"/>
<polygon fill="#000000" stroke="#000000" points="478.29,-477.99 487.85,-473.42 477.53,-471.03 478.29,-477.99"/>
</g>
<!-- proc~uemep_save_netcdf_receptor_file&#45;&gt;nf90_def_var -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_edge25" class="edge">
<title>proc~uemep_save_netcdf_receptor_file&#45;&gt;nf90_def_var</title>
<path fill="none" stroke="#000000" d="M375.7,-587.95C380.14,-585.45 384.29,-582.49 388,-579 430.44,-539.11 381.17,-492.46 424,-453 438.85,-439.31 459.99,-433.44 479.44,-431.23"/>
<polygon fill="#000000" stroke="#000000" points="479.75,-434.71 489.42,-430.38 479.16,-427.74 479.75,-434.71"/>
</g>
<!-- proc~uemep_save_netcdf_receptor_file&#45;&gt;nf90_enddef -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_edge26" class="edge">
<title>proc~uemep_save_netcdf_receptor_file&#45;&gt;nf90_enddef</title>
<path fill="none" stroke="#000000" d="M376.41,-587.98C380.62,-585.46 384.53,-582.49 388,-579 441.85,-524.86 369.61,-464.6 424,-411 438.78,-396.43 460.61,-390.56 480.58,-388.57"/>
<polygon fill="#000000" stroke="#000000" points="481.08,-392.04 490.81,-387.86 480.59,-385.06 481.08,-392.04"/>
</g>
<!-- proc~uemep_save_netcdf_receptor_file&#45;&gt;nf90_inq_dimid -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_edge27" class="edge">
<title>proc~uemep_save_netcdf_receptor_file&#45;&gt;nf90_inq_dimid</title>
<path fill="none" stroke="#000000" d="M377.01,-587.88C381.01,-585.38 384.72,-582.44 388,-579 453.38,-510.5 357.94,-436.85 424,-369 436.8,-355.85 455.32,-349.7 473.28,-347.12"/>
<polygon fill="#000000" stroke="#000000" points="473.89,-350.57 483.45,-346 473.13,-343.61 473.89,-350.57"/>
</g>
<!-- proc~uemep_save_netcdf_receptor_file&#45;&gt;nf90_inq_varid -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_edge28" class="edge">
<title>proc~uemep_save_netcdf_receptor_file&#45;&gt;nf90_inq_varid</title>
<path fill="none" stroke="#000000" d="M377.01,-612.12C381.01,-614.62 384.72,-617.56 388,-621 453.38,-689.5 357.94,-763.15 424,-831 437.14,-844.49 456.29,-850.61 474.68,-853.08"/>
<polygon fill="#000000" stroke="#000000" points="474.48,-856.57 484.78,-854.09 475.18,-849.61 474.48,-856.57"/>
</g>
<!-- proc~uemep_save_netcdf_receptor_file&#45;&gt;nf90_inquire_dimension -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_edge29" class="edge">
<title>proc~uemep_save_netcdf_receptor_file&#45;&gt;nf90_inquire_dimension</title>
<path fill="none" stroke="#000000" d="M376.41,-612.02C380.62,-614.54 384.53,-617.51 388,-621 441.85,-675.14 369.61,-735.4 424,-789 431.56,-796.45 440.96,-801.63 451.02,-805.17"/>
<polygon fill="#000000" stroke="#000000" points="450.24,-808.59 460.82,-808.1 452.24,-801.88 450.24,-808.59"/>
</g>
<!-- proc~uemep_save_netcdf_receptor_file&#45;&gt;nf90_open -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_edge30" class="edge">
<title>proc~uemep_save_netcdf_receptor_file&#45;&gt;nf90_open</title>
<path fill="none" stroke="#000000" d="M375.7,-612.05C380.14,-614.55 384.29,-617.51 388,-621 430.44,-660.89 381.17,-707.54 424,-747 440.52,-762.22 464.82,-767.78 485.93,-769.39"/>
<polygon fill="#000000" stroke="#000000" points="485.83,-772.89 495.99,-769.88 486.18,-765.89 485.83,-772.89"/>
</g>
<!-- proc~uemep_save_netcdf_receptor_file&#45;&gt;nf90_put_att -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_edge31" class="edge">
<title>proc~uemep_save_netcdf_receptor_file&#45;&gt;nf90_put_att</title>
<path fill="none" stroke="#000000" d="M374.28,-612.14C379.18,-614.61 383.81,-617.54 388,-621 419.3,-646.89 392.45,-679.42 424,-705 439.87,-717.87 461.45,-723.57 480.96,-725.89"/>
<polygon fill="#000000" stroke="#000000" points="480.65,-729.37 490.93,-726.81 481.3,-722.4 480.65,-729.37"/>
</g>
<!-- proc~uemep_save_netcdf_receptor_file&#45;&gt;nf90_put_var -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_edge32" class="edge">
<title>proc~uemep_save_netcdf_receptor_file&#45;&gt;nf90_put_var</title>
<path fill="none" stroke="#000000" d="M369.29,-612.17C375.84,-614.6 382.17,-617.51 388,-621 409.1,-633.63 402.78,-650.59 424,-663 440.66,-672.75 461.07,-678.05 479.48,-680.9"/>
<polygon fill="#000000" stroke="#000000" points="479.08,-684.38 489.46,-682.25 480.02,-677.44 479.08,-684.38"/>
</g>
<!-- proc~uemep_save_netcdf_receptor_file&#45;&gt;nf90_redef -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_edge33" class="edge">
<title>proc~uemep_save_netcdf_receptor_file&#45;&gt;nf90_redef</title>
<path fill="none" stroke="#000000" d="M360.41,-612.04C400.63,-619.16 450.41,-627.98 485.51,-634.2"/>
<polygon fill="#000000" stroke="#000000" points="484.99,-637.67 495.45,-635.97 486.21,-630.77 484.99,-637.67"/>
</g>
<!-- proc~area_weighted_interpolation_function -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_node22" class="node">
<title>proc~area_weighted_interpolation_function</title>
<g id="a_proc~~uemep_save_netcdf_control~~CallsGraph_node22"><a xlink:href="../proc/area_weighted_interpolation_function.html" xlink:title="area_weighted_interpolation_function">
<polygon fill="#d94e8f" stroke="#d94e8f" points="637,-906 424,-906 424,-882 637,-882 637,-906"/>
<text text-anchor="middle" x="530.5" y="-891.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">area_weighted_interpolation_function</text>
</a>
</g>
</g>
<!-- proc~uemep_save_netcdf_receptor_file&#45;&gt;proc~area_weighted_interpolation_function -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_edge34" class="edge">
<title>proc~uemep_save_netcdf_receptor_file&#45;&gt;proc~area_weighted_interpolation_function</title>
<path fill="none" stroke="#000000" d="M377.13,-612.01C381.1,-614.54 384.77,-617.52 388,-621 464.96,-703.93 346.21,-790.85 424,-873 424.8,-873.85 425.63,-874.67 426.48,-875.46"/>
<polygon fill="#000000" stroke="#000000" points="424.63,-878.45 434.66,-881.84 428.93,-872.93 424.63,-878.45"/>
</g>
<!-- proc~uemep_save_netcdf_receptor_file&#45;&gt;proc~check -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_edge35" class="edge">
<title>proc~uemep_save_netcdf_receptor_file&#45;&gt;proc~check</title>
<path fill="none" stroke="#000000" d="M386.17,-600C423.69,-600 464.68,-600 493.18,-600"/>
<polygon fill="#000000" stroke="#000000" points="493.46,-603.5 503.46,-600 493.46,-596.5 493.46,-603.5"/>
</g>
<!-- proc~uemep_during_no2 -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_node24" class="node">
<title>proc~uemep_during_no2</title>
<g id="a_proc~~uemep_save_netcdf_control~~CallsGraph_node24"><a xlink:href="../proc/uemep_during_no2.html" xlink:title="uEMEP_During_NO2">
<polygon fill="#d9534f" stroke="#d9534f" points="589,-234 472,-234 472,-210 589,-210 589,-234"/>
<text text-anchor="middle" x="530.5" y="-219.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">uEMEP_During_NO2</text>
</a>
</g>
</g>
<!-- proc~uemep_source_fraction_chemistry&#45;&gt;proc~uemep_during_no2 -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_edge36" class="edge">
<title>proc~uemep_source_fraction_chemistry&#45;&gt;proc~uemep_during_no2</title>
<path fill="none" stroke="#000000" d="M326.52,-171.03C352.9,-180.07 390.47,-192.34 424,-201 436.13,-204.13 449.14,-207.07 461.75,-209.69"/>
<polygon fill="#000000" stroke="#000000" points="461.24,-213.16 471.74,-211.72 462.64,-206.3 461.24,-213.16"/>
</g>
<!-- proc~uemep_nonlocal_no2_o3 -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_node25" class="node">
<title>proc~uemep_nonlocal_no2_o3</title>
<g id="a_proc~~uemep_save_netcdf_control~~CallsGraph_node25"><a xlink:href="../proc/uemep_nonlocal_no2_o3.html" xlink:title="uEMEP_nonlocal_NO2_O3">
<polygon fill="#d9534f" stroke="#d9534f" points="604,-192 457,-192 457,-168 604,-168 604,-192"/>
<text text-anchor="middle" x="530.5" y="-177.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">uEMEP_nonlocal_NO2_O3</text>
</a>
</g>
</g>
<!-- proc~uemep_source_fraction_chemistry&#45;&gt;proc~uemep_nonlocal_no2_o3 -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_edge37" class="edge">
<title>proc~uemep_source_fraction_chemistry&#45;&gt;proc~uemep_nonlocal_no2_o3</title>
<path fill="none" stroke="#000000" d="M388.21,-167.48C407.6,-169.2 427.83,-170.99 446.72,-172.67"/>
<polygon fill="#000000" stroke="#000000" points="446.49,-176.16 456.76,-173.56 447.11,-169.19 446.49,-176.16"/>
</g>
<!-- proc~uemep_photostationary_no2 -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_node26" class="node">
<title>proc~uemep_photostationary_no2</title>
<g id="a_proc~~uemep_save_netcdf_control~~CallsGraph_node26"><a xlink:href="../proc/uemep_photostationary_no2.html" xlink:title="uEMEP_photostationary_NO2">
<polygon fill="#d9534f" stroke="#d9534f" points="613,-150 448,-150 448,-126 613,-126 613,-150"/>
<text text-anchor="middle" x="530.5" y="-135.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">uEMEP_photostationary_NO2</text>
</a>
</g>
</g>
<!-- proc~uemep_source_fraction_chemistry&#45;&gt;proc~uemep_photostationary_no2 -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_edge38" class="edge">
<title>proc~uemep_source_fraction_chemistry&#45;&gt;proc~uemep_photostationary_no2</title>
<path fill="none" stroke="#000000" d="M388.21,-150.52C404.6,-149.07 421.59,-147.56 437.86,-146.12"/>
<polygon fill="#000000" stroke="#000000" points="438.24,-149.6 447.89,-145.23 437.62,-142.63 438.24,-149.6"/>
</g>
<!-- proc~uemep_phototimescale_no2 -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_node27" class="node">
<title>proc~uemep_phototimescale_no2</title>
<g id="a_proc~~uemep_save_netcdf_control~~CallsGraph_node27"><a xlink:href="../proc/uemep_phototimescale_no2.html" xlink:title="uEMEP_phototimescale_NO2">
<polygon fill="#d9534f" stroke="#d9534f" points="612,-108 449,-108 449,-84 612,-84 612,-108"/>
<text text-anchor="middle" x="530.5" y="-93.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">uEMEP_phototimescale_NO2</text>
</a>
</g>
</g>
<!-- proc~uemep_source_fraction_chemistry&#45;&gt;proc~uemep_phototimescale_no2 -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_edge39" class="edge">
<title>proc~uemep_source_fraction_chemistry&#45;&gt;proc~uemep_phototimescale_no2</title>
<path fill="none" stroke="#000000" d="M359.82,-146.97C369.42,-144.46 379.07,-141.49 388,-138 405.25,-131.26 406.68,-123.56 424,-117 430.22,-114.64 436.75,-112.54 443.38,-110.65"/>
<polygon fill="#000000" stroke="#000000" points="444.39,-114.01 453.15,-108.06 442.59,-107.24 444.39,-114.01"/>
</g>
<!-- proc~uemep_romberg_no2 -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_node28" class="node">
<title>proc~uemep_romberg_no2</title>
<g id="a_proc~~uemep_save_netcdf_control~~CallsGraph_node28"><a xlink:href="../proc/uemep_romberg_no2.html" xlink:title="uEMEP_Romberg_NO2">
<polygon fill="#d9534f" stroke="#d9534f" points="595.5,-66 465.5,-66 465.5,-42 595.5,-42 595.5,-66"/>
<text text-anchor="middle" x="530.5" y="-51.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">uEMEP_Romberg_NO2</text>
</a>
</g>
</g>
<!-- proc~uemep_source_fraction_chemistry&#45;&gt;proc~uemep_romberg_no2 -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_edge40" class="edge">
<title>proc~uemep_source_fraction_chemistry&#45;&gt;proc~uemep_romberg_no2</title>
<path fill="none" stroke="#000000" d="M372.43,-146.94C377.95,-144.47 383.21,-141.52 388,-138 413.98,-118.9 397.83,-93.84 424,-75 433.32,-68.29 444.25,-63.59 455.47,-60.33"/>
<polygon fill="#000000" stroke="#000000" points="456.55,-63.66 465.39,-57.81 454.83,-56.88 456.55,-63.66"/>
</g>
<!-- proc~uemep_srm_no2 -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_node29" class="node">
<title>proc~uemep_srm_no2</title>
<g id="a_proc~~uemep_save_netcdf_control~~CallsGraph_node29"><a xlink:href="../proc/uemep_srm_no2.html" xlink:title="uEMEP_SRM_NO2">
<polygon fill="#d9534f" stroke="#d9534f" points="582.5,-24 478.5,-24 478.5,0 582.5,0 582.5,-24"/>
<text text-anchor="middle" x="530.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">uEMEP_SRM_NO2</text>
</a>
</g>
</g>
<!-- proc~uemep_source_fraction_chemistry&#45;&gt;proc~uemep_srm_no2 -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_edge41" class="edge">
<title>proc~uemep_source_fraction_chemistry&#45;&gt;proc~uemep_srm_no2</title>
<path fill="none" stroke="#000000" d="M375.04,-146.97C379.7,-144.47 384.07,-141.5 388,-138 424.81,-105.16 386.86,-65.47 424,-33 436.28,-22.26 452.47,-16.4 468.46,-13.35"/>
<polygon fill="#000000" stroke="#000000" points="469.03,-16.81 478.36,-11.79 467.94,-9.89 469.03,-16.81"/>
</g>
<!-- nf90_strerror -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_node31" class="node">
<title>nf90_strerror</title>
<polygon fill="#777777" stroke="#777777" points="754,-612 673,-612 673,-588 754,-588 754,-612"/>
<text text-anchor="middle" x="713.5" y="-597.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">nf90_strerror</text>
</g>
<!-- proc~check&#45;&gt;nf90_strerror -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_edge42" class="edge">
<title>proc~check&#45;&gt;nf90_strerror</title>
<path fill="none" stroke="#000000" d="M557.82,-600C585.19,-600 628.69,-600 662.6,-600"/>
<polygon fill="#000000" stroke="#000000" points="662.78,-603.5 672.78,-600 662.78,-596.5 662.78,-603.5"/>
</g>
<!-- clog -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_node30" class="node">
<title>clog</title>
<polygon fill="#777777" stroke="#777777" points="740.5,-108 686.5,-108 686.5,-84 740.5,-84 740.5,-108"/>
<text text-anchor="middle" x="713.5" y="-93.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">clog</text>
</g>
<!-- proc~uemep_phototimescale_no2&#45;&gt;clog -->
<g id="proc~~uemep_save_netcdf_control~~CallsGraph_edge43" class="edge">
<title>proc~uemep_phototimescale_no2&#45;&gt;clog</title>
<path fill="none" stroke="#000000" d="M612.21,-96C634.69,-96 657.99,-96 676.47,-96"/>
<polygon fill="#000000" stroke="#000000" points="676.48,-99.5 686.48,-96 676.48,-92.5 676.48,-99.5"/>
</g>
</g>
</svg>
</div>                <script>
                  var panprocuemep_save_netcdf_controlCallsGraph = svgPanZoom('#procuemep_save_netcdf_controlCallsGraph',
                    {zoomEnabled: true, controlIconsEnabled: true, fit: true, center: true,}
                  );
                </script>          <div>
            <a type="button" class="graph-help" data-bs-toggle="modal" href="#CallsGraph-help-text">Help</a>
          </div>
          <div class="modal fade" id="CallsGraph-help-text" tabindex="-1" role="dialog">
            <div class="modal-dialog modal-lg" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h4 class="modal-title" id="-graph-help-label">Graph Key</h4>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
<p>Nodes of different colours represent the following: </p>
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.43.0 (0)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="641pt" height="28pt"
 viewBox="0.00 0.00 641.00 27.51" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(0.86 0.86) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-28 741.5,-28 741.5,4 -4,4"/>
<!-- Subroutine -->
<g id="node1" class="node">
<title>Subroutine</title>
<polygon fill="#d9534f" stroke="#d9534f" points="70,-24 0,-24 0,0 70,0 70,-24"/>
<text text-anchor="middle" x="35" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Subroutine</text>
</g>
<!-- Function -->
<g id="node2" class="node">
<title>Function</title>
<polygon fill="#d94e8f" stroke="#d94e8f" points="146,-24 88,-24 88,0 146,0 146,-24"/>
<text text-anchor="middle" x="117" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Function</text>
</g>
<!-- Interface -->
<g id="node3" class="node">
<title>Interface</title>
<polygon fill="#a7506f" stroke="#a7506f" points="225.5,-24 164.5,-24 164.5,0 225.5,0 225.5,-24"/>
<text text-anchor="middle" x="195" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Interface</text>
</g>
<!-- Type Bound Procedure -->
<g id="node4" class="node">
<title>Type Bound Procedure</title>
<polygon fill="#a7506f" stroke="#a7506f" points="374,-24 244,-24 244,0 374,0 374,-24"/>
<text text-anchor="middle" x="309" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Type Bound Procedure</text>
</g>
<!-- Unknown Procedure Type -->
<g id="node5" class="node">
<title>Unknown Procedure Type</title>
<polygon fill="#777777" stroke="#777777" points="537.5,-24 392.5,-24 392.5,0 537.5,0 537.5,-24"/>
<text text-anchor="middle" x="465" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Unknown Procedure Type</text>
</g>
<!-- Program -->
<g id="node6" class="node">
<title>Program</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="614,-24 556,-24 556,0 614,0 614,-24"/>
<text text-anchor="middle" x="585" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Program</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node7" class="node">
<title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="black" points="737.5,-24 632.5,-24 632.5,0 737.5,0 737.5,-24"/>
<text text-anchor="middle" x="685" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50">This Page&#39;s Entity</text>
</g>
</g>
</svg>

<p>Solid arrows point from a procedure to one which it calls. Dashed 
arrows point from an interface to procedures which implement that interface.
This could include the module procedures in a generic interface or the
implementation in a submodule of an interface in a parent module.
</p>
 </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-header">
  <h3 class="card-title">Called by</h3>
      </div>
      <div class="card-body">
  <div class="depgraph"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.43.0 (0)
 -->
<!-- Title: proc~~uemep_save_netcdf_control~~CalledByGraph Pages: 1 -->
<svg id="procuemep_save_netcdf_controlCalledByGraph" width="269pt" height="32pt"
 viewBox="0.00 0.00 269.00 32.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="proc~~uemep_save_netcdf_control~~CalledByGraph" class="graph" transform="scale(1 1) rotate(0) translate(4 28)">
<title>proc~~uemep_save_netcdf_control~~CalledByGraph</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-28 265,-28 265,4 -4,4"/>
<!-- proc~uemep_save_netcdf_control -->
<g id="proc~~uemep_save_netcdf_control~~CalledByGraph_node1" class="node">
<title>proc~uemep_save_netcdf_control</title>
<polygon fill="none" stroke="black" points="261,-24 102,-24 102,0 261,0 261,-24"/>
<text text-anchor="middle" x="181.5" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50">uEMEP_save_netcdf_control</text>
</g>
<!-- program~uemep_v6 -->
<g id="proc~~uemep_save_netcdf_control~~CalledByGraph_node2" class="node">
<title>program~uemep_v6</title>
<g id="a_proc~~uemep_save_netcdf_control~~CalledByGraph_node2"><a xlink:href="../program/uemep_v6.html" xlink:title="uEMEP_v6">
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="66,-24 0,-24 0,0 66,0 66,-24"/>
<text text-anchor="middle" x="33" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">uEMEP_v6</text>
</a>
</g>
</g>
<!-- program~uemep_v6&#45;&gt;proc~uemep_save_netcdf_control -->
<g id="proc~~uemep_save_netcdf_control~~CalledByGraph_edge1" class="edge">
<title>program~uemep_v6&#45;&gt;proc~uemep_save_netcdf_control</title>
<path fill="none" stroke="#000000" d="M66.15,-12C73.92,-12 82.61,-12 91.62,-12"/>
<polygon fill="#000000" stroke="#000000" points="91.91,-15.5 101.91,-12 91.91,-8.5 91.91,-15.5"/>
</g>
</g>
</svg>
</div>          <div>
            <a type="button" class="graph-help" data-bs-toggle="modal" href="#CalledByGraph-help-text">Help</a>
          </div>
          <div class="modal fade" id="CalledByGraph-help-text" tabindex="-1" role="dialog">
            <div class="modal-dialog modal-lg" role="document">
              <div class="modal-content">
                <div class="modal-header">
                  <h4 class="modal-title" id="-graph-help-label">Graph Key</h4>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
<p>Nodes of different colours represent the following: </p>
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.43.0 (0)
 -->
<!-- Title: Graph Key Pages: 1 -->
<svg width="641pt" height="28pt"
 viewBox="0.00 0.00 641.00 27.51" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(0.86 0.86) rotate(0) translate(4 28)">
<title>Graph Key</title>
<polygon fill="white" stroke="transparent" points="-4,4 -4,-28 741.5,-28 741.5,4 -4,4"/>
<!-- Subroutine -->
<g id="node1" class="node">
<title>Subroutine</title>
<polygon fill="#d9534f" stroke="#d9534f" points="70,-24 0,-24 0,0 70,0 70,-24"/>
<text text-anchor="middle" x="35" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Subroutine</text>
</g>
<!-- Function -->
<g id="node2" class="node">
<title>Function</title>
<polygon fill="#d94e8f" stroke="#d94e8f" points="146,-24 88,-24 88,0 146,0 146,-24"/>
<text text-anchor="middle" x="117" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Function</text>
</g>
<!-- Interface -->
<g id="node3" class="node">
<title>Interface</title>
<polygon fill="#a7506f" stroke="#a7506f" points="225.5,-24 164.5,-24 164.5,0 225.5,0 225.5,-24"/>
<text text-anchor="middle" x="195" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Interface</text>
</g>
<!-- Type Bound Procedure -->
<g id="node4" class="node">
<title>Type Bound Procedure</title>
<polygon fill="#a7506f" stroke="#a7506f" points="374,-24 244,-24 244,0 374,0 374,-24"/>
<text text-anchor="middle" x="309" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Type Bound Procedure</text>
</g>
<!-- Unknown Procedure Type -->
<g id="node5" class="node">
<title>Unknown Procedure Type</title>
<polygon fill="#777777" stroke="#777777" points="537.5,-24 392.5,-24 392.5,0 537.5,0 537.5,-24"/>
<text text-anchor="middle" x="465" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Unknown Procedure Type</text>
</g>
<!-- Program -->
<g id="node6" class="node">
<title>Program</title>
<polygon fill="#f0ad4e" stroke="#f0ad4e" points="614,-24 556,-24 556,0 614,0 614,-24"/>
<text text-anchor="middle" x="585" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50" fill="white">Program</text>
</g>
<!-- This Page&#39;s Entity -->
<g id="node7" class="node">
<title>This Page&#39;s Entity</title>
<polygon fill="none" stroke="black" points="737.5,-24 632.5,-24 632.5,0 737.5,0 737.5,-24"/>
<text text-anchor="middle" x="685" y="-9.6" font-family="Helvetica,sans-Serif" font-size="10.50">This Page&#39;s Entity</text>
</g>
</g>
</svg>

<p>Solid arrows point from a procedure to one which it calls. Dashed 
arrows point from an interface to procedures which implement that interface.
This could include the module procedures in a generic interface or the
implementation in a submodule of an interface in a parent module.
</p>
 </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <br>


    
    

    
    



    
    <section>
    <h2><span class="anchor" id="src"></span>Source Code</h2>
    <div class="hl codehilite"><pre><span></span><span class="w">    </span><span class="k">subroutine </span><span class="n">uEMEP_save_netcdf_control</span>

<span class="w">        </span><span class="k">use </span><span class="n">uEMEP_definitions</span>

<span class="w">        </span><span class="k">implicit none</span>

<span class="k">        </span><span class="kt">integer </span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">l</span>
<span class="w">        </span><span class="kt">integer </span><span class="n">i_comp</span><span class="p">,</span><span class="n">i_file</span><span class="p">,</span><span class="n">i_meteo</span>
<span class="w">        </span><span class="kt">character</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span><span class="w"> </span><span class="n">temp_name</span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">var_name_temp</span><span class="p">,</span><span class="w"> </span><span class="n">temp_date_str</span><span class="p">,</span><span class="n">station_name_str</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">temp_compound_str</span>
<span class="w">        </span><span class="kt">logical </span><span class="n">create_file</span><span class="p">,</span><span class="n">create_file_rec</span>
<span class="w">        </span><span class="kt">integer </span><span class="n">i_source</span>
<span class="w">        </span><span class="kt">real</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">valid_min</span><span class="o">=</span><span class="mf">0.</span>
<span class="w">        </span><span class="kt">real</span><span class="p">,</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">temp_subgrid</span><span class="p">(:,:,:)</span>
<span class="w">        </span><span class="kt">real</span><span class="p">,</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">temp_integral_subgrid</span><span class="p">(:,:,:)</span>
<span class="w">        </span><span class="kt">real</span><span class="p">,</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">aqi_subgrid</span><span class="p">(:,:,:,:)</span>
<span class="w">        </span><span class="kt">integer</span><span class="p">,</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">aqi_responsible_pollutant_index</span><span class="p">(:,:,:)</span>
<span class="w">        </span><span class="kt">real</span><span class="p">,</span><span class="w"> </span><span class="k">allocatable</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">temp_subgrid_ascii</span><span class="p">(:,:)</span>

<span class="w">        </span><span class="kt">integer </span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">tt</span>

<span class="w">        </span><span class="kt">real </span><span class="n">aqi_limits_temp</span><span class="p">(</span><span class="n">n_compound_index</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">)</span>
<span class="w">        </span><span class="kt">real </span><span class="n">max_aqi</span>
<span class="w">        </span><span class="kt">integer </span><span class="n">n_aqi_pollutant_index</span>
<span class="w">        </span><span class="k">parameter</span><span class="w"> </span><span class="p">(</span><span class="n">n_aqi_pollutant_index</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="w">        </span><span class="kt">integer </span><span class="n">aqi_pollutant_index</span><span class="p">(</span><span class="n">n_aqi_pollutant_index</span><span class="p">)</span>
<span class="w">        </span><span class="kt">integer </span><span class="n">i_pollutant</span><span class="p">,</span><span class="n">i_loop</span>
<span class="w">        </span><span class="kt">character</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span><span class="w"> </span><span class="n">variable_type</span>
<span class="w">        </span><span class="kt">logical</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">receptor_available</span><span class="o">=</span><span class="p">.</span><span class="n">true</span><span class="p">.</span>
<span class="w">        </span><span class="kt">real </span><span class="n">scale_factor</span>
<span class="w">        </span><span class="kt">integer </span><span class="n">n_save_aqi_pollutant_index</span>
<span class="w">        </span><span class="kt">real </span><span class="n">temp_sum_comp</span>
<span class="w">        </span><span class="kt">integer </span><span class="nb">count</span>
<span class="nb">        </span><span class="kt">character</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span><span class="w"> </span><span class="n">filename_ascii</span>

<span class="w">        </span><span class="kt">integer </span><span class="n">i_sp</span><span class="p">,</span><span class="n">ii_sp</span>

<span class="w">        </span><span class="kt">integer </span><span class="n">source_domain_loop</span>
<span class="w">        </span><span class="kt">integer </span><span class="n">no2_o3_loop</span><span class="p">,</span><span class="n">comp_index</span><span class="p">,</span><span class="n">comp_nc_index</span>
<span class="w">        </span><span class="kt">character</span><span class="p">(</span><span class="mi">256</span><span class="p">)</span><span class="w"> </span><span class="n">filename_append</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">include_o3_in_aqi_index</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            </span><span class="n">n_save_aqi_pollutant_index</span><span class="o">=</span><span class="n">n_aqi_pollutant_index</span>
<span class="w">        </span><span class="k">else</span>
<span class="k">            </span><span class="n">n_save_aqi_pollutant_index</span><span class="o">=</span><span class="n">n_aqi_pollutant_index</span><span class="o">-</span><span class="mi">1</span>
<span class="w">        </span><span class="k">endif</span>

<span class="k">        if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="nb">allocated</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">))</span><span class="w"> </span><span class="k">allocate</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">(</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)))</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="nb">allocated</span><span class="p">(</span><span class="n">temp_integral_subgrid</span><span class="p">))</span><span class="w"> </span><span class="k">allocate</span><span class="p">(</span><span class="n">temp_integral_subgrid</span><span class="p">(</span><span class="n">integral_subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">integral_subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)))</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="nb">allocated</span><span class="p">(</span><span class="n">aqi_subgrid</span><span class="p">).</span><span class="nb">and</span><span class="p">.</span><span class="n">save_aqi</span><span class="p">)</span><span class="w"> </span><span class="k">allocate</span><span class="p">(</span><span class="n">aqi_subgrid</span><span class="p">(</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">),</span><span class="n">n_compound_index</span><span class="p">))</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="nb">allocated</span><span class="p">(</span><span class="n">aqi_responsible_pollutant_index</span><span class="p">).</span><span class="nb">and</span><span class="p">.</span><span class="n">save_aqi</span><span class="p">)</span><span class="w"> </span><span class="k">allocate</span><span class="p">(</span><span class="n">aqi_responsible_pollutant_index</span><span class="p">(</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)))</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="nb">allocated</span><span class="p">(</span><span class="n">temp_subgrid_ascii</span><span class="p">).</span><span class="nb">and</span><span class="p">.</span><span class="n">save_compounds_as_ascii</span><span class="p">)</span><span class="w"> </span><span class="k">allocate</span><span class="p">(</span><span class="n">temp_subgrid_ascii</span><span class="p">(</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">)))</span>

<span class="w">        </span><span class="c">!Save subgrid calculations</span>
<span class="w">        </span><span class="n">valid_min</span><span class="o">=</span><span class="mf">0.</span>
<span class="w">        </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;ug/m3&quot;</span>
<span class="w">        </span><span class="n">variable_type</span><span class="o">=</span><span class="s1">&#39;byte&#39;</span>
<span class="w">        </span><span class="c">!variable_type=&#39;double&#39;</span>
<span class="w">        </span><span class="n">variable_type</span><span class="o">=</span><span class="s1">&#39;float&#39;</span>
<span class="w">        </span><span class="n">scale_factor</span><span class="o">=</span><span class="mf">1.</span>

<span class="w">        </span><span class="c">!Save the data</span>
<span class="w">        </span><span class="n">i_file</span><span class="o">=</span><span class="n">subgrid_total_file_index</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">)</span>
<span class="w">        </span><span class="c">!temp_name=trim(pathname_grid(i_file))//trim(filename_grid(i_file))//&#39;_&#39;//trim(file_tag)//&#39;.nc&#39;</span>
<span class="w">        </span><span class="c">!if (len(config_date_str).gt.0) then</span>
<span class="w">        </span><span class="c">!    temp_date_str=&#39;_&#39;//trim(config_date_str)</span>
<span class="w">        </span><span class="c">!else</span>
<span class="w">        </span><span class="c">!    temp_date_str=&#39;&#39;</span>
<span class="w">        </span><span class="c">!endif</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filename_date_output_grid</span><span class="p">).</span><span class="n">gt</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            </span><span class="n">temp_date_str</span><span class="o">=</span><span class="s1">&#39;_&#39;</span><span class="o">//</span><span class="n">filename_date_output_grid</span>
<span class="w">        </span><span class="k">else</span>
<span class="k">            </span><span class="n">temp_date_str</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
<span class="w">        </span><span class="k">endif</span>

<span class="k">        if</span><span class="w"> </span><span class="p">(</span><span class="n">use_multiple_receptor_grids_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            </span><span class="n">station_name_str</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">name_receptor_in</span><span class="p">(</span><span class="n">g_loop</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;_&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="k">else</span>
<span class="k">            </span><span class="n">station_name_str</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
<span class="w">        </span><span class="k">endif</span>

<span class="w">        </span><span class="c">!Do not write &#39;all&#39; in file name if all compounds are selected</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pollutant_index</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">all_nc_index</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            </span><span class="n">temp_compound_str</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
<span class="w">        </span><span class="k">else</span>
<span class="k">            </span><span class="n">temp_compound_str</span><span class="o">=</span><span class="s1">&#39;_&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_nc</span><span class="p">(</span><span class="n">conc_nc_index</span><span class="p">,</span><span class="n">compound_index</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">))</span>
<span class="w">        </span><span class="k">endif</span>
<span class="w">        </span><span class="c">!Do not write anything about the compounds</span>
<span class="w">        </span><span class="n">temp_compound_str</span><span class="o">=</span><span class="s1">&#39;&#39;</span>

<span class="w">        </span><span class="c">!temp_name=trim(pathname_grid(i_file))//trim(station_name_str)//&#39;uEMEP_&#39;//trim(file_tag)//trim(temp_compound_str)//trim(temp_date_str)//&#39;_&#39;//trim(forecast_hour_str)//&#39;.nc&#39;</span>
<span class="w">        </span><span class="c">!temp_name_rec=trim(pathname_grid(i_file))//&#39;uEMEP_&#39;//trim(file_tag)//&#39;_station&#39;//trim(temp_compound_str)//trim(temp_date_str)//&#39;_&#39;//trim(forecast_hour_str)//&#39;.nc&#39;</span>
<span class="w">        </span><span class="c">!if (save_netcdf_average_flag) then</span>
<span class="w">        </span><span class="c">!temp_name=trim(pathname_grid(i_file))//trim(station_name_str)//&#39;uEMEP_&#39;//trim(file_tag)//trim(temp_compound_str)//&#39;_mean&#39;//trim(temp_date_str)//&#39;_&#39;//trim(forecast_hour_str)//&#39;.nc&#39;</span>
<span class="w">        </span><span class="c">!temp_name_rec=trim(pathname_grid(i_file))//&#39;uEMEP_&#39;//trim(file_tag)//&#39;_station&#39;//trim(temp_compound_str)//&#39;_mean&#39;//trim(temp_date_str)//&#39;_&#39;//trim(forecast_hour_str)//&#39;.nc&#39;</span>
<span class="w">        </span><span class="c">!endif</span>
<span class="w">        </span><span class="n">temp_name</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">pathname_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">station_name_str</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;uEMEP_&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">file_tag</span><span class="p">)</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">temp_compound_str</span><span class="p">)</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">temp_date_str</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.nc&#39;</span>
<span class="w">        </span><span class="n">temp_name_rec</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">pathname_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;uEMEP_&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">file_tag</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;_station&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">temp_compound_str</span><span class="p">)</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">temp_date_str</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.nc&#39;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_average_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            </span><span class="n">temp_name</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">pathname_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">station_name_str</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;uEMEP_&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">file_tag</span><span class="p">)</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">temp_compound_str</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;_mean&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">temp_date_str</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.nc&#39;</span>
<span class="w">            </span><span class="n">temp_name_rec</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">pathname_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;uEMEP_&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">file_tag</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;_station&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">temp_compound_str</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;_mean&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">temp_date_str</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.nc&#39;</span>
<span class="w">        </span><span class="k">endif</span>

<span class="k">        </span><span class="n">finished_file</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">pathname_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">finished_subpath</span><span class="p">)</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">station_name_str</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;uEMEP_&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">file_tag</span><span class="p">)</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">temp_compound_str</span><span class="p">)</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">temp_date_str</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">finished_filename</span><span class="p">)</span>
<span class="w">        </span><span class="n">finished_file_rec</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">pathname_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">finished_subpath</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;uEMEP_&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">file_tag</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;_station&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">temp_compound_str</span><span class="p">)</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">temp_date_str</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">finished_filename</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_average_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            </span><span class="n">finished_file</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">pathname_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">finished_subpath</span><span class="p">)</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">station_name_str</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;uEMEP_&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">file_tag</span><span class="p">)</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">temp_compound_str</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;_mean&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">temp_date_str</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">finished_filename</span><span class="p">)</span>
<span class="w">            </span><span class="n">finished_file_rec</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">pathname_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">finished_subpath</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;uEMEP_&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">file_tag</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;_station&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">temp_compound_str</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;_mean&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">temp_date_str</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">finished_filename</span><span class="p">)</span>
<span class="w">        </span><span class="k">endif</span>

<span class="k">        write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;&#39;</span>
<span class="w">        </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;================================================================&#39;</span>
<span class="w">        </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Saving netcdf data (uEMEP_save_netcdf_control)&#39;</span>
<span class="w">        </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;================================================================&#39;</span>

<span class="w">        </span><span class="n">i_comp</span><span class="o">=</span><span class="mi">1</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">i_comp</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mf">1.</span><span class="nb">and</span><span class="p">.</span><span class="n">t_loop</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">start_time_loop_index</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;No receptor positions available. Will not save receptor data.&#39;</span>
<span class="w">                </span><span class="n">receptor_available</span><span class="o">=</span><span class="p">.</span><span class="n">false</span><span class="p">.</span>
<span class="w">            </span><span class="k">endif</span>
<span class="k">        endif</span>

<span class="k">        if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_average_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="nb">allocated</span><span class="p">(</span><span class="n">val_array_av</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">                allocate</span><span class="p">(</span><span class="n">val_array_av</span><span class="p">(</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">n_var_av</span><span class="p">))</span>
<span class="w">                </span><span class="n">val_array_av</span><span class="o">=</span><span class="mf">0.</span>
<span class="w">            </span><span class="k">endif</span>
<span class="k">            if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="nb">allocated</span><span class="p">(</span><span class="n">time_seconds_output_av</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">                allocate</span><span class="p">(</span><span class="n">time_seconds_output_av</span><span class="p">(</span><span class="n">n_var_av</span><span class="p">))</span>
<span class="w">                </span><span class="n">time_seconds_output_av</span><span class="o">=</span><span class="mi">0</span>
<span class="w">            </span><span class="k">endif</span>
<span class="w">            </span><span class="c">!Reset average file counter for every time step saving occurs</span>
<span class="w">            </span><span class="n">counter_av</span><span class="o">=</span><span class="mi">0</span>
<span class="w">            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Saving as mean data&#39;</span>
<span class="w">        </span><span class="k">endif</span>

<span class="w">        </span><span class="c">!Save the final result of the subgrid calculation in ascii format</span>
<span class="w">        </span><span class="c">!This should only be used for annual mean calculations since it cannot have a time dimmension</span>
<span class="w">        </span><span class="c">!Intended for FAIRMODE output</span>
<span class="w">        </span><span class="c">!Makes a new file for each compound and averages over time, if there is a time dimension</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_compounds_as_ascii</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            </span><span class="n">variable_type</span><span class="o">=</span><span class="s1">&#39;float&#39;</span>
<span class="w">            </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;ug/m3&quot;</span>
<span class="w">            </span><span class="k">do </span><span class="n">i_pollutant</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n_pollutant_loop</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">ne</span><span class="p">.</span><span class="n">pmex_index</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">ne</span><span class="p">.</span><span class="n">pm25_sand_index</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">ne</span><span class="p">.</span><span class="n">pm10_sand_index</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">ne</span><span class="p">.</span><span class="n">pm25_salt_index</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">ne</span><span class="p">.</span><span class="n">pm10_salt_index</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    do </span><span class="n">i_loop</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n_pollutant_compound_loop</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">)</span>

<span class="w">                        </span><span class="n">i_comp</span><span class="o">=</span><span class="n">pollutant_compound_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">,</span><span class="n">i_loop</span><span class="p">)</span>
<span class="w">                        </span><span class="c">!write(*,*) i_comp</span>

<span class="w">                        </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_nc</span><span class="p">(</span><span class="n">conc_nc_index</span><span class="p">,</span><span class="n">i_comp</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">))</span>

<span class="w">                        </span><span class="n">title_str</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;_&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">file_tag</span><span class="p">)</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">temp_date_str</span><span class="p">)</span>
<span class="w">                        </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing ascii data to: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">title_str</span><span class="p">)</span>

<span class="w">                        </span><span class="n">filename_ascii</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">pathname_output_grid</span><span class="p">)</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">title_str</span><span class="p">)</span><span class="o">//</span><span class="s1">&#39;.asc&#39;</span>

<span class="w">                        </span><span class="n">temp_subgrid_ascii</span><span class="p">(:,:)</span><span class="o">=</span><span class="nb">sum</span><span class="p">(</span><span class="n">comp_subgrid</span><span class="p">(:,:,:,</span><span class="n">i_comp</span><span class="p">),</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span>


<span class="w">                        </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing ascii array variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">comp_subgrid</span><span class="p">(:,:,:,</span><span class="n">i_comp</span><span class="p">))</span><span class="o">/</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">)</span><span class="o">/</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">)</span><span class="o">/</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span>

<span class="w">                        </span><span class="k">call </span><span class="n">write_esri_ascii_file</span><span class="p">(</span><span class="n">filename_ascii</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_delta</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">temp_subgrid_ascii</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">)</span>

<span class="w">                    </span><span class="k">enddo</span>
<span class="k">                endif</span>
<span class="k">            enddo</span>
<span class="k">        endif</span>

<span class="w">        </span><span class="c">!Save the final result of the subgrid calculation</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_compounds</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>

<span class="k">            write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;--------------------------&#39;</span>
<span class="w">            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;Saving all total compounds&#39;</span>
<span class="w">            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;--------------------------&#39;</span>

<span class="w">            </span><span class="n">variable_type</span><span class="o">=</span><span class="s1">&#39;float&#39;</span>
<span class="w">            </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;ug/m3&quot;</span>
<span class="w">            </span><span class="k">do </span><span class="n">i_pollutant</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n_pollutant_loop</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">ne</span><span class="p">.</span><span class="n">pmex_index</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">ne</span><span class="p">.</span><span class="n">pm25_sand_index</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">ne</span><span class="p">.</span><span class="n">pm10_sand_index</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">ne</span><span class="p">.</span><span class="n">pm25_salt_index</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">ne</span><span class="p">.</span><span class="n">pm10_salt_index</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    do </span><span class="n">i_loop</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n_pollutant_compound_loop</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">)</span>

<span class="w">                        </span><span class="n">i_comp</span><span class="o">=</span><span class="n">pollutant_compound_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">,</span><span class="n">i_loop</span><span class="p">)</span>
<span class="w">                        </span><span class="c">!write(*,*) i_comp</span>

<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mf">1.</span><span class="nb">and</span><span class="p">.</span><span class="n">i_loop</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mf">1.</span><span class="nb">and</span><span class="p">.</span><span class="n">t_loop</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">start_time_loop_index</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                            </span><span class="n">create_file</span><span class="o">=</span><span class="p">.</span><span class="n">true</span><span class="p">.</span>
<span class="w">                            </span><span class="n">title_str</span><span class="o">=</span><span class="s1">&#39;uEMEP_concentration_&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">file_tag</span><span class="p">)</span><span class="o">//</span><span class="n">temp_date_str</span>
<span class="w">                            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing to: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">temp_name</span><span class="p">)</span>
<span class="w">                        </span><span class="k">else</span>
<span class="k">                            </span><span class="n">create_file</span><span class="o">=</span><span class="p">.</span><span class="n">false</span><span class="p">.</span>
<span class="w">                        </span><span class="k">endif</span>

<span class="k">                        if</span><span class="w"> </span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mf">1.</span><span class="nb">and</span><span class="p">.</span><span class="n">i_loop</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mf">1.</span><span class="nb">and</span><span class="p">.</span><span class="n">t_loop</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">start_time_loop_index</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">first_g_loop</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">save_netcdf_receptor_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                            </span><span class="n">create_file_rec</span><span class="o">=</span><span class="p">.</span><span class="n">true</span><span class="p">.</span>
<span class="w">                            </span><span class="n">title_str_rec</span><span class="o">=</span><span class="s1">&#39;uEMEP_receptor_&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">file_tag</span><span class="p">)</span><span class="o">//</span><span class="n">temp_date_str</span>
<span class="w">                            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">receptor_available</span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing to: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">temp_name_rec</span><span class="p">)</span>
<span class="w">                        </span><span class="k">else</span>
<span class="k">                            </span><span class="n">create_file_rec</span><span class="o">=</span><span class="p">.</span><span class="n">false</span><span class="p">.</span>
<span class="w">                        </span><span class="k">endif</span>

<span class="k">                        </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_nc</span><span class="p">(</span><span class="n">conc_nc_index</span><span class="p">,</span><span class="n">i_comp</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;_concentration&#39;</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                            </span><span class="n">temp_sum_comp</span><span class="o">=</span><span class="mf">0.</span>
<span class="w">                            </span><span class="nb">count</span><span class="o">=</span><span class="mi">0</span>
<span class="w">                            </span><span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">)</span>
<span class="w">                                </span><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">)</span>
<span class="w">                                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">use_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                        </span><span class="n">temp_sum_comp</span><span class="o">=</span><span class="n">temp_sum_comp</span><span class="o">+</span><span class="nb">sum</span><span class="p">(</span><span class="n">comp_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,:,</span><span class="n">i_comp</span><span class="p">))</span><span class="o">/</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span>
<span class="w">                                        </span><span class="nb">count</span><span class="o">=</span><span class="nb">count</span><span class="o">+</span><span class="mi">1</span>
<span class="w">                                    </span><span class="k">endif</span>
<span class="k">                                enddo</span>
<span class="k">                            enddo</span>
<span class="k">                            if</span><span class="w"> </span><span class="p">(</span><span class="nb">count</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                </span><span class="n">temp_sum_comp</span><span class="o">=</span><span class="n">temp_sum_comp</span><span class="o">/</span><span class="nb">count</span>
<span class="nb">                            </span><span class="k">else</span>
<span class="k">                                </span><span class="n">temp_sum_comp</span><span class="o">=</span><span class="mi">0</span>
<span class="w">                            </span><span class="k">endif</span>
<span class="w">                            </span><span class="c">!write(unit_logfile,&#39;(a,f12.3)&#39;)&#39;Writing netcdf array variable:    &#39;//trim(var_name_temp),temp_sum_comp</span>
<span class="w">                            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="w"> </span><span class="n">mean_mask</span><span class="p">(</span><span class="n">comp_subgrid</span><span class="p">(:,:,:,</span><span class="n">i_comp</span><span class="p">),</span><span class="n">use_subgrid</span><span class="p">(:,:,</span><span class="n">allsource_index</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">comp_subgrid</span><span class="p">(:,:,:,</span><span class="n">i_comp</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">comp_subgrid</span><span class="p">(:,:,:,</span><span class="n">i_comp</span><span class="p">),</span><span class="mi">2</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">comp_subgrid</span><span class="p">(:,:,:,</span><span class="n">i_comp</span><span class="p">),</span><span class="mi">3</span><span class="p">))</span>
<span class="w">                            </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">comp_subgrid</span><span class="p">(:,:,:,</span><span class="n">i_comp</span><span class="p">),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                        </span><span class="k">endif</span>
<span class="k">                        if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                            write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="w"> </span><span class="n">mean_mask</span><span class="p">(</span><span class="n">comp_subgrid</span><span class="p">(:,:,:,</span><span class="n">i_comp</span><span class="p">),</span><span class="n">use_subgrid</span><span class="p">(:,:,</span><span class="n">allsource_index</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">comp_subgrid</span><span class="p">(:,:,:,</span><span class="n">i_comp</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">comp_subgrid</span><span class="p">(:,:,:,</span><span class="n">i_comp</span><span class="p">),</span><span class="mi">2</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">comp_subgrid</span><span class="p">(:,:,:,</span><span class="n">i_comp</span><span class="p">),</span><span class="mi">3</span><span class="p">))</span>
<span class="w">                            </span><span class="c">!write(unit_logfile,&#39;(a,f12.3)&#39;)&#39;Writing netcdf receptor variable: &#39;//trim(var_name_temp),sum(comp_subgrid(:,:,:,i_comp))/subgrid_dim(x_dim_index)/subgrid_dim(y_dim_index)/subgrid_dim(t_dim_index)</span>
<span class="w">                            </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">comp_subgrid</span><span class="p">(:,:,:,</span><span class="n">i_comp</span><span class="p">),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                        </span><span class="k">endif</span>
<span class="k">                    enddo</span>
<span class="k">                endif</span>
<span class="k">            enddo</span>

<span class="k">        endif</span>

<span class="k">        </span><span class="n">create_file</span><span class="o">=</span><span class="p">.</span><span class="n">false</span><span class="p">.</span>
<span class="w">        </span><span class="n">create_file_rec</span><span class="o">=</span><span class="p">.</span><span class="n">false</span><span class="p">.</span>

<span class="w">        </span><span class="c">! Save downscaled source contributions for pollutants (not no2 or o3)</span>
<span class="w">        </span><span class="c">! 1 = local</span>
<span class="w">        </span><span class="c">! 2 = local, cut down to from_in_region</span>
<span class="w">        </span><span class="c">! 3-4: not used here, but kept to make numbering consistent with the other loops over source_domain_loop</span>
<span class="w">        </span><span class="c">! 5 = total: contribution from big domain, but using downscaled within moving window: 1 + (additional_emep_local(3) - emep_local(1)</span>
<span class="w">        </span><span class="c">! 6 = total from in region = 2 + semilocal emep contribution (4))</span>
<span class="w">        </span><span class="k">do </span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span>

<span class="w">            </span><span class="c">! Skip this round in the loop if this type of source contributions are not to be saved</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="n">save_source_contributions</span><span class="p">)</span><span class="w"> </span><span class="k">cycle</span>
<span class="k">                </span><span class="n">filename_append</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
<span class="w">            </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="p">(</span><span class="n">trace_emissions_from_in_region</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">save_local_source_contributions_from_in_region</span><span class="p">))</span><span class="w"> </span><span class="k">cycle</span>
<span class="k">                </span><span class="n">filename_append</span><span class="o">=</span><span class="s1">&#39;_from_in_region&#39;</span>
<span class="w">            </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="p">(</span><span class="n">save_total_source_contributions</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">EMEP_additional_grid_interpolation_size</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="k">cycle</span>
<span class="k">                </span><span class="n">filename_append</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
<span class="w">            </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">6</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="p">(</span><span class="n">trace_emissions_from_in_region</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">save_total_source_contributions_from_in_region</span><span class="p">))</span><span class="w"> </span><span class="k">cycle</span>
<span class="k">                </span><span class="n">filename_append</span><span class="o">=</span><span class="s1">&#39;_from_in_region&#39;</span>
<span class="w">            </span><span class="k">else</span>
<span class="w">                </span><span class="c">! skip rounds 3-4</span>
<span class="w">                </span><span class="k">cycle</span>
<span class="k">            end if</span>

<span class="k">            write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;--------------------------&#39;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;Saving downscaled contributions&#39;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;Saving downscaled contributions from-in-region&#39;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;Saving total contributions&#39;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">6</span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;Saving total contributions from-in-region&#39;</span>
<span class="w">            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;--------------------------&#39;</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_fraction_as_contribution_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                </span><span class="n">variable_type</span><span class="o">=</span><span class="s1">&#39;float&#39;</span>
<span class="w">                </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;ug/m3&quot;</span>
<span class="w">            </span><span class="k">else</span>
<span class="k">                </span><span class="n">variable_type</span><span class="o">=</span><span class="s1">&#39;byte&#39;</span>
<span class="w">                </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;%&quot;</span>
<span class="w">            </span><span class="k">endif</span>

<span class="k">            do </span><span class="n">i_pollutant</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n_pollutant_loop</span>
<span class="w">                </span><span class="k">do </span><span class="n">i_source</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n_source_index</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                        </span><span class="n">i_file</span><span class="o">=</span><span class="n">subgrid_sourcetotal_file_index</span><span class="p">(</span><span class="n">i_source</span><span class="p">)</span>
<span class="w">                    </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">6</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                        </span><span class="n">i_file</span><span class="o">=</span><span class="n">subgrid_sourcetotal_inregion_file_index</span><span class="p">(</span><span class="n">i_source</span><span class="p">)</span>
<span class="w">                    </span><span class="k">else</span><span class="w">  </span><span class="c">! 1 or 2</span>
<span class="w">                        </span><span class="n">i_file</span><span class="o">=</span><span class="n">subgrid_local_file_index</span><span class="p">(</span><span class="n">i_source</span><span class="p">)</span>
<span class="w">                    </span><span class="k">end if</span>
<span class="w">                    </span><span class="c">!if (calculate_source(i_source).or.i_source.eq.allsource_index) then</span>
<span class="w">                    </span><span class="c">!Don&#39;t save any exhaust, sand or salt pollutant sources. Dealt with later</span>
<span class="w">                    </span><span class="c">!(calculate_source(i_source).or.calculate_emep_source(i_source))</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">calculate_source</span><span class="p">(</span><span class="n">i_source</span><span class="p">).</span><span class="nb">and</span><span class="p">.</span><span class="n">i_source</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="n">allsource_index</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">ne</span><span class="p">.</span><span class="n">pmex_index</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">ne</span><span class="p">.</span><span class="n">pm25_sand_index</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">ne</span><span class="p">.</span><span class="n">pm10_sand_index</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">ne</span><span class="p">.</span><span class="n">pm25_salt_index</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">ne</span><span class="p">.</span><span class="n">pm10_salt_index</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>

<span class="w">                        </span><span class="c">!Only save nonexhaust pm and all the other sources</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="n">nox_index</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">i_source</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">traffic_index</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="w">                            </span><span class="c">!if ((pollutant_loop_index(i_pollutant).ne.nox_index.or.i_source.ne.traffic_index)) then</span>
<span class="w">                        </span><span class="k">else</span>
<span class="k">                            if</span><span class="w"> </span><span class="p">(</span><span class="n">i_source</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">traffic_index</span><span class="p">.</span><span class="nb">and</span><span class="p">.(</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="n">pm10_index</span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="n">pm25_index</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="w">                                </span><span class="c">! Special case for traffic pm: In some setups we need to subtract exhaust to get non-exhaust</span>
<span class="w">                                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pollutant_index</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">all_totals_nc_index</span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="n">pollutant_index</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">aaqd_totals_nc_index</span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="n">pollutant_index</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">gp_totals_nc_index</span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="n">pollutant_index</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">op_totals_nc_index</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">                                    </span><span class="c">! Traffic exhaust is not a separate pollutant, so just save total traffic</span>
<span class="w">                                    </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_nc</span><span class="p">(</span><span class="n">conc_nc_index</span><span class="p">,</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">),</span><span class="n">allsource_index</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;_&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_append</span><span class="p">)</span>
<span class="w">                                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                        </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">local_subgrid_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span>
<span class="w">                                    </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                        </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">subgrid_local_from_in_region</span><span class="p">(:,:,:,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span>
<span class="w">                                    </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                        </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">local_subgrid_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span><span class="o">-</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">emep_local_subgrid_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span><span class="o">+</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">emep_additional_local_subgrid_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span>
<span class="w">                                    </span><span class="k">else</span><span class="w"> </span><span class="c">! source_domain_loop == 6</span>
<span class="w">                                        </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">subgrid_local_from_in_region</span><span class="p">(:,:,:,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span><span class="o">+</span><span class="n">subgrid_EMEP_semilocal_from_in_region</span><span class="p">(:,:,:,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span>
<span class="w">                                    </span><span class="k">endif</span>
<span class="k">                                else</span>
<span class="w">                                    </span><span class="c">! Calculate non-exhaust as difference between total traffic and exhaust for downscaled contributions</span>
<span class="w">                                    </span><span class="c">! For EMEP contributions, non-exhaust can be directly accessed with traffic_nonexhaust_nc_index</span>
<span class="w">                                    </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_nc</span><span class="p">(</span><span class="n">conc_nc_index</span><span class="p">,</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">),</span><span class="n">allsource_index</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;_&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;_nonexhaust&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_append</span><span class="p">)</span>
<span class="w">                                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                        </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">local_subgrid_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span><span class="o">-</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">local_subgrid_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">,</span><span class="n">pollutant_loop_back_index</span><span class="p">(</span><span class="n">pmex_index</span><span class="p">))</span>
<span class="w">                                    </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                        </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">subgrid_local_from_in_region</span><span class="p">(:,:,:,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span><span class="o">-</span><span class="n">subgrid_local_from_in_region</span><span class="p">(:,:,:,</span><span class="n">i_source</span><span class="p">,</span><span class="n">pollutant_loop_back_index</span><span class="p">(</span><span class="n">pmex_index</span><span class="p">))</span>
<span class="w">                                    </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                        </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">local_subgrid_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span><span class="o">-</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">local_subgrid_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">,</span><span class="n">pollutant_loop_back_index</span><span class="p">(</span><span class="n">pmex_index</span><span class="p">))</span><span class="o">-</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">emep_local_subgrid_index</span><span class="p">,</span><span class="n">traffic_nonexhaust_nc_index</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span><span class="o">+</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">emep_additional_local_subgrid_index</span><span class="p">,</span><span class="n">traffic_nonexhaust_nc_index</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span>
<span class="w">                                    </span><span class="k">else</span><span class="w">  </span><span class="c">!source_domain_loop == 6</span>
<span class="w">                                        </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">subgrid_local_from_in_region</span><span class="p">(:,:,:,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span><span class="o">-</span><span class="n">subgrid_local_from_in_region</span><span class="p">(:,:,:,</span><span class="n">i_source</span><span class="p">,</span><span class="n">pollutant_loop_back_index</span><span class="p">(</span><span class="n">pmex_index</span><span class="p">))</span><span class="o">+</span><span class="n">subgrid_EMEP_semilocal_from_in_region</span><span class="p">(:,:,:,</span><span class="n">traffic_nonexhaust_nc_index</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span>
<span class="w">                                    </span><span class="k">end if</span>
<span class="k">                                endif</span>
<span class="k">                            else</span>
<span class="k">                                </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_nc</span><span class="p">(</span><span class="n">conc_nc_index</span><span class="p">,</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">),</span><span class="n">allsource_index</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;_&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_append</span><span class="p">)</span>
<span class="w">                                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                    </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">local_subgrid_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span>
<span class="w">                                </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                    </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">subgrid_local_from_in_region</span><span class="p">(:,:,:,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span>
<span class="w">                                </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                    </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">local_subgrid_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span><span class="o">-</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">emep_local_subgrid_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span><span class="o">+</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">emep_additional_local_subgrid_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span>
<span class="w">                                </span><span class="k">else</span><span class="w"> </span><span class="c">! source_domain_loop == 6</span>
<span class="w">                                    </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">subgrid_local_from_in_region</span><span class="p">(:,:,:,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span><span class="o">+</span><span class="n">subgrid_EMEP_semilocal_from_in_region</span><span class="p">(:,:,:,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span>
<span class="w">                                </span><span class="k">endif</span>
<span class="k">                            endif</span>
<span class="w">                            </span><span class="c">! Convert to fractions</span>
<span class="w">                            </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="n">save_netcdf_fraction_as_contribution_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">temp_subgrid</span><span class="o">/</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">total_subgrid_index</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="mf">0.</span>
<span class="w">                            </span><span class="k">end if</span>
<span class="w">                            </span><span class="c">!In case of any 0 concentrations when using the fractional contributions</span>
<span class="w">                            </span><span class="k">where</span><span class="w"> </span><span class="p">(</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">total_subgrid_index</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="mi">0</span>

<span class="w">                            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">                                </span><span class="c">!write(unit_logfile,&#39;(a,f12.3)&#39;)&#39;Writing netcdf variable: &#39;//trim(var_name_temp),sum(temp_subgrid)/size(temp_subgrid,1)/size(temp_subgrid,2)/size(temp_subgrid,3)</span>
<span class="w">                                </span><span class="c">!write(unit_logfile,&#39;(a,f12.3)&#39;)&#39;Writing netcdf variable: &#39;//trim(var_name_temp), mean_nodata(temp_subgrid,size(temp_subgrid,1),size(temp_subgrid,2),size(temp_subgrid,3),NODATA_value)</span>
<span class="w">                                </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="w"> </span><span class="n">mean_mask</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">use_subgrid</span><span class="p">(:,:,</span><span class="n">allsource_index</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>


<span class="w">                                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                            </span><span class="k">endif</span>
<span class="k">                            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="w"> </span><span class="n">mean_mask</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">use_subgrid</span><span class="p">(:,:,</span><span class="n">allsource_index</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="w">                                </span><span class="c">! write(unit_logfile,&#39;(a,f12.3)&#39;)&#39;Writing netcdf receptor variable: &#39;//trim(var_name_temp),sum(temp_subgrid)/size(temp_subgrid,1)/size(temp_subgrid,2)/size(temp_subgrid,3)</span>
<span class="w">                                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                            </span><span class="k">endif</span>

<span class="k">                        endif</span>

<span class="w">                        </span><span class="c">!Special case for exhaust as this must be given as a fraction for both PM2.5 and PM10.</span>
<span class="w">                        </span><span class="c">!if ((pollutant_loop_index(i_pollutant).eq.pm10_index.or.pollutant_loop_index(i_pollutant).eq.pm25_index).and.i_source.eq.traffic_index) then</span>
<span class="w">                        </span><span class="c">!Write all exhaust pollutants except the pmex</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i_source</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">traffic_index</span><span class="p">.</span><span class="nb">and</span><span class="p">.(.</span><span class="nb">not</span><span class="p">.</span><span class="n">pollutant_index</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">all_totals_nc_index</span><span class="p">.</span><span class="nb">and</span><span class="p">..</span><span class="nb">not</span><span class="p">.</span><span class="n">pollutant_index</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">aaqd_totals_nc_index</span><span class="p">.</span><span class="nb">and</span><span class="p">..</span><span class="nb">not</span><span class="p">.</span><span class="n">pollutant_index</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">gp_totals_nc_index</span><span class="p">.</span><span class="nb">and</span><span class="p">..</span><span class="nb">not</span><span class="p">.</span><span class="n">pollutant_index</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">op_totals_nc_index</span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="n">nox_index</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>

<span class="w">                            </span><span class="c">!If PM then exhaust output is exhaust</span>
<span class="w">                            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="n">pm10_index</span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="n">pm25_index</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                    </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">local_subgrid_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">,</span><span class="n">pollutant_loop_back_index</span><span class="p">(</span><span class="n">pmex_index</span><span class="p">))</span>
<span class="w">                                </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                    </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">subgrid_local_from_in_region</span><span class="p">(:,:,:,</span><span class="n">i_source</span><span class="p">,</span><span class="n">pollutant_loop_back_index</span><span class="p">(</span><span class="n">pmex_index</span><span class="p">))</span>
<span class="w">                                </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                    </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">local_subgrid_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">,</span><span class="n">pollutant_loop_back_index</span><span class="p">(</span><span class="n">pmex_index</span><span class="p">))</span><span class="o">-</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">emep_local_subgrid_index</span><span class="p">,</span><span class="n">traffic_exhaust_nc_index</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span><span class="o">+</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">emep_additional_local_subgrid_index</span><span class="p">,</span><span class="n">traffic_exhaust_nc_index</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span>
<span class="w">                                </span><span class="k">else</span><span class="w"> </span><span class="c">!source_domain_loop == 6</span>
<span class="w">                                    </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">subgrid_local_from_in_region</span><span class="p">(:,:,:,</span><span class="n">i_source</span><span class="p">,</span><span class="n">pollutant_loop_back_index</span><span class="p">(</span><span class="n">pmex_index</span><span class="p">))</span><span class="o">+</span><span class="n">subgrid_EMEP_semilocal_from_in_region</span><span class="p">(:,:,:,</span><span class="n">traffic_exhaust_nc_index</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span>
<span class="w">                                </span><span class="k">end if</span>
<span class="k">                            else</span>
<span class="k">                                if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                    </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">local_subgrid_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span>
<span class="w">                                </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                    </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">subgrid_local_from_in_region</span><span class="p">(:,:,:,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span>
<span class="w">                                </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                    </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">local_subgrid_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span><span class="o">-</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">emep_local_subgrid_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span><span class="o">+</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">emep_additional_local_subgrid_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span>
<span class="w">                                </span><span class="k">else</span><span class="w"> </span><span class="c">!source_domain_loop == 6</span>
<span class="w">                                    </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">subgrid_local_from_in_region</span><span class="p">(:,:,:,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span><span class="o">+</span><span class="n">subgrid_EMEP_semilocal_from_in_region</span><span class="p">(:,:,:,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span>
<span class="w">                                </span><span class="k">end if</span>
<span class="k">                            endif</span>
<span class="k">                            </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_nc</span><span class="p">(</span><span class="n">conc_nc_index</span><span class="p">,</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">),</span><span class="n">allsource_index</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;_&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;_exhaust&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_append</span><span class="p">)</span>
<span class="w">                            </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="n">save_netcdf_fraction_as_contribution_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">temp_subgrid</span><span class="o">/</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">total_subgrid_index</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="mf">0.</span>
<span class="w">                            </span><span class="k">end if</span>
<span class="k">                            where</span><span class="w"> </span><span class="p">(</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">total_subgrid_index</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="mi">0</span>

<span class="w">                            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">                                </span><span class="c">!write(unit_logfile,&#39;(a,f12.3)&#39;)&#39;Writing netcdf variable: &#39;//trim(var_name_temp),sum(temp_subgrid)/size(temp_subgrid,1)/size(temp_subgrid,2)/size(temp_subgrid,3)</span>
<span class="w">                                </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="w"> </span><span class="n">mean_mask</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">use_subgrid</span><span class="p">(:,:,</span><span class="n">allsource_index</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="w">                                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                            </span><span class="k">endif</span>
<span class="k">                            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="w"> </span><span class="n">mean_mask</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">use_subgrid</span><span class="p">(:,:,</span><span class="n">allsource_index</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="w">                                </span><span class="c">!write(unit_logfile,&#39;(a,f12.3)&#39;)&#39;Writing netcdf receptor variable: &#39;//trim(var_name_temp),sum(temp_subgrid)/size(temp_subgrid,1)/size(temp_subgrid,2)/size(temp_subgrid,3)</span>
<span class="w">                                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                            </span><span class="k">endif</span>

<span class="k">                        endif</span>
<span class="k">                    endif</span>

<span class="w">                    </span><span class="c">!Special case for salt and sand</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="n">pm25_sand_index</span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="n">pm10_sand_index</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="n">pm25_salt_index</span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="n">pm10_salt_index</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">                        </span><span class="c">!Save the nonexhaust sand and salt</span>
<span class="w">                        </span><span class="c">! NB: sand and salt do not have EMEP contributions, so total is the same as local</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i_source</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">traffic_index</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                            </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_nc</span><span class="p">(</span><span class="n">conc_nc_index</span><span class="p">,</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">),</span><span class="n">allsource_index</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;_&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_append</span><span class="p">)</span>
<span class="w">                            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">local_subgrid_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span>
<span class="w">                            </span><span class="k">else</span><span class="w">  </span><span class="c">! 2 or 6</span>
<span class="w">                                </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">subgrid_local_from_in_region</span><span class="p">(:,:,:,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span>
<span class="w">                            </span><span class="k">end if</span>
<span class="k">                            if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="n">save_netcdf_fraction_as_contribution_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">                                </span><span class="c">!temp_subgrid=subgrid(:,:,:,local_subgrid_index,i_source,i_pollutant)</span>
<span class="w">                                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="n">pm10_sand_index</span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="n">pm10_salt_index</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                    </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">temp_subgrid</span><span class="o">/</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">total_subgrid_index</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">,</span><span class="n">pollutant_loop_back_index</span><span class="p">(</span><span class="n">pm10_index</span><span class="p">))</span><span class="o">*</span><span class="mi">10</span><span class="mf">0.</span>
<span class="w">                                </span><span class="k">else</span>
<span class="k">                                    </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">temp_subgrid</span><span class="o">/</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">total_subgrid_index</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">,</span><span class="n">pollutant_loop_back_index</span><span class="p">(</span><span class="n">pm25_index</span><span class="p">))</span><span class="o">*</span><span class="mi">10</span><span class="mf">0.</span>
<span class="w">                                </span><span class="k">endif</span>

<span class="k">                            endif</span>
<span class="k">                            where</span><span class="w"> </span><span class="p">(</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">total_subgrid_index</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="mi">0</span>

<span class="w">                            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="w"> </span><span class="n">mean_mask</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">use_subgrid</span><span class="p">(:,:,</span><span class="n">allsource_index</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="w">                                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                            </span><span class="k">endif</span>
<span class="k">                            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                            </span><span class="k">endif</span>

<span class="k">                        endif</span>
<span class="k">                    endif</span>
<span class="k">                end do</span><span class="w">  </span><span class="c">! i_source</span>
<span class="w">            </span><span class="k">end do</span><span class="w">  </span><span class="c">! i_pollutant</span>
<span class="w">        </span><span class="k">end do</span><span class="w">  </span><span class="c">! source_domain_loop</span>

<span class="w">        </span><span class="c">! Save the total nonlocal contributions from EMEP (not saving it for in-region domains!)</span>
<span class="w">        </span><span class="c">! 1 = nonlocal to the moving window</span>
<span class="w">        </span><span class="c">! 2 = not used, but kept for consistency with other source_domain_loop loops</span>
<span class="w">        </span><span class="c">! 3 = nonlocal to the additional domain</span>
<span class="w">        </span><span class="k">do </span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">cycle</span>
<span class="k">            write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;-------------------------------&#39;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Saving nonlocal contributions&#39;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Saving additional nonlocal contributions&#39;</span>
<span class="w">            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;-------------------------------&#39;</span>
<span class="w">            </span><span class="k">do </span><span class="n">i_pollutant</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">n_pollutant_loop</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">ne</span><span class="p">.</span><span class="n">pmex_index</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">ne</span><span class="p">.</span><span class="n">pm25_sand_index</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">ne</span><span class="p">.</span><span class="n">pm10_sand_index</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">ne</span><span class="p">.</span><span class="n">pm25_salt_index</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">ne</span><span class="p">.</span><span class="n">pm10_salt_index</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                        if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="p">(</span><span class="n">save_source_contributions</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="n">save_emep_source_contributions</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="n">save_total_source_contributions</span><span class="p">))</span><span class="w"> </span><span class="k">cycle</span>
<span class="k">                        </span><span class="n">i_file</span><span class="o">=</span><span class="n">emep_subgrid_nonlocal_file_index</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">)</span>
<span class="w">                        </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">emep_nonlocal_subgrid_index</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span>
<span class="w">                    </span><span class="k">else</span><span class="w"> </span><span class="c">! source_domain_loop == 3</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="p">(</span><span class="n">EMEP_additional_grid_interpolation_size</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="p">(</span><span class="n">save_emep_additional_source_contributions</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="n">save_total_source_contributions</span><span class="p">)))</span><span class="w"> </span><span class="k">cycle</span>
<span class="k">                        </span><span class="n">i_file</span><span class="o">=</span><span class="n">emep_additional_subgrid_nonlocal_file_index</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">)</span>
<span class="w">                        </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">emep_additional_nonlocal_subgrid_index</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span>
<span class="w">                    </span><span class="k">end if</span>
<span class="k">                    </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_nc</span><span class="p">(</span><span class="n">conc_nc_index</span><span class="p">,</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">),</span><span class="n">allsource_index</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;_&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_fraction_as_contribution_flag</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">                        </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">temp_subgrid</span><span class="o">/</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">total_subgrid_index</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="mf">0.</span>
<span class="w">                    </span><span class="k">end if</span>
<span class="k">                    where</span><span class="w"> </span><span class="p">(</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">total_subgrid_index</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="mi">0</span>

<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                        write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="w"> </span><span class="n">mean_mask</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">use_subgrid</span><span class="p">(:,:,</span><span class="n">allsource_index</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="w">                        </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                            </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                            </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                    </span><span class="k">endif</span>
<span class="k">                    if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                        write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                        </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                            </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                            </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                            </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                            </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                            </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                            </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                    </span><span class="k">endif</span>
<span class="k">                end if</span>
<span class="k">            enddo</span><span class="w">  </span><span class="c">! i_pollutant</span>
<span class="w">        </span><span class="k">end do</span><span class="w">  </span><span class="c">! source_domain_loop</span>


<span class="w">        </span><span class="c">! Calculate and save NO2 and O3 source contributions</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_no2_source_contributions</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="n">save_o3_source_contributions</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>

<span class="w">            </span><span class="c">! Calculate NO2 and O3 source contributions</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">EMEP_additional_grid_interpolation_size</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                </span><span class="n">calculate_EMEP_additional_grid_flag</span><span class="o">=</span><span class="p">.</span><span class="n">true</span><span class="p">.</span>
<span class="w">                </span><span class="k">call </span><span class="n">uEMEP_source_fraction_chemistry</span>
<span class="w">            </span><span class="k">endif</span>

<span class="k">            </span><span class="n">calculate_EMEP_additional_grid_flag</span><span class="o">=</span><span class="p">.</span><span class="n">false</span><span class="p">.</span>
<span class="w">            </span><span class="k">call </span><span class="n">uEMEP_source_fraction_chemistry</span>

<span class="w">            </span><span class="c">! Save the contributions to file</span>
<span class="w">            </span><span class="c">! 1 = normal source contributions from within moving window</span>
<span class="w">            </span><span class="c">! 2 = source contributions cut down to region</span>
<span class="w">            </span><span class="c">! 3 = additional nonlocal</span>
<span class="w">            </span><span class="c">! 4 = semilocal contribution from in region, based on background</span>
<span class="w">            </span><span class="c">! 5 = not used, but kept to be consistent with other loops over &quot;source_domain_loop&quot;</span>
<span class="w">            </span><span class="c">! 6 = total contribution from in region = 2+4</span>
<span class="w">            </span><span class="k">do </span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span>
<span class="w">                </span>
<span class="w">                </span><span class="c">! Skip this round in the loop if this type of source contributions are not to be saved</span>
<span class="w">                </span><span class="c">! or set appropriate variable name extension</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="n">save_source_contributions</span><span class="p">)</span><span class="w"> </span><span class="k">cycle</span>
<span class="k">                    </span><span class="n">filename_append</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
<span class="w">                </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="p">(</span><span class="n">trace_emissions_from_in_region</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">save_local_source_contributions_from_in_region</span><span class="p">))</span><span class="w"> </span><span class="k">cycle</span>
<span class="k">                    </span><span class="n">filename_append</span><span class="o">=</span><span class="s1">&#39;_from_in_region&#39;</span>
<span class="w">                </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="p">(</span><span class="n">EMEP_additional_grid_interpolation_size</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">0</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="p">(</span><span class="n">save_emep_additional_source_contributions</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="n">save_total_source_contributions</span><span class="p">)))</span><span class="w"> </span><span class="k">cycle</span>
<span class="k">                    </span><span class="n">filename_append</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
<span class="w">                </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="p">(</span><span class="n">trace_emissions_from_in_region</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">save_semilocal_source_contributions_from_in_region</span><span class="p">))</span><span class="w"> </span><span class="k">cycle</span>
<span class="k">                    </span><span class="n">filename_append</span><span class="o">=</span><span class="s1">&#39;_from_in_region&#39;</span>
<span class="w">                </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    cycle</span>
<span class="k">                else</span><span class="w">  </span><span class="c">! source_domain_loop == 6</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="p">(</span><span class="n">trace_emissions_from_in_region</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">save_total_source_contributions_from_in_region</span><span class="p">))</span><span class="w"> </span><span class="k">cycle</span>
<span class="k">                    </span><span class="n">filename_append</span><span class="o">=</span><span class="s1">&#39;_from_in_region&#39;</span>
<span class="w">                </span><span class="k">end if</span>

<span class="k">                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;-------------------------------&#39;</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Saving local NO2 and O3 contributions&#39;</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Saving local NO2 and O3 contributions from-in-region&#39;</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Saving additional nonlocal NO2 and O3 contributions&#39;</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Saving semilocal NO2 and O3 contributions from-in-region&#39;</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">6</span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Saving total NO2 and O3 contributions from-in-region&#39;</span>
<span class="w">                </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;-------------------------------&#39;</span>

<span class="w">                </span><span class="c">! Save NO2 in round 1 and O3 in round 2</span>
<span class="w">                </span><span class="k">do </span><span class="n">no2_o3_loop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span>

<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">no2_o3_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w">  </span><span class="c">! no2</span>
<span class="w">                        </span><span class="n">comp_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">no2_index</span>
<span class="w">                        </span><span class="n">comp_nc_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">no2_nc_index</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="n">save_no2_source_contributions</span><span class="p">)</span><span class="w"> </span><span class="k">cycle</span>

<span class="k">                        </span><span class="n">valid_min</span><span class="o">=</span><span class="mf">0.</span>

<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_fraction_as_contribution_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                            </span><span class="n">variable_type</span><span class="o">=</span><span class="s1">&#39;float&#39;</span>
<span class="w">                            </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;ug/m3&quot;</span>
<span class="w">                        </span><span class="k">else</span>
<span class="k">                            </span><span class="n">variable_type</span><span class="o">=</span><span class="s1">&#39;byte&#39;</span>
<span class="w">                            </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;%&quot;</span>
<span class="w">                        </span><span class="k">endif</span>

<span class="k">                    else</span><span class="w">  </span><span class="c">! o3</span>
<span class="w">                        </span><span class="n">comp_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">o3_index</span>
<span class="w">                        </span><span class="n">comp_nc_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">o3_nc_index</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="n">save_o3_source_contributions</span><span class="p">)</span><span class="w"> </span><span class="k">cycle</span>

<span class="k">                        if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_fraction_as_contribution_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                            </span><span class="n">variable_type</span><span class="o">=</span><span class="s1">&#39;float&#39;</span>
<span class="w">                            </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;ug/m3&quot;</span>
<span class="w">                            </span><span class="n">valid_min</span><span class="o">=-</span><span class="mi">100</span><span class="mf">0.</span>
<span class="w">                        </span><span class="k">else</span>
<span class="k">                            </span><span class="n">variable_type</span><span class="o">=</span><span class="s1">&#39;short&#39;</span>
<span class="w">                            </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;%&quot;</span>
<span class="w">                            </span><span class="n">valid_min</span><span class="o">=-</span><span class="mi">10</span><span class="mf">0.</span>
<span class="w">                        </span><span class="k">endif</span>
<span class="k">                    end if</span>

<span class="k">                    do </span><span class="n">i_source</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n_source_index</span>

<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i_source</span><span class="w"> </span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="w"> </span><span class="n">allsource_index</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="n">calculate_source</span><span class="p">(</span><span class="n">i_source</span><span class="p">)</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="n">calculate_emep_source</span><span class="p">(</span><span class="n">i_source</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="w">                            </span><span class="c">!Do not save nonexhaust for exhaust gas emissions</span>
<span class="w">                            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i_source</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">traffic_nonexhaust_index</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                cycle</span>
<span class="k">                            end if</span>

<span class="k">                            if</span><span class="w"> </span><span class="p">(</span><span class="n">i_source</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">allsource_index</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">                                </span><span class="c">! Non-local contributions</span>
<span class="w">                                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">                                    </span><span class="c">! nonlocal to the normal domain</span>
<span class="w">                                    </span><span class="n">i_file</span><span class="o">=</span><span class="n">emep_subgrid_nonlocal_file_index</span><span class="p">(</span><span class="n">i_source</span><span class="p">)</span>
<span class="w">                                    </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">comp_source_EMEP_subgrid</span><span class="p">(:,:,:,</span><span class="n">comp_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">)</span>
<span class="w">                                </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">                                    </span><span class="c">! nonlocal to the additional domain</span>
<span class="w">                                    </span><span class="n">i_file</span><span class="o">=</span><span class="n">emep_additional_subgrid_nonlocal_file_index</span><span class="p">(</span><span class="n">i_source</span><span class="p">)</span>
<span class="w">                                    </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">comp_source_EMEP_additional_subgrid</span><span class="p">(:,:,:,</span><span class="n">comp_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">)</span>
<span class="w">                                </span><span class="k">else</span>
<span class="w">                                    </span><span class="c">! do not save nonlocal for the in-region versions</span>
<span class="w">                                    </span><span class="k">cycle</span>
<span class="k">                                end if</span>
<span class="k">                            else</span>
<span class="w">                                </span><span class="c">! Sector source contributions</span>
<span class="w">                                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">                                    </span><span class="c">! normal local domain</span>
<span class="w">                                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">calculate_source</span><span class="p">(</span><span class="n">i_source</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                        </span><span class="n">i_file</span><span class="o">=</span><span class="n">subgrid_local_file_index</span><span class="p">(</span><span class="n">i_source</span><span class="p">)</span>
<span class="w">                                    </span><span class="k">else</span><span class="w"> </span><span class="c">! calculate_emep_source(i_source)</span>
<span class="w">                                        </span><span class="n">i_file</span><span class="o">=</span><span class="n">emep_subgrid_local_file_index</span><span class="p">(</span><span class="n">i_source</span><span class="p">)</span>
<span class="w">                                    </span><span class="k">endif</span>
<span class="k">                                    </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">comp_source_subgrid</span><span class="p">(:,:,:,</span><span class="n">comp_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">)</span>
<span class="w">                                </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">                                    </span><span class="c">! in-region contributions within the normal local domain</span>
<span class="w">                                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">calculate_source</span><span class="p">(</span><span class="n">i_source</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                        </span><span class="n">i_file</span><span class="o">=</span><span class="n">subgrid_local_file_index</span><span class="p">(</span><span class="n">i_source</span><span class="p">)</span>
<span class="w">                                    </span><span class="k">else</span><span class="w"> </span><span class="c">! calculate_emep_source(i_source)</span>
<span class="w">                                        </span><span class="n">i_file</span><span class="o">=</span><span class="n">emep_subgrid_local_file_index</span><span class="p">(</span><span class="n">i_source</span><span class="p">)</span>
<span class="w">                                    </span><span class="k">endif</span>
<span class="k">                                    </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">comp_source_subgrid_from_in_region</span><span class="p">(:,:,:,</span><span class="n">comp_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">)</span>
<span class="w">                                </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">                                    </span><span class="c">! additional domain: save only non-local for additional domain</span>
<span class="w">                                    </span><span class="k">cycle</span>
<span class="k">                                else if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">                                    </span><span class="c">! semilocal inregion contributions</span>
<span class="w">                                    </span><span class="n">i_file</span><span class="o">=</span><span class="n">emep_subgrid_semilocal_file_index</span><span class="p">(</span><span class="n">i_source</span><span class="p">)</span>
<span class="w">                                    </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">comp_semilocal_source_subgrid_from_in_region</span><span class="p">(:,:,:,</span><span class="n">comp_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">)</span>
<span class="w">                                </span><span class="k">else</span><span class="w"> </span><span class="c">! source_domain_loop == 6</span>
<span class="w">                                    </span><span class="c">! sum of local inregion and semilocal inregion</span>
<span class="w">                                    </span><span class="n">i_file</span><span class="o">=</span><span class="n">subgrid_sourcetotal_inregion_file_index</span><span class="p">(</span><span class="n">i_source</span><span class="p">)</span>
<span class="w">                                    </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">comp_semilocal_source_subgrid_from_in_region</span><span class="p">(:,:,:,</span><span class="n">comp_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">)</span><span class="o">+</span><span class="n">comp_source_subgrid_from_in_region</span><span class="p">(:,:,:,</span><span class="n">comp_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">)</span>
<span class="w">                                </span><span class="k">end if</span>
<span class="k">                            end if</span>

<span class="w">                            </span><span class="c">! Variable name</span>
<span class="w">                            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i_source</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">traffic_index</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">comp_index</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">no2_index</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">                                </span><span class="c">! special case for no2 traffic: add exhaust to variable name</span>
<span class="w">                                </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_nc</span><span class="p">(</span><span class="n">conc_nc_index</span><span class="p">,</span><span class="n">comp_nc_index</span><span class="p">,</span><span class="n">allsource_nc_index</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;_&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;_exhaust&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_append</span><span class="p">)</span>
<span class="w">                            </span><span class="k">else</span>
<span class="k">                                </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_nc</span><span class="p">(</span><span class="n">conc_nc_index</span><span class="p">,</span><span class="n">comp_nc_index</span><span class="p">,</span><span class="n">allsource_nc_index</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;_&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_append</span><span class="p">)</span>
<span class="w">                            </span><span class="k">endif</span>

<span class="k">                            if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="n">save_netcdf_fraction_as_contribution_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">                                </span><span class="c">! Transform to fraction</span>
<span class="w">                                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">comp_index</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">o3_index</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">                                    </span><span class="c">! For O3, only include nonlocal when saving as fractions, and normalize with EMEP concentration to always get 100%</span>
<span class="w">                                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i_source</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">allsource_index</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                        </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">temp_subgrid</span><span class="o">/</span><span class="n">comp_EMEP_subgrid</span><span class="p">(:,:,:,</span><span class="n">comp_index</span><span class="p">)</span>
<span class="w">                                        </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">100</span><span class="mf">0.</span><span class="p">)</span>
<span class="w">                                        </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="o">-</span><span class="mi">10</span><span class="mf">0.</span><span class="p">)</span>
<span class="w">                                    </span><span class="k">else</span>
<span class="k">                                        cycle</span>
<span class="k">                                    end if</span>
<span class="k">                                else</span>
<span class="w">                                    </span><span class="c">! for NO2, normalize with EMEP concentration for additional, and with uEMEP concentration in all other cases</span>
<span class="w">                                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                        </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">temp_subgrid</span><span class="o">/</span><span class="n">comp_EMEP_subgrid</span><span class="p">(:,:,:,</span><span class="n">comp_index</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="mf">0.</span>
<span class="w">                                    </span><span class="k">else</span>
<span class="k">                                        </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">temp_subgrid</span><span class="o">/</span><span class="n">comp_subgrid</span><span class="p">(:,:,:,</span><span class="n">comp_index</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="mf">0.</span>
<span class="w">                                    </span><span class="k">end if</span>
<span class="k">                                end if</span>
<span class="k">                            endif</span>

<span class="w">                            </span><span class="c">! Save to file</span>
<span class="w">                            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="w"> </span><span class="n">mean_mask</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">use_subgrid</span><span class="p">(:,:,</span><span class="n">allsource_index</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="w">                                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                            </span><span class="k">endif</span>
<span class="k">                            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                            </span><span class="k">endif</span>
<span class="k">                        endif</span>
<span class="k">                    enddo</span><span class="w"> </span><span class="c">!i_source</span>

<span class="w">                </span><span class="k">end do</span><span class="w"> </span><span class="c">!no2_o3_loop</span>

<span class="w">            </span><span class="k">end do</span><span class="w">  </span><span class="c">!source_domain_loop</span>

<span class="w">            </span><span class="n">valid_min</span><span class="o">=</span><span class="mf">0.</span>

<span class="w">        </span><span class="k">end if</span><span class="w"> </span><span class="c">!(save_no2_source_contributions .or. save_o3_source_contributions)</span>


<span class="w">        </span><span class="c">!Save the emissions interpolated to the target grid</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_emissions</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;--------------------------&#39;</span>
<span class="w">            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;Saving emissions&#39;</span>
<span class="w">            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;--------------------------&#39;</span>
<span class="w">            </span><span class="n">variable_type</span><span class="o">=</span><span class="s1">&#39;float&#39;</span>
<span class="w">            </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;g/s&quot;</span>
<span class="w">            </span><span class="k">do </span><span class="n">i_pollutant</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n_pollutant_loop</span>
<span class="w">                </span><span class="k">do </span><span class="n">i_source</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n_source_index</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">calculate_source</span><span class="p">(</span><span class="n">i_source</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>

<span class="w">                        </span><span class="c">!Do not save emissions if the source is not traffic and the pollutant is road sand and salt or exhaust as these do not exist</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i_source</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="n">traffic_index</span><span class="p">.</span><span class="nb">and</span><span class="p">.(</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="n">pm25_sand_index</span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="n">pm10_sand_index</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                            </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="n">pm25_salt_index</span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="n">pm10_salt_index</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                            </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="n">pmex_index</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="w">                            </span><span class="c">!Do nothing because these pollutants only exist for traffic</span>
<span class="w">                        </span><span class="k">else</span>

<span class="k">                            </span><span class="n">i_file</span><span class="o">=</span><span class="n">emission_file_index</span><span class="p">(</span><span class="n">i_source</span><span class="p">)</span>
<span class="w">                            </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_nc</span><span class="p">(</span><span class="n">conc_nc_index</span><span class="p">,</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">),</span><span class="n">allsource_index</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;_&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span>

<span class="w">                            </span><span class="c">!Calculate the emissions in the target grid</span>
<span class="w">                            </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="mf">0.</span>
<span class="w">                            </span><span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">)</span>
<span class="w">                                </span><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">)</span>


<span class="w">                                    </span><span class="n">ii</span><span class="o">=</span><span class="n">crossreference_target_to_emission_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">x_dim_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">)</span>
<span class="w">                                    </span><span class="n">jj</span><span class="o">=</span><span class="n">crossreference_target_to_emission_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">y_dim_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">)</span>

<span class="w">                                    </span><span class="n">temp_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,:)</span><span class="o">=</span><span class="n">emission_subgrid</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,:,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span>
<span class="w">                                    </span><span class="c">!Subgrid emissions, if relevant, are in units ug/sec/subgrid. Convert to g/s. Acount for the difference in subgrid sizes here</span>
<span class="w">                                    </span><span class="n">temp_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,:)</span><span class="o">=</span><span class="mf">1.0e-6</span><span class="o">*</span><span class="n">temp_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,:)</span><span class="o">*</span><span class="p">(</span><span class="n">subgrid_delta</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">)</span><span class="o">*</span><span class="n">subgrid_delta</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                        </span><span class="o">/</span><span class="p">(</span><span class="n">emission_subgrid_delta</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">)</span><span class="o">*</span><span class="n">emission_subgrid_delta</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">))</span>

<span class="w">                                </span><span class="k">enddo</span>
<span class="k">                            enddo</span>

<span class="k">                            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,es12.2)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                            </span><span class="k">endif</span>
<span class="k">                            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,es12.2)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                            </span><span class="k">endif</span>

<span class="k">                        endif</span>

<span class="k">                    endif</span>
<span class="k">                enddo</span>
<span class="k">            enddo</span>
<span class="k">        endif</span>

<span class="w">        </span><span class="c">!Save population interpolated to the target grid</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_population</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;-------------------------------&#39;</span>
<span class="w">            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Saving population data&#39;</span>
<span class="w">            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;-------------------------------&#39;</span>
<span class="w">            </span>
<span class="w">            </span><span class="n">variable_type</span><span class="o">=</span><span class="s1">&#39;float&#39;</span>
<span class="w">            </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;inhabitants/grid&quot;</span>

<span class="w">            </span><span class="n">i_file</span><span class="o">=</span><span class="n">population_file_index</span><span class="p">(</span><span class="n">population_index</span><span class="p">)</span>
<span class="w">            </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span>

<span class="w">            </span><span class="c">!Calculate the population in the target grid</span>
<span class="w">            </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="mf">0.</span>
<span class="w">            </span><span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">)</span>
<span class="w">                </span><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">)</span>

<span class="w">                    </span><span class="n">ii</span><span class="o">=</span><span class="n">crossreference_target_to_population_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">x_dim_index</span><span class="p">)</span>
<span class="w">                    </span><span class="n">jj</span><span class="o">=</span><span class="n">crossreference_target_to_population_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">y_dim_index</span><span class="p">)</span>

<span class="w">                    </span><span class="n">temp_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,:)</span><span class="o">=</span><span class="n">population_subgrid</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">population_index</span><span class="p">)</span>
<span class="w">                    </span><span class="c">!Acount for the difference in subgrid sizes here</span>
<span class="w">                    </span><span class="n">temp_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,:)</span><span class="o">=</span><span class="n">temp_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,:)</span><span class="o">*</span><span class="p">(</span><span class="n">subgrid_delta</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">)</span><span class="o">*</span><span class="n">subgrid_delta</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="o">/</span><span class="p">(</span><span class="n">population_subgrid_delta</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">)</span><span class="o">*</span><span class="n">population_subgrid_delta</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">))</span>

<span class="w">                </span><span class="k">enddo</span>
<span class="k">            enddo</span>

<span class="k">            </span><span class="n">unit_str</span><span class="o">=</span><span class="s1">&#39;inhabitants/grid&#39;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="w"> </span><span class="n">mean_mask</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">use_subgrid</span><span class="p">(:,:,</span><span class="n">allsource_index</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="w">                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">            </span><span class="k">endif</span>
<span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">            </span><span class="k">endif</span>

<span class="k">        endif</span>

<span class="w">        </span><span class="c">! Save region mask at target subgrid</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">trace_emissions_from_in_region</span><span class="p">)</span><span class="w"> </span><span class="k">then</span><span class="w">  </span><span class="c">!! .or. use_region_select_and_mask_flag ??</span>
<span class="w">            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;-------------------------------&#39;</span>
<span class="w">            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Saving region mask&#39;</span>
<span class="w">            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;-------------------------------&#39;</span>

<span class="w">            </span><span class="n">variable_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;short&#39;</span>
<span class="w">            </span><span class="n">var_name_temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;region_index&#39;</span>
<span class="w">            </span><span class="n">unit_str</span><span class="o">=</span><span class="s1">&#39;1&#39;</span><span class="w">  </span><span class="c">!!!!!!! what to write here???</span>
<span class="w">            </span><span class="n">temp_subgrid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.</span>
<span class="w">            </span><span class="k">do </span><span class="n">tt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span>
<span class="w">                </span><span class="c">! add 0.1 to all values to avoid them being rounded down to 1 less than original value</span>
<span class="w">                </span><span class="n">temp_subgrid</span><span class="p">(:,:,</span><span class="n">tt</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">subgrid_region_index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.1</span>
<span class="w">            </span><span class="k">end do</span>
<span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">)</span>
<span class="w">                </span><span class="c">! NB: hard-coding scale_factor=1 since it does not make sense to have scale_factor for an ID variable!</span>
<span class="w">                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="mf">1.</span><span class="p">)</span>
<span class="w">            </span><span class="k">endif</span>
<span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">                </span><span class="c">! check if region is the same for the whole grid. If not, set to zero to avoid getting wrong ID when interpolating</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="p">(</span><span class="nb">minval</span><span class="p">(</span><span class="n">subgrid_region_index</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">maxval</span><span class="p">(</span><span class="n">subgrid_region_index</span><span class="p">)))</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(A)&#39;</span><span class="p">)</span><span class="w"> </span><span class="s1">&#39;Warning: Not the same region_index for the whole receptor grid. Setting to 0.&#39;</span>
<span class="w">                    </span><span class="n">temp_subgrid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.</span>
<span class="w">                </span><span class="k">end if</span>
<span class="k">                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="mf">1.</span><span class="p">)</span>
<span class="w">            </span><span class="k">endif</span>
<span class="k">        end if</span>

<span class="w">        </span><span class="c">! Save EMEP allsources</span>
<span class="w">        </span><span class="c">! NB: For now, this is always saved</span>
<span class="w">        </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;--------------------------&#39;</span>
<span class="w">        </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;Saving EMEP allsources&#39;</span>
<span class="w">        </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;--------------------------&#39;</span>
<span class="w">        </span><span class="k">do </span><span class="n">i_pollutant</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n_emep_pollutant_loop</span>
<span class="w">            </span><span class="c">!EMEP does not have all pollutants so only save to n_emep_pollutant_loop</span>
<span class="w">            </span><span class="c">!Only save the allsource value here &#39;EMEP_allsources&#39;</span>
<span class="w">            </span><span class="n">variable_type</span><span class="o">=</span><span class="s1">&#39;float&#39;</span>
<span class="w">            </span><span class="n">i_file</span><span class="o">=</span><span class="n">emep_subgrid_file_index</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">)</span>
<span class="w">            </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_nc</span><span class="p">(</span><span class="n">conc_nc_index</span><span class="p">,</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">),</span><span class="n">allsource_index</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;_&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span>
<span class="w">            </span><span class="n">unit_str</span><span class="o">=</span><span class="s1">&#39;ug/m3&#39;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">emep_subgrid_index</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">))</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">emep_subgrid_index</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">            </span><span class="k">endif</span>
<span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">emep_subgrid_index</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">))</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">emep_subgrid_index</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">            </span><span class="k">endif</span>
<span class="k">        end do</span>

<span class="w">        </span><span class="c">!Save the EMEP data interpolated to the subgrid. These are based on the gridded concentrations</span>
<span class="w">        </span><span class="c">! Loop over 5 different verions</span>
<span class="w">        </span><span class="c">! 1 = emep local contributions from the moving-window (downscaling domain)</span>
<span class="w">        </span><span class="c">! 2 = As 1, but only the part of the moving window that is within the receptor region</span>
<span class="w">        </span><span class="c">! 3 = emep additional local contributions, extending further using larger LF grid</span>
<span class="w">        </span><span class="c">! 4 = Semilocal contribution, i.e. outside moving-window but inside the receptor region</span>
<span class="w">        </span><span class="c">! 5 = total contribution: Same as 3 (but saved as a different name and under different flag)</span>
<span class="w">        </span><span class="c">! 6 = total contribution from_in_region = 2+4, only for sources not downscaled</span>
<span class="w">        </span><span class="k">do </span><span class="n">source_domain_loop</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">6</span>

<span class="w">            </span><span class="c">! check if this version of source contributions should be saved</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="n">save_emep_source_contributions</span><span class="p">)</span><span class="w"> </span><span class="k">cycle</span>
<span class="k">                </span><span class="n">filename_append</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;</span>
<span class="w">            </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="p">(</span><span class="n">save_local_source_contributions_from_in_region</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">trace_emissions_from_in_region</span><span class="p">))</span><span class="w"> </span><span class="k">cycle</span>
<span class="k">                </span><span class="n">filename_append</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;_from_in_region&#39;</span>
<span class="w">            </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="p">(</span><span class="n">save_emep_additional_source_contributions</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">EMEP_additional_grid_interpolation_size</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="k">cycle</span>
<span class="k">                </span><span class="n">filename_append</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;</span>
<span class="w">            </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="p">(</span><span class="n">save_semilocal_source_contributions_from_in_region</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">trace_emissions_from_in_region</span><span class="p">))</span><span class="w"> </span><span class="k">cycle</span>
<span class="k">                </span><span class="n">filename_append</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;_from_in_region&#39;</span>
<span class="w">            </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="p">(</span><span class="n">save_total_source_contributions</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">EMEP_additional_grid_interpolation_size</span><span class="p">.</span><span class="n">gt</span><span class="p">.</span><span class="mi">0</span><span class="p">))</span><span class="w"> </span><span class="k">cycle</span>
<span class="k">                </span><span class="n">filename_append</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;&#39;</span>
<span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="c">!source_domain_loop == 6</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="p">(</span><span class="n">save_total_source_contributions_from_in_region</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">trace_emissions_from_in_region</span><span class="p">))</span><span class="w"> </span><span class="k">cycle</span>
<span class="k">                </span><span class="n">filename_append</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;_from_in_region&#39;</span>
<span class="w">            </span><span class="k">end if</span>

<span class="k">            write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;--------------------------&#39;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;Saving EMEP contributions&#39;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;Saving EMEP contributions from in region&#39;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;Saving EMEP additional contributions&#39;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;Saving EMEP semilocal contributions from in region&#39;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;Saving total contributions&#39;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="mi">6</span><span class="p">)</span><span class="w"> </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;Saving total contributions from in region&#39;</span>
<span class="w">            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;--------------------------&#39;</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_fraction_as_contribution_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                </span><span class="n">variable_type</span><span class="o">=</span><span class="s1">&#39;float&#39;</span>
<span class="w">                </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;ug/m3&quot;</span>
<span class="w">            </span><span class="k">else</span>
<span class="k">                </span><span class="n">variable_type</span><span class="o">=</span><span class="s1">&#39;byte&#39;</span>
<span class="w">                </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;%&quot;</span>
<span class="w">            </span><span class="k">endif</span>

<span class="k">            do </span><span class="n">i_pollutant</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n_emep_pollutant_loop</span>
<span class="w">                </span><span class="c">!EMEP does not have all pollutants so only save to n_emep_pollutant_loop</span>
<span class="w">                </span><span class="k">do </span><span class="n">i_source</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n_source_index</span>
<span class="w">                    </span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">calculate_source</span><span class="p">(</span><span class="n">i_source</span><span class="p">).</span><span class="nb">or</span><span class="p">.</span><span class="n">save_EMEP_source</span><span class="p">(</span><span class="n">i_source</span><span class="p">).</span><span class="nb">or</span><span class="p">.</span><span class="n">i_source</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">allsource_index</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>

<span class="w">                        </span><span class="c">!Do not save for the additional GNFR sources</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i_source</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">traffic_gasoline_nc_index</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="n">i_source</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">traffic_diesel_nc_index</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="n">i_source</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">traffic_gas_nc_index</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="n">i_source</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">publicpower_point_nc_index</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="n">i_source</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">publicpower_area_nc_index</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                            cycle</span>
<span class="k">                        end if</span>

<span class="w">                        </span><span class="c">!Do not save nonexhaust for exhaust gas emissions</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i_source</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">traffic_nonexhaust_nc_index</span><span class="p">.</span><span class="nb">and</span><span class="p">.(</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="n">no2_index</span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="n">nox_index</span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="n">o3_index</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">                            cycle</span>
<span class="k">                        end if</span>

<span class="k">                        if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">                            </span><span class="c">! local EMEP contribution</span>
<span class="w">                            </span><span class="n">i_file</span><span class="o">=</span><span class="n">emep_subgrid_local_file_index</span><span class="p">(</span><span class="n">i_source</span><span class="p">)</span>
<span class="w">                            </span><span class="n">temp_subgrid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">emep_local_subgrid_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span>
<span class="w">                        </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">                            </span><span class="c">! local EMEP contribution cut down to in-region</span>
<span class="w">                            </span><span class="n">i_file</span><span class="o">=</span><span class="n">emep_subgrid_local_file_index</span><span class="p">(</span><span class="n">i_source</span><span class="p">)</span>
<span class="w">                            </span><span class="n">temp_subgrid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">subgrid_EMEP_local_from_in_region</span><span class="p">(:,:,:,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span>
<span class="w">                        </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">                            </span><span class="c">! additional local EMEP contribution</span>
<span class="w">                            </span><span class="n">i_file</span><span class="o">=</span><span class="n">emep_additional_subgrid_local_file_index</span><span class="p">(</span><span class="n">i_source</span><span class="p">)</span>
<span class="w">                            </span><span class="n">temp_subgrid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">emep_additional_local_subgrid_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span>
<span class="w">                        </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">                            </span><span class="c">! semilocal EMEP contribution</span>
<span class="w">                            </span><span class="n">i_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">emep_subgrid_semilocal_file_index</span><span class="p">(</span><span class="n">i_source</span><span class="p">)</span>
<span class="w">                            </span><span class="n">temp_subgrid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">subgrid_EMEP_semilocal_from_in_region</span><span class="p">(:,:,:,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span>
<span class="w">                        </span><span class="k">else</span><span class="w">   </span><span class="c">! source_domain_loop is 5 or 6</span>
<span class="w">                            </span><span class="c">! Only save total for non-downscaled sources, since downscaled sources were saved earlier</span>
<span class="w">                            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i_source</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">allsource_index</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="n">calculate_source</span><span class="p">(</span><span class="n">i_source</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                cycle</span>
<span class="k">                            else if</span><span class="w"> </span><span class="p">((</span><span class="n">i_source</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">traffic_exhaust_nc_index</span><span class="w"> </span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="w"> </span><span class="n">i_source</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">traffic_nonexhaust_nc_index</span><span class="p">)</span><span class="w"> </span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="w"> </span><span class="n">calculate_source</span><span class="p">(</span><span class="n">traffic_index</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="w">                                </span><span class="c">! if traffic is downscaled, then total contributions to traffic exhaust and nonexhaust are saved earlier in the subroutine using downscaled local contributions</span>
<span class="w">                                </span><span class="k">cycle</span>
<span class="k">                            end if</span>
<span class="k">                            if</span><span class="w"> </span><span class="p">(</span><span class="n">source_domain_loop</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">                                </span><span class="c">! EMEP contribution from additional domain</span>
<span class="w">                                </span><span class="n">i_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">subgrid_sourcetotal_file_index</span><span class="p">(</span><span class="n">i_source</span><span class="p">)</span>
<span class="w">                                </span><span class="n">temp_subgrid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">emep_additional_local_subgrid_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span>
<span class="w">                            </span><span class="k">else</span><span class="w"> </span><span class="c">!source_domain_loop == 6</span>
<span class="w">                                </span><span class="c">! sum of EMEP local and EMEP semilocal contribution</span>
<span class="w">                                </span><span class="n">i_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">subgrid_sourcetotal_inregion_file_index</span><span class="p">(</span><span class="n">i_source</span><span class="p">)</span>
<span class="w">                                </span><span class="n">temp_subgrid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">subgrid_EMEP_local_from_in_region</span><span class="p">(:,:,:,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">subgrid_EMEP_semilocal_from_in_region</span><span class="p">(:,:,:,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span>
<span class="w">                            </span><span class="k">end if</span>
<span class="k">                        end if</span>

<span class="k">                        </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_nc</span><span class="p">(</span><span class="n">conc_nc_index</span><span class="p">,</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">),</span><span class="n">allsource_index</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;_&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_append</span><span class="p">)</span>
<span class="w">                        </span><span class="c">!if (i_source.eq.traffic_exhaust_nc_index) var_name_temp=var_name_temp//&#39;_exhaust&#39;</span>
<span class="w">                        </span><span class="c">!if (i_source.eq.traffic_nonexhaust_nc_index) var_name_temp=var_name_temp//&#39;_nonexhaust&#39;</span>
<span class="w">                        </span><span class="c">! Transform to fraction</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="w"> </span><span class="n">save_netcdf_fraction_as_contribution_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                            </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">temp_subgrid</span><span class="o">/</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">emep_subgrid_index</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="mf">0.</span>
<span class="w">                            </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">100</span><span class="mf">0.</span><span class="p">)</span>
<span class="w">                            </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="o">-</span><span class="mi">100</span><span class="mf">0.</span><span class="p">)</span>
<span class="w">                        </span><span class="k">endif</span>
<span class="k">                        if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                            write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="w"> </span><span class="n">mean_mask</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">use_subgrid</span><span class="p">(:,:,</span><span class="n">allsource_index</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="w">                            </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                        </span><span class="k">endif</span>
<span class="k">                        if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                            write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                            </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                        </span><span class="k">endif</span>

<span class="k">                    endif</span>
<span class="k">                enddo</span><span class="w"> </span><span class="c">! i_source</span>
<span class="w">            </span><span class="k">enddo</span><span class="w"> </span><span class="c">! i_pollutant</span>

<span class="w">        </span><span class="k">enddo</span><span class="w"> </span><span class="c">!source_domain_loop</span>

<span class="w">        </span><span class="c">!Save the other interpolated EMEP compounds used for nox chemistry as well. These are based on the surface comp values</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_for_chemistry</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;--------------------------&#39;</span>
<span class="w">            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;Saving for offline chemistry&#39;</span>
<span class="w">            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;--------------------------&#39;</span>
<span class="w">            </span><span class="n">variable_type</span><span class="o">=</span><span class="s1">&#39;float&#39;</span>
<span class="w">            </span><span class="k">do </span><span class="n">i_pollutant</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n_emep_pollutant_loop</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="n">nox_index</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    do </span><span class="n">i_loop</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n_pollutant_compound_loop</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">)</span>

<span class="w">                        </span><span class="n">i_comp</span><span class="o">=</span><span class="n">pollutant_compound_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">,</span><span class="n">i_loop</span><span class="p">)</span>

<span class="w">                        </span><span class="c">!Somo35 may be included here. Do not include it if it is.</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i_comp</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="n">somo35_nc_index</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>

<span class="k">                            </span><span class="n">i_file</span><span class="o">=</span><span class="n">emep_subgrid_file_index</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">)</span>
<span class="w">                            </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_nc</span><span class="p">(</span><span class="n">conc_nc_index</span><span class="p">,</span><span class="n">i_comp</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;_forchemistry&#39;</span><span class="o">//</span><span class="s1">&#39;_&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span>
<span class="w">                            </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">comp_EMEP_subgrid</span><span class="p">(:,:,:,</span><span class="n">i_comp</span><span class="p">)</span>
<span class="w">                            </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;ug/m3&quot;</span>
<span class="w">                            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="w"> </span><span class="n">mean_mask</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">use_subgrid</span><span class="p">(:,:,</span><span class="n">allsource_index</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="w">                                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                            </span><span class="k">endif</span>
<span class="k">                            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">comp_EMEP_subgrid</span><span class="p">(:,:,:,</span><span class="n">i_comp</span><span class="p">))</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                            </span><span class="k">endif</span>

<span class="k">                        endif</span>
<span class="k">                    enddo</span>
<span class="k">                endif</span>
<span class="k">            enddo</span>
<span class="k">        endif</span>

<span class="w">        </span><span class="c">!Save weighted travel time</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_for_chemistry</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;--------------------------&#39;</span>
<span class="w">            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;Saving weighted travel time&#39;</span>
<span class="w">            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;--------------------------&#39;</span>
<span class="w">            </span><span class="n">variable_type</span><span class="o">=</span><span class="s1">&#39;float&#39;</span>
<span class="w">            </span><span class="n">var_name_temp</span><span class="o">=</span><span class="s1">&#39;Weighted_travel_time&#39;</span>
<span class="w">            </span><span class="n">unit_str</span><span class="o">=</span><span class="s1">&#39;seconds&#39;</span>
<span class="w">            </span><span class="n">i_pollutant</span><span class="o">=</span><span class="n">pollutant_loop_back_index</span><span class="p">(</span><span class="n">nox_nc_index</span><span class="p">)</span><span class="w"> </span><span class="c">!Only save the travel time for nox. Though this may be expanded for other compounds if necessary, like ammonia</span>
<span class="w">            </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">traveltime_subgrid</span><span class="p">(:,:,:,</span><span class="mi">3</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,es12.2)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                </span><span class="c">!write(unit_logfile,&#39;(a)&#39;)&#39;Writing netcdf variable: &#39;//trim(var_name_temp)</span>
<span class="w">                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">            </span><span class="k">endif</span>
<span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,es12.2)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                </span><span class="c">!write(unit_logfile,&#39;(a,f12.3)&#39;)&#39;Writing netcdf receptor variable: &#39;//trim(var_name_temp),sum(traveltime_subgrid(:,:,:,1,i_pollutant))/size(subgrid,1)/size(subgrid,2)/size(subgrid,3)</span>
<span class="w">                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">            </span><span class="k">endif</span>
<span class="k">        endif</span>

<span class="k">        if</span><span class="w"> </span><span class="p">(</span><span class="n">save_for_chemistry</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            </span><span class="n">variable_type</span><span class="o">=</span><span class="s1">&#39;float&#39;</span>
<span class="w">            </span><span class="n">i_file</span><span class="o">=</span><span class="n">subgrid_J_file_index</span>
<span class="w">            </span><span class="n">i_meteo</span><span class="o">=</span><span class="n">J_subgrid_index</span>
<span class="w">            </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;1/s&quot;</span>
<span class="w">            </span><span class="c">!The same for all--------------------</span>
<span class="w">            </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span>
<span class="w">            </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="mf">0.</span>
<span class="w">            </span><span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">)</span>
<span class="w">                </span><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">)</span>
<span class="w">                    </span><span class="n">ii</span><span class="o">=</span><span class="n">crossreference_target_to_integral_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">x_dim_index</span><span class="p">);</span><span class="n">jj</span><span class="o">=</span><span class="n">crossreference_target_to_integral_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">y_dim_index</span><span class="p">);</span><span class="n">temp_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,:)</span><span class="o">=</span><span class="n">meteo_subgrid</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,:,</span><span class="n">i_meteo</span><span class="p">)</span>
<span class="w">                </span><span class="k">enddo</span>
<span class="k">            enddo</span>
<span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,es12.2)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                </span><span class="c">!write(unit_logfile,&#39;(a)&#39;)&#39;Writing netcdf variable: &#39;//trim(var_name_temp)</span>
<span class="w">                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">            </span><span class="k">endif</span>
<span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,es12.2)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                </span><span class="c">!write(unit_logfile,&#39;(a,f12.3)&#39;)&#39;Writing netcdf receptor variable: &#39;//trim(var_name_temp),sum(temp_subgrid)/size(temp_subgrid,1)/size(temp_subgrid,2)/size(temp_subgrid,3)</span>
<span class="w">                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">            </span><span class="k">endif</span>
<span class="w">            </span><span class="c">!The same for all--------------------</span>

<span class="w">            </span><span class="c">!Save temperature if not also saving the meteo data.</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(.</span><span class="nb">not</span><span class="p">.</span><span class="n">save_other_meteo</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                </span><span class="n">variable_type</span><span class="o">=</span><span class="s1">&#39;float&#39;</span>
<span class="w">                </span><span class="n">i_file</span><span class="o">=</span><span class="n">subgrid_t2m_file_index</span>
<span class="w">                </span><span class="n">i_meteo</span><span class="o">=</span><span class="n">t2m_subgrid_index</span>
<span class="w">                </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;Celcius&quot;</span>
<span class="w">                </span><span class="c">!The same for all--------------------</span>
<span class="w">                </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span>
<span class="w">                </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="mf">0.</span>
<span class="w">                </span><span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">)</span>
<span class="w">                    </span><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">)</span>
<span class="w">                        </span><span class="n">ii</span><span class="o">=</span><span class="n">crossreference_target_to_integral_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">x_dim_index</span><span class="p">);</span><span class="n">jj</span><span class="o">=</span><span class="n">crossreference_target_to_integral_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">y_dim_index</span><span class="p">);</span><span class="n">temp_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,:)</span><span class="o">=</span><span class="n">meteo_subgrid</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,:,</span><span class="n">i_meteo</span><span class="p">)</span><span class="o">-</span><span class="mi">27</span><span class="mf">3.13</span>
<span class="w">                    </span><span class="k">enddo</span>
<span class="k">                enddo</span>
<span class="k">                if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,es12.2)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                    </span><span class="c">!write(unit_logfile,&#39;(a)&#39;)&#39;Writing netcdf variable: &#39;//trim(var_name_temp)</span>
<span class="w">                    </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                </span><span class="k">endif</span>
<span class="k">                if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,es12.2)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                    </span><span class="c">!write(unit_logfile,&#39;(a,f12.3)&#39;)&#39;Writing netcdf receptor variable: &#39;//trim(var_name_temp),sum(temp_subgrid)/size(temp_subgrid,1)/size(temp_subgrid,2)/size(temp_subgrid,3)</span>
<span class="w">                    </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                </span><span class="k">endif</span>
<span class="k">            endif</span>
<span class="k">        endif</span>

<span class="k">        if</span><span class="w"> </span><span class="p">(</span><span class="n">save_emep_species</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;--------------------------&#39;</span>
<span class="w">            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;Saving EMEP species&#39;</span>
<span class="w">            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;--------------------------&#39;</span>
<span class="w">            </span><span class="n">variable_type</span><span class="o">=</span><span class="s1">&#39;float&#39;</span>
<span class="w">            </span><span class="k">do </span><span class="n">i_sp</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n_species_loop_index</span>
<span class="w">                </span><span class="n">ii_sp</span><span class="o">=</span><span class="n">species_loop_index</span><span class="p">(</span><span class="n">i_sp</span><span class="p">)</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i_sp</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="n">sp_pm_index</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">                    </span><span class="c">!Do not include the total</span>
<span class="w">                    </span><span class="k">do </span><span class="n">i_loop</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n_pmxx_sp_index</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i_loop</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">pm25_sp_index</span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="n">i_loop</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">pm10_sp_index</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>

<span class="k">                            if</span><span class="w"> </span><span class="p">(</span><span class="n">i_loop</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">pm25_sp_index</span><span class="p">)</span><span class="w"> </span><span class="n">i_pollutant</span><span class="o">=</span><span class="n">pollutant_loop_back_index</span><span class="p">(</span><span class="n">pm25_index</span><span class="p">)</span>
<span class="w">                            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i_loop</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">pm10_sp_index</span><span class="p">)</span><span class="w"> </span><span class="n">i_pollutant</span><span class="o">=</span><span class="n">pollutant_loop_back_index</span><span class="p">(</span><span class="n">pm10_index</span><span class="p">)</span>

<span class="w">                            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_fraction_as_contribution_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                </span><span class="n">variable_type</span><span class="o">=</span><span class="s1">&#39;float&#39;</span>
<span class="w">                                </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">species_name_nc</span><span class="p">(</span><span class="n">i_loop</span><span class="p">,</span><span class="n">ii_sp</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;_nonlocal_contribution&#39;</span>
<span class="w">                                </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;ug/m3&quot;</span>
<span class="w">                                </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">species_EMEP_subgrid</span><span class="p">(:,:,:,</span><span class="n">i_loop</span><span class="p">,</span><span class="n">i_sp</span><span class="p">)</span>
<span class="w">                            </span><span class="k">else</span>
<span class="k">                                </span><span class="n">variable_type</span><span class="o">=</span><span class="s1">&#39;byte&#39;</span>
<span class="w">                                </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">species_name_nc</span><span class="p">(</span><span class="n">i_loop</span><span class="p">,</span><span class="n">i_sp</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;_nonlocal_fraction&#39;</span>
<span class="w">                                </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;%&quot;</span>
<span class="w">                                </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">species_EMEP_subgrid</span><span class="p">(:,:,:,</span><span class="n">i_loop</span><span class="p">,</span><span class="n">i_sp</span><span class="p">)</span><span class="o">/</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">total_subgrid_index</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="mf">0.</span>
<span class="w">                            </span><span class="k">endif</span>

<span class="k">                            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">(:,:,:))</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                            </span><span class="k">endif</span>
<span class="k">                            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">(:,:,:))</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                    </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                            </span><span class="k">endif</span>
<span class="k">                        endif</span>
<span class="k">                    enddo</span>
<span class="k">                endif</span>
<span class="k">            enddo</span>
<span class="k">        endif</span>

<span class="w">        </span><span class="c">!Only save sea salt in this way when emep species are not saved in the general way</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_seasalt</span><span class="p">.</span><span class="nb">and</span><span class="p">..</span><span class="nb">not</span><span class="p">.</span><span class="n">save_emep_species</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;--------------------------&#39;</span>
<span class="w">            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;Saving EMEP sea salt&#39;</span>
<span class="w">            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;--------------------------&#39;</span>
<span class="w">            </span><span class="n">variable_type</span><span class="o">=</span><span class="s1">&#39;float&#39;</span>
<span class="w">            </span><span class="n">i_sp</span><span class="o">=</span><span class="n">n_species_loop_index</span>
<span class="w">            </span><span class="n">ii_sp</span><span class="o">=</span><span class="n">species_loop_index</span><span class="p">(</span><span class="n">i_sp</span><span class="p">)</span>
<span class="w">            </span><span class="k">do </span><span class="n">i_loop</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n_pmxx_sp_index</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i_loop</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">pm25_sp_index</span><span class="p">.</span><span class="nb">or</span><span class="p">.</span><span class="n">i_loop</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">pm10_sp_index</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>

<span class="k">                    if</span><span class="w"> </span><span class="p">(</span><span class="n">i_loop</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">pm25_sp_index</span><span class="p">)</span><span class="w"> </span><span class="n">i_pollutant</span><span class="o">=</span><span class="n">pollutant_loop_back_index</span><span class="p">(</span><span class="n">pm25_index</span><span class="p">)</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i_loop</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">pm10_sp_index</span><span class="p">)</span><span class="w"> </span><span class="n">i_pollutant</span><span class="o">=</span><span class="n">pollutant_loop_back_index</span><span class="p">(</span><span class="n">pm10_index</span><span class="p">)</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_fraction_as_contribution_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                        </span><span class="n">variable_type</span><span class="o">=</span><span class="s1">&#39;float&#39;</span>
<span class="w">                        </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">species_name_nc</span><span class="p">(</span><span class="n">i_loop</span><span class="p">,</span><span class="n">ii_sp</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;_nonlocal_contribution&#39;</span>
<span class="w">                        </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;ug/m3&quot;</span>
<span class="w">                        </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">species_EMEP_subgrid</span><span class="p">(:,:,:,</span><span class="n">i_loop</span><span class="p">,</span><span class="n">i_sp</span><span class="p">)</span>
<span class="w">                    </span><span class="k">else</span>
<span class="k">                        </span><span class="n">variable_type</span><span class="o">=</span><span class="s1">&#39;byte&#39;</span>
<span class="w">                        </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">species_name_nc</span><span class="p">(</span><span class="n">i_loop</span><span class="p">,</span><span class="n">ii_sp</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;_nonlocal_fraction&#39;</span>
<span class="w">                        </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;%&quot;</span>
<span class="w">                        </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">species_EMEP_subgrid</span><span class="p">(:,:,:,</span><span class="n">i_loop</span><span class="p">,</span><span class="n">i_sp</span><span class="p">)</span><span class="o">/</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">total_subgrid_index</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span><span class="o">*</span><span class="mi">10</span><span class="mf">0.</span>
<span class="w">                    </span><span class="k">endif</span>

<span class="k">                    if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                        write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">(:,:,:))</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                        </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                            </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                            </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                    </span><span class="k">endif</span>
<span class="k">                    if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                        write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">(:,:,:))</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                        </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                            </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                            </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                            </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                            </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                            </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                            </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                    </span><span class="k">endif</span>
<span class="k">                endif</span>
<span class="k">            enddo</span>

<span class="k">        endif</span>

<span class="w">        </span><span class="c">!Save the original EMEP compounds</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_emep_original</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;--------------------------&#39;</span>
<span class="w">            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;Saving original EMEP&#39;</span>
<span class="w">            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;--------------------------&#39;</span>
<span class="w">            </span><span class="n">variable_type</span><span class="o">=</span><span class="s1">&#39;float&#39;</span>
<span class="w">            </span><span class="k">do </span><span class="n">i_pollutant</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n_emep_pollutant_loop</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">).</span><span class="n">ne</span><span class="p">.</span><span class="n">pmex_index</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    do </span><span class="n">i_loop</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n_pollutant_compound_loop</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">)</span>

<span class="w">                        </span><span class="n">i_comp</span><span class="o">=</span><span class="n">pollutant_compound_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">,</span><span class="n">i_loop</span><span class="p">)</span>

<span class="w">                        </span><span class="n">i_file</span><span class="o">=</span><span class="n">emep_subgrid_file_index</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">)</span>
<span class="w">                        </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_nc</span><span class="p">(</span><span class="n">conc_nc_index</span><span class="p">,</span><span class="n">i_comp</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;_original_EMEP_concentration&#39;</span>
<span class="w">                        </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;ug/m3&quot;</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i_comp</span><span class="p">.</span><span class="n">eq</span><span class="p">.</span><span class="n">somo35_index</span><span class="p">)</span><span class="w"> </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;ppb�d&quot;</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">                            </span><span class="c">!write(unit_logfile,&#39;(a,f12.3)&#39;)&#39;Writing netcdf variable: &#39;//trim(var_name_temp),sum(orig_EMEP_subgrid(:,:,:,i_comp))/size(subgrid,1)/size(subgrid,2)/size(subgrid,3)</span>
<span class="w">                            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="w"> </span><span class="n">mean_mask</span><span class="p">(</span><span class="n">orig_EMEP_subgrid</span><span class="p">(:,:,:,</span><span class="n">i_comp</span><span class="p">),</span><span class="n">use_subgrid</span><span class="p">(:,:,</span><span class="n">allsource_index</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="w">                            </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">orig_EMEP_subgrid</span><span class="p">(:,:,:,</span><span class="n">i_comp</span><span class="p">),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                        </span><span class="k">endif</span>
<span class="k">                        if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="w">                            </span><span class="c">! write(unit_logfile,&#39;(a,f12.3)&#39;)&#39;Writing netcdf receptor variable: &#39;//trim(var_name_temp),sum(orig_EMEP_subgrid(:,:,:,i_comp))/size(subgrid,1)/size(subgrid,2)/size(subgrid,3)</span>
<span class="w">                            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="w"> </span><span class="n">mean_mask</span><span class="p">(</span><span class="n">orig_EMEP_subgrid</span><span class="p">(:,:,:,</span><span class="n">i_comp</span><span class="p">),</span><span class="n">use_subgrid</span><span class="p">(:,:,</span><span class="n">allsource_index</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="w">                            </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">orig_EMEP_subgrid</span><span class="p">(:,:,:,</span><span class="n">i_comp</span><span class="p">),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                        </span><span class="k">endif</span>
<span class="k">                    enddo</span>
<span class="k">                endif</span>
<span class="k">            enddo</span>
<span class="k">        endif</span>

<span class="w">        </span><span class="c">!Save AQI</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_aqi</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;--------------------------&#39;</span>
<span class="w">            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;Saving AQI&#39;</span>
<span class="w">            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;--------------------------&#39;</span>
<span class="w">            </span><span class="n">variable_type</span><span class="o">=</span><span class="s1">&#39;byte&#39;</span>
<span class="w">            </span><span class="n">scale_factor</span><span class="o">=</span><span class="mf">0.1</span>
<span class="w">            </span><span class="c">!Hard coded AQI limits</span>
<span class="w">            </span><span class="n">aqi_pollutant_index</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="n">no2_index</span><span class="p">;</span><span class="n">aqi_pollutant_index</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="n">pm10_index</span><span class="p">;</span><span class="n">aqi_pollutant_index</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">=</span><span class="n">pm25_index</span><span class="p">;</span><span class="n">aqi_pollutant_index</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">=</span><span class="n">o3_index</span>
<span class="w">            </span><span class="n">aqi_limits_temp</span><span class="p">(:,</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">)</span><span class="o">=</span><span class="n">aqi_hourly_limits</span><span class="p">(:,</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">)</span>
<span class="w">            </span><span class="n">aqi_limits_temp</span><span class="p">(:,</span><span class="mi">1</span><span class="p">)</span><span class="o">=</span><span class="mf">0.</span>
<span class="w">            </span><span class="n">aqi_limits_temp</span><span class="p">(:,</span><span class="mi">5</span><span class="p">)</span><span class="o">=</span><span class="mf">2.</span><span class="o">*</span><span class="n">aqi_hourly_limits</span><span class="p">(:,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">            </span><span class="n">aqi_subgrid</span><span class="o">=</span><span class="mf">0.</span>

<span class="w">            </span><span class="k">do </span><span class="n">t</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span>
<span class="w">                </span><span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">)</span>
<span class="w">                    </span><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">)</span>
<span class="w">                        </span><span class="n">max_aqi</span><span class="o">=</span><span class="mf">0.</span>
<span class="w">                        </span><span class="k">do </span><span class="n">l</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n_save_aqi_pollutant_index</span><span class="w"> </span><span class="c">!pollutant (no2,pm10,pm2.5,o3)</span>
<span class="w">                            </span><span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="w"> </span><span class="c">!level</span>
<span class="w">                                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">comp_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">aqi_pollutant_index</span><span class="p">(</span><span class="n">l</span><span class="p">)).</span><span class="n">ge</span><span class="p">.</span><span class="n">aqi_limits_temp</span><span class="p">(</span><span class="n">aqi_pollutant_index</span><span class="p">(</span><span class="n">l</span><span class="p">),</span><span class="n">k</span><span class="p">).</span><span class="nb">and</span><span class="p">.</span><span class="n">comp_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">aqi_pollutant_index</span><span class="p">(</span><span class="n">l</span><span class="p">)).</span><span class="n">lt</span><span class="p">.</span><span class="n">aqi_limits_temp</span><span class="p">(</span><span class="n">aqi_pollutant_index</span><span class="p">(</span><span class="n">l</span><span class="p">),</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                    </span><span class="n">aqi_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">aqi_pollutant_index</span><span class="p">(</span><span class="n">l</span><span class="p">))</span><span class="o">=</span><span class="n">k</span><span class="o">+</span><span class="p">(</span><span class="n">comp_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">aqi_pollutant_index</span><span class="p">(</span><span class="n">l</span><span class="p">))</span><span class="o">-</span><span class="n">aqi_limits_temp</span><span class="p">(</span><span class="n">aqi_pollutant_index</span><span class="p">(</span><span class="n">l</span><span class="p">),</span><span class="n">k</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">aqi_limits_temp</span><span class="p">(</span><span class="n">aqi_pollutant_index</span><span class="p">(</span><span class="n">l</span><span class="p">),</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">aqi_limits_temp</span><span class="p">(</span><span class="n">aqi_pollutant_index</span><span class="p">(</span><span class="n">l</span><span class="p">),</span><span class="n">k</span><span class="p">))</span>
<span class="w">                                </span><span class="k">endif</span>
<span class="k">                            enddo</span>
<span class="k">                            </span><span class="n">aqi_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">aqi_pollutant_index</span><span class="p">(</span><span class="n">l</span><span class="p">))</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">aqi_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">aqi_pollutant_index</span><span class="p">(</span><span class="n">l</span><span class="p">)),</span><span class="mf">4.99</span><span class="p">)</span>
<span class="w">                            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">aqi_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">aqi_pollutant_index</span><span class="p">(</span><span class="n">l</span><span class="p">)).</span><span class="n">gt</span><span class="p">.</span><span class="n">max_aqi</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                </span><span class="n">max_aqi</span><span class="o">=</span><span class="n">aqi_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">aqi_pollutant_index</span><span class="p">(</span><span class="n">l</span><span class="p">))</span>
<span class="w">                                </span><span class="n">aqi_responsible_pollutant_index</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">t</span><span class="p">)</span><span class="o">=</span><span class="n">l</span>
<span class="w">                            </span><span class="k">endif</span>
<span class="w">                            </span><span class="c">!write(*,*)  i,j,t,aqi_responsible_pollutant_index(i,j,t),aqi_subgrid(i,j,t,aqi_pollutant_index(l)),max_aqi</span>
<span class="w">                        </span><span class="k">enddo</span>
<span class="k">                    enddo</span>
<span class="k">                enddo</span>
<span class="k">            enddo</span>

<span class="k">            do </span><span class="n">l</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n_save_aqi_pollutant_index</span>
<span class="w">                </span><span class="c">!write(unit_logfile,*)  &#39;MAX AQI in time and space from &#39;//trim(pollutant_file_str(aqi_pollutant_index(l)))//&#39; = &#39;,maxval(aqi_subgrid(:,:,:,aqi_pollutant_index(l)))</span>
<span class="w">            </span><span class="k">enddo</span>

<span class="k">            </span><span class="n">var_name_temp</span><span class="o">=</span><span class="s1">&#39;AQI&#39;</span>
<span class="w">            </span><span class="n">unit_str</span><span class="o">=</span><span class="s1">&#39;1&#39;</span>
<span class="w">            </span><span class="c">!Take the maximum of the pollutants</span>
<span class="w">            </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="nb">maxval</span><span class="p">(</span><span class="n">aqi_subgrid</span><span class="p">(:,:,:,</span><span class="n">aqi_pollutant_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_save_aqi_pollutant_index</span><span class="p">)),</span><span class="mi">4</span><span class="p">)</span><span class="o">/</span><span class="n">scale_factor</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">)</span>
<span class="w">                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">            </span><span class="k">endif</span>
<span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="o">*</span><span class="n">scale_factor</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">            </span><span class="k">endif</span>


<span class="k">            do </span><span class="n">l</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n_save_aqi_pollutant_index</span>

<span class="w">                </span><span class="n">i_comp</span><span class="o">=</span><span class="n">aqi_pollutant_index</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
<span class="w">                </span><span class="n">var_name_temp</span><span class="o">=</span><span class="s1">&#39;AQI_&#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_nc</span><span class="p">(</span><span class="n">conc_nc_index</span><span class="p">,</span><span class="n">i_comp</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">))</span>
<span class="w">                </span><span class="n">unit_str</span><span class="o">=</span><span class="s1">&#39;1&#39;</span>
<span class="w">                </span><span class="c">!Take the maximum of the pollutants</span>
<span class="w">                </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">aqi_subgrid</span><span class="p">(:,:,:,</span><span class="n">i_comp</span><span class="p">)</span><span class="o">/</span><span class="n">scale_factor</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">)</span>
<span class="w">                    </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                </span><span class="k">endif</span>
<span class="k">                if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="o">*</span><span class="n">scale_factor</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                    </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                </span><span class="k">endif</span>

<span class="k">            enddo</span>

<span class="w">            </span><span class="c">!Reset scale_factor</span>
<span class="w">            </span><span class="n">scale_factor</span><span class="o">=</span><span class="mf">1.</span>

<span class="w">        </span><span class="k">endif</span>

<span class="w">        </span><span class="c">!Save deposition</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_deposition</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">calculate_deposition_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;--------------------------&#39;</span>
<span class="w">            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;Saving deposition&#39;</span>
<span class="w">            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;--------------------------&#39;</span>
<span class="w">            </span><span class="n">variable_type</span><span class="o">=</span><span class="s1">&#39;float&#39;</span>
<span class="w">            </span><span class="k">do </span><span class="n">i_pollutant</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n_pollutant_loop</span>
<span class="w">                </span><span class="k">do </span><span class="n">i_source</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n_source_index</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">calculate_source</span><span class="p">(</span><span class="n">i_source</span><span class="p">))</span><span class="w"> </span><span class="k">then</span>

<span class="k">                        </span><span class="n">i_comp</span><span class="o">=</span><span class="n">pollutant_loop_index</span><span class="p">(</span><span class="n">i_pollutant</span><span class="p">)</span>

<span class="w">                        </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_nc</span><span class="p">(</span><span class="n">conc_nc_index</span><span class="p">,</span><span class="n">i_comp</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;_local_dry_deposition_&#39;</span><span class="o">//</span><span class="n">source_file_str</span><span class="p">(</span><span class="n">i_source</span><span class="p">)</span>
<span class="w">                        </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;mg/m2/hr&quot;</span>
<span class="w">                        </span><span class="c">!Save in mg per hour, conversition from ug/m2/s</span>
<span class="w">                        </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">drydepo_local_subgrid_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span><span class="mf">0.</span><span class="o">*</span><span class="mi">360</span><span class="mf">0.</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                            write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,es12.2)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                            </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                        </span><span class="k">endif</span>
<span class="k">                        if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                            write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,es12.2)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                            </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                        </span><span class="k">endif</span>

<span class="k">                        </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_nc</span><span class="p">(</span><span class="n">conc_nc_index</span><span class="p">,</span><span class="n">i_comp</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;_local_wet_deposition_&#39;</span><span class="o">//</span><span class="n">source_file_str</span><span class="p">(</span><span class="n">i_source</span><span class="p">)</span>
<span class="w">                        </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;mg/m2/hr&quot;</span>
<span class="w">                        </span><span class="c">!Save in mg per hour, conversition from ug/m2/s</span>
<span class="w">                        </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">wetdepo_local_subgrid_index</span><span class="p">,</span><span class="n">i_source</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span><span class="mf">0.</span><span class="o">*</span><span class="mi">360</span><span class="mf">0.</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                            write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,es12.2)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                            </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                        </span><span class="k">endif</span>
<span class="k">                        if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                            write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,es12.2)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                            </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                                </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                        </span><span class="k">endif</span>

<span class="k">                    endif</span>
<span class="k">                enddo</span>

<span class="k">                </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_nc</span><span class="p">(</span><span class="n">conc_nc_index</span><span class="p">,</span><span class="n">i_comp</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;_nonlocal_dry_deposition_&#39;</span><span class="o">//</span><span class="n">source_file_str</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">)</span>
<span class="w">                </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;mg/m2/hr&quot;</span>
<span class="w">                </span><span class="c">!Save in mg per hour, conversition from ug/m2/s</span>
<span class="w">                </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">drydepo_nonlocal_subgrid_index</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span><span class="mf">0.</span><span class="o">*</span><span class="mi">360</span><span class="mf">0.</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,es12.2)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                    </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                </span><span class="k">endif</span>
<span class="k">                if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,es12.2)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                    </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                </span><span class="k">endif</span>

<span class="k">                </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_nc</span><span class="p">(</span><span class="n">conc_nc_index</span><span class="p">,</span><span class="n">i_comp</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;_total_dry_deposition_&#39;</span><span class="o">//</span><span class="n">source_file_str</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">)</span>
<span class="w">                </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;mg/m2/hr&quot;</span>
<span class="w">                </span><span class="c">!Save in mg per hour, conversition from ug/m2/s</span>
<span class="w">                </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="p">(</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">drydepo_nonlocal_subgrid_index</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span><span class="o">+</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">drydepo_local_subgrid_index</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">))</span><span class="o">/</span><span class="mi">100</span><span class="mf">0.</span><span class="o">*</span><span class="mi">360</span><span class="mf">0.</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,es12.2)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                    </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                </span><span class="k">endif</span>
<span class="k">                if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,es12.2)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                    </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                </span><span class="k">endif</span>

<span class="k">                </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_nc</span><span class="p">(</span><span class="n">conc_nc_index</span><span class="p">,</span><span class="n">i_comp</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;_nonlocal_wet_deposition_&#39;</span><span class="o">//</span><span class="n">source_file_str</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">)</span>
<span class="w">                </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;mg/m2/hr&quot;</span>
<span class="w">                </span><span class="c">!Save in mg per hour, conversition from ug/m2/s</span>
<span class="w">                </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">wetdepo_nonlocal_subgrid_index</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span><span class="mf">0.</span><span class="o">*</span><span class="mi">360</span><span class="mf">0.</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,es12.2)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                    </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                </span><span class="k">endif</span>
<span class="k">                if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,es12.2)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                    </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                </span><span class="k">endif</span>

<span class="k">                </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_nc</span><span class="p">(</span><span class="n">conc_nc_index</span><span class="p">,</span><span class="n">i_comp</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;_total_wet_deposition_&#39;</span><span class="o">//</span><span class="n">source_file_str</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">)</span>
<span class="w">                </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;mg/m2/hr&quot;</span>
<span class="w">                </span><span class="c">!Save in mg per hour, conversition from ug/m2/s</span>
<span class="w">                </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="p">(</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">wetdepo_nonlocal_subgrid_index</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span><span class="o">+</span><span class="n">subgrid</span><span class="p">(:,:,:,</span><span class="n">wetdepo_local_subgrid_index</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">))</span><span class="o">/</span><span class="mi">100</span><span class="mf">0.</span><span class="o">*</span><span class="mi">360</span><span class="mf">0.</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,es12.2)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                    </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                </span><span class="k">endif</span>
<span class="k">                if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,es12.2)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                    </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                </span><span class="k">endif</span>

<span class="w">                </span><span class="c">!Deposition velocity</span>
<span class="w">                </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="mf">0.</span>
<span class="w">                </span><span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">)</span>
<span class="w">                    </span><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">)</span>
<span class="w">                        </span><span class="n">ii</span><span class="o">=</span><span class="n">crossreference_target_to_deposition_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">x_dim_index</span><span class="p">);</span><span class="n">jj</span><span class="o">=</span><span class="n">crossreference_target_to_deposition_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">y_dim_index</span><span class="p">)</span>
<span class="w">                        </span><span class="n">temp_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,:)</span><span class="o">=</span><span class="n">deposition_subgrid</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,:,</span><span class="n">vd_index</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span>
<span class="w">                    </span><span class="k">enddo</span>
<span class="k">                enddo</span>
<span class="k">                </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_nc</span><span class="p">(</span><span class="n">conc_nc_index</span><span class="p">,</span><span class="n">i_comp</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;_deposition_velocity_&#39;</span><span class="o">//</span><span class="n">source_file_str</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">)</span>
<span class="w">                </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;cm/s&quot;</span>
<span class="w">                </span><span class="c">!Save in cm/s, conversition from ug/m2/s</span>
<span class="w">                </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">temp_subgrid</span><span class="o">*</span><span class="mi">10</span><span class="mf">0.</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,es12.2)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                    </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                </span><span class="k">endif</span>
<span class="k">                if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,es12.2)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                    </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                </span><span class="k">endif</span>

<span class="w">                </span><span class="c">!Landuse category</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">read_landuse_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="mf">0.</span>
<span class="w">                    </span><span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">)</span>
<span class="w">                        </span><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">)</span>
<span class="w">                            </span><span class="n">ii</span><span class="o">=</span><span class="n">crossreference_target_to_deposition_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">x_dim_index</span><span class="p">);</span><span class="n">jj</span><span class="o">=</span><span class="n">crossreference_target_to_deposition_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">y_dim_index</span><span class="p">)</span>
<span class="w">                            </span><span class="n">temp_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,:)</span><span class="o">=</span><span class="n">landuse_subgrid</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">grid_index</span><span class="p">)</span>
<span class="w">                        </span><span class="k">enddo</span>
<span class="k">                    enddo</span>
<span class="k">                    </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_nc</span><span class="p">(</span><span class="n">conc_nc_index</span><span class="p">,</span><span class="n">i_comp</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;_EMEP_landuse_category&#39;</span>
<span class="w">                    </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;1&quot;</span>
<span class="w">                    </span><span class="n">variable_type</span><span class="o">=</span><span class="s1">&#39;byte&#39;</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                        write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,es12.2)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                        </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                            </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                            </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                    </span><span class="k">endif</span>
<span class="k">                    if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                        write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,es12.2)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                        </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                            </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                            </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                            </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                            </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                            </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                            </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                    </span><span class="k">endif</span>
<span class="k">                endif</span>

<span class="k">                </span><span class="n">variable_type</span><span class="o">=</span><span class="s1">&#39;float&#39;</span>

<span class="w">                </span><span class="c">!Save the original emep wet and dry deposition</span>
<span class="w">                </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_nc</span><span class="p">(</span><span class="n">conc_nc_index</span><span class="p">,</span><span class="n">i_comp</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;_original_EMEP_wet_deposition_&#39;</span><span class="o">//</span><span class="n">source_file_str</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">)</span>
<span class="w">                </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;mg/m2/hr&quot;</span>
<span class="w">                </span><span class="c">!Save in mg per hour, conversition from ug/m2/s</span>
<span class="w">                </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">orig_emep_deposition_subgrid</span><span class="p">(:,:,:,</span><span class="n">wetdepo_index</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,es12.2)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                    </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                </span><span class="k">endif</span>
<span class="k">                if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,es12.2)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                    </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                </span><span class="k">endif</span>
<span class="k">                </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_nc</span><span class="p">(</span><span class="n">conc_nc_index</span><span class="p">,</span><span class="n">i_comp</span><span class="p">,</span><span class="n">allsource_index</span><span class="p">))</span><span class="o">//</span><span class="s1">&#39;_original_EMEP_dry_deposition_&#39;</span><span class="o">//</span><span class="n">source_file_str</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">)</span>
<span class="w">                </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;mg/m2/hr&quot;</span>
<span class="w">                </span><span class="c">!Save in mg per hour, conversition from ug/m2/s</span>
<span class="w">                </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="n">orig_emep_deposition_subgrid</span><span class="p">(:,:,:,</span><span class="n">drydepo_index</span><span class="p">,</span><span class="n">i_pollutant</span><span class="p">)</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,es12.2)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                    </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                </span><span class="k">endif</span>
<span class="k">                if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,es12.2)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                    </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                </span><span class="k">endif</span>

<span class="k">            enddo</span>

<span class="k">        endif</span>


<span class="w">        </span><span class="c">!Save the meteo interpolated to the target grid</span>
<span class="w">        </span><span class="n">valid_min</span><span class="o">=-</span><span class="mf">1.e24</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">save_wind_vectors</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;--------------------------&#39;</span>
<span class="w">            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;Saving wind vectors&#39;</span>
<span class="w">            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;--------------------------&#39;</span>
<span class="w">            </span><span class="n">variable_type</span><span class="o">=</span><span class="s1">&#39;float&#39;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">wind_vectors_10m_available</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                </span><span class="n">i_file</span><span class="o">=</span><span class="n">subgrid_u10_file_index</span>
<span class="w">                </span><span class="n">i_meteo</span><span class="o">=</span><span class="n">u10_subgrid_index</span>
<span class="w">            </span><span class="k">else</span>
<span class="k">                </span><span class="n">i_file</span><span class="o">=</span><span class="n">subgrid_ugrid_file_index</span>
<span class="w">                </span><span class="n">i_meteo</span><span class="o">=</span><span class="n">ugrid_subgrid_index</span>
<span class="w">            </span><span class="k">endif</span>

<span class="k">            </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;m/s&quot;</span>
<span class="w">            </span><span class="c">!The same for all--------------------</span>
<span class="w">            </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span>
<span class="w">            </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="mf">0.</span>
<span class="w">            </span><span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">)</span>
<span class="w">                </span><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">)</span>
<span class="w">                    </span><span class="n">ii</span><span class="o">=</span><span class="n">crossreference_target_to_integral_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">x_dim_index</span><span class="p">);</span><span class="n">jj</span><span class="o">=</span><span class="n">crossreference_target_to_integral_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">y_dim_index</span><span class="p">);</span><span class="n">temp_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,:)</span><span class="o">=</span><span class="n">meteo_subgrid</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,:,</span><span class="n">i_meteo</span><span class="p">)</span>
<span class="w">                </span><span class="k">enddo</span>
<span class="k">            enddo</span>
<span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="n">mean_mask</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">use_subgrid</span><span class="p">(:,:,</span><span class="n">allsource_index</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="w">                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">            </span><span class="k">endif</span>
<span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">            </span><span class="k">endif</span>
<span class="w">            </span><span class="c">!The same for all--------------------</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">wind_vectors_10m_available</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                </span><span class="n">i_file</span><span class="o">=</span><span class="n">subgrid_v10_file_index</span>
<span class="w">                </span><span class="n">i_meteo</span><span class="o">=</span><span class="n">v10_subgrid_index</span>
<span class="w">            </span><span class="k">else</span>
<span class="k">                </span><span class="n">i_file</span><span class="o">=</span><span class="n">subgrid_vgrid_file_index</span>
<span class="w">                </span><span class="n">i_meteo</span><span class="o">=</span><span class="n">vgrid_subgrid_index</span>
<span class="w">            </span><span class="k">endif</span>
<span class="k">            </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;m/s&quot;</span>
<span class="w">            </span><span class="c">!The same for all--------------------</span>
<span class="w">            </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span>
<span class="w">            </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="mf">0.</span>
<span class="w">            </span><span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">)</span>
<span class="w">                </span><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">)</span>
<span class="w">                    </span><span class="n">ii</span><span class="o">=</span><span class="n">crossreference_target_to_integral_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">x_dim_index</span><span class="p">);</span><span class="n">jj</span><span class="o">=</span><span class="n">crossreference_target_to_integral_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">y_dim_index</span><span class="p">);</span><span class="n">temp_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,:)</span><span class="o">=</span><span class="n">meteo_subgrid</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,:,</span><span class="n">i_meteo</span><span class="p">)</span>
<span class="w">                </span><span class="k">enddo</span>
<span class="k">            enddo</span>
<span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="n">mean_mask</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">use_subgrid</span><span class="p">(:,:,</span><span class="n">allsource_index</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="w">                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">            </span><span class="k">endif</span>
<span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">            </span><span class="k">endif</span>
<span class="w">            </span><span class="c">!The same for all--------------------</span>
<span class="w">        </span><span class="k">endif</span>


<span class="k">        if</span><span class="w"> </span><span class="p">(</span><span class="n">save_other_meteo</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;--------------------------&#39;</span>
<span class="w">            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;Saving other meteo data&#39;</span>
<span class="w">            </span><span class="k">write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a)&#39;</span><span class="p">)</span><span class="s1">&#39;--------------------------&#39;</span>
<span class="w">            </span><span class="n">variable_type</span><span class="o">=</span><span class="s1">&#39;float&#39;</span>
<span class="w">            </span><span class="n">i_file</span><span class="o">=</span><span class="n">subgrid_hmix_file_index</span>
<span class="w">            </span><span class="n">i_meteo</span><span class="o">=</span><span class="n">hmix_subgrid_index</span>
<span class="w">            </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;m&quot;</span>
<span class="w">            </span><span class="c">!The same for all--------------------</span>
<span class="w">            </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span>
<span class="w">            </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="mf">0.</span>
<span class="w">            </span><span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">)</span>
<span class="w">                </span><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">)</span>
<span class="w">                    </span><span class="n">ii</span><span class="o">=</span><span class="n">crossreference_target_to_integral_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">x_dim_index</span><span class="p">);</span><span class="n">jj</span><span class="o">=</span><span class="n">crossreference_target_to_integral_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">y_dim_index</span><span class="p">);</span><span class="n">temp_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,:)</span><span class="o">=</span><span class="n">meteo_subgrid</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,:,</span><span class="n">i_meteo</span><span class="p">)</span>
<span class="w">                </span><span class="k">enddo</span>
<span class="k">            enddo</span>
<span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="w"> </span><span class="n">mean_mask</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">use_subgrid</span><span class="p">(:,:,</span><span class="n">allsource_index</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="w">                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">            </span><span class="k">endif</span>
<span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">            </span><span class="k">endif</span>
<span class="w">            </span><span class="c">!The same for all--------------------</span>

<span class="w">            </span><span class="n">variable_type</span><span class="o">=</span><span class="s1">&#39;float&#39;</span>
<span class="w">            </span><span class="n">i_file</span><span class="o">=</span><span class="n">subgrid_t2m_file_index</span>
<span class="w">            </span><span class="n">i_meteo</span><span class="o">=</span><span class="n">t2m_subgrid_index</span>
<span class="w">            </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;Celcius&quot;</span>
<span class="w">            </span><span class="c">!The same for all--------------------</span>
<span class="w">            </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span>
<span class="w">            </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="mf">0.</span>
<span class="w">            </span><span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">)</span>
<span class="w">                </span><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">)</span>
<span class="w">                    </span><span class="n">ii</span><span class="o">=</span><span class="n">crossreference_target_to_integral_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">x_dim_index</span><span class="p">);</span><span class="n">jj</span><span class="o">=</span><span class="n">crossreference_target_to_integral_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">y_dim_index</span><span class="p">);</span><span class="n">temp_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,:)</span><span class="o">=</span><span class="n">meteo_subgrid</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,:,</span><span class="n">i_meteo</span><span class="p">)</span><span class="o">-</span><span class="mi">27</span><span class="mf">3.13</span>
<span class="w">                </span><span class="k">enddo</span>
<span class="k">            enddo</span>
<span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.2)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">            </span><span class="k">endif</span>
<span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.2)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">            </span><span class="k">endif</span>
<span class="w">            </span><span class="c">!The same for all--------------------</span>

<span class="w">            </span><span class="n">variable_type</span><span class="o">=</span><span class="s1">&#39;float&#39;</span>
<span class="w">            </span><span class="n">i_file</span><span class="o">=</span><span class="n">subgrid_hmix_file_index</span>
<span class="w">            </span><span class="n">i_meteo</span><span class="o">=</span><span class="n">precip_subgrid_index</span>
<span class="w">            </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;mm/hr&quot;</span>
<span class="w">            </span><span class="c">!The same for all--------------------</span>
<span class="w">            </span><span class="n">var_name_temp</span><span class="o">=</span><span class="s1">&#39;precipitation&#39;</span><span class="c">!trim(filename_grid(i_file))</span>
<span class="w">            </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="mf">0.</span>
<span class="w">            </span><span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">)</span>
<span class="w">                </span><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">)</span>
<span class="w">                    </span><span class="n">ii</span><span class="o">=</span><span class="n">crossreference_target_to_integral_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">x_dim_index</span><span class="p">);</span><span class="n">jj</span><span class="o">=</span><span class="n">crossreference_target_to_integral_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">y_dim_index</span><span class="p">);</span><span class="n">temp_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,:)</span><span class="o">=</span><span class="n">meteo_subgrid</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,:,</span><span class="n">i_meteo</span><span class="p">)</span>
<span class="w">                </span><span class="k">enddo</span>
<span class="k">            enddo</span>
<span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="w"> </span><span class="n">mean_mask</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">use_subgrid</span><span class="p">(:,:,</span><span class="n">allsource_index</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="w">                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">            </span><span class="k">endif</span>
<span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">            </span><span class="k">endif</span>
<span class="w">            </span><span class="c">!The same for all--------------------</span>


<span class="w">            </span><span class="n">i_file</span><span class="o">=</span><span class="n">subgrid_kz_file_index</span>
<span class="w">            </span><span class="n">i_meteo</span><span class="o">=</span><span class="n">kz_subgrid_index</span>
<span class="w">            </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;m2/s&quot;</span>
<span class="w">            </span><span class="c">!The same for all--------------------</span>
<span class="w">            </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span>
<span class="w">            </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="mf">0.</span>
<span class="w">            </span><span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">)</span>
<span class="w">                </span><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">)</span>
<span class="w">                    </span><span class="n">ii</span><span class="o">=</span><span class="n">crossreference_target_to_integral_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">x_dim_index</span><span class="p">);</span><span class="n">jj</span><span class="o">=</span><span class="n">crossreference_target_to_integral_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">y_dim_index</span><span class="p">);</span><span class="n">temp_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,:)</span><span class="o">=</span><span class="n">meteo_subgrid</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,:,</span><span class="n">i_meteo</span><span class="p">)</span>
<span class="w">                </span><span class="k">enddo</span>
<span class="k">            enddo</span>
<span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="w"> </span><span class="n">mean_mask</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">use_subgrid</span><span class="p">(:,:,</span><span class="n">allsource_index</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="w">                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">            </span><span class="k">endif</span>
<span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">            </span><span class="k">endif</span>
<span class="w">            </span><span class="c">!The same for all--------------------</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">hourly_calculations</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>

<span class="k">                if</span><span class="w"> </span><span class="p">(</span><span class="n">wind_vectors_10m_available</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    </span><span class="n">i_file</span><span class="o">=</span><span class="n">subgrid_FF10_file_index</span>
<span class="w">                    </span><span class="n">i_meteo</span><span class="o">=</span><span class="n">FF10_subgrid_index</span>
<span class="w">                </span><span class="k">else</span>
<span class="k">                    </span><span class="n">i_file</span><span class="o">=</span><span class="n">subgrid_FFgrid_file_index</span>
<span class="w">                    </span><span class="n">i_meteo</span><span class="o">=</span><span class="n">FFgrid_subgrid_index</span>
<span class="w">                </span><span class="k">endif</span>
<span class="k">                </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;m/s&quot;</span>
<span class="w">                </span><span class="c">!The same for all--------------------</span>
<span class="w">                </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span>
<span class="w">                </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="mf">0.</span>
<span class="w">                </span><span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">)</span>
<span class="w">                    </span><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">)</span>
<span class="w">                        </span><span class="n">ii</span><span class="o">=</span><span class="n">crossreference_target_to_integral_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">x_dim_index</span><span class="p">);</span><span class="n">jj</span><span class="o">=</span><span class="n">crossreference_target_to_integral_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">y_dim_index</span><span class="p">);</span><span class="n">temp_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,:)</span><span class="o">=</span><span class="n">meteo_subgrid</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,:,</span><span class="n">i_meteo</span><span class="p">)</span>
<span class="w">                    </span><span class="k">enddo</span>
<span class="k">                enddo</span>
<span class="k">                if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="w"> </span><span class="n">mean_mask</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">use_subgrid</span><span class="p">(:,:,</span><span class="n">allsource_index</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="w">                    </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                </span><span class="k">endif</span>
<span class="k">                if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                    </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                </span><span class="k">endif</span>
<span class="w">                </span><span class="c">!The same for all--------------------</span>

<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">wind_vectors_10m_available</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    </span><span class="n">i_file</span><span class="o">=</span><span class="n">subgrid_DD10_file_index</span>
<span class="w">                </span><span class="k">else</span>
<span class="k">                    </span><span class="n">i_file</span><span class="o">=</span><span class="n">subgrid_DDgrid_file_index</span>
<span class="w">                </span><span class="k">endif</span>
<span class="w">                </span><span class="c">!i_meteo=DDgrid_subgrid_index !i_meteo not used in this conversion to wind direction</span>
<span class="w">                </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;degrees&quot;</span>
<span class="w">                </span><span class="k">do </span><span class="n">tt</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span>
<span class="w">                    </span><span class="k">do </span><span class="n">jj</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">integral_subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">)</span>
<span class="w">                        </span><span class="k">do </span><span class="n">ii</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">integral_subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">)</span>
<span class="w">                            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">wind_vectors_10m_available</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                                </span><span class="n">temp_integral_subgrid</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">tt</span><span class="p">)</span><span class="o">=</span><span class="n">DIRECTION</span><span class="p">(</span><span class="n">meteo_subgrid</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">tt</span><span class="p">,</span><span class="n">u10_subgrid_index</span><span class="p">),</span><span class="n">meteo_subgrid</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">tt</span><span class="p">,</span><span class="n">v10_subgrid_index</span><span class="p">))</span>
<span class="w">                            </span><span class="k">else</span>
<span class="k">                                </span><span class="n">temp_integral_subgrid</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">tt</span><span class="p">)</span><span class="o">=</span><span class="n">DIRECTION</span><span class="p">(</span><span class="n">meteo_subgrid</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">tt</span><span class="p">,</span><span class="n">ugrid_subgrid_index</span><span class="p">),</span><span class="n">meteo_subgrid</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">tt</span><span class="p">,</span><span class="n">vgrid_subgrid_index</span><span class="p">))</span>
<span class="w">                            </span><span class="k">endif</span>

<span class="k">                        enddo</span>
<span class="k">                    enddo</span>
<span class="k">                enddo</span>
<span class="w">                </span><span class="c">!This is not converted to real degrees, but subgrid degrees, so is wrong but close</span>

<span class="w">                </span><span class="c">!The same for all--------------------</span>
<span class="w">                </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span>
<span class="w">                </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="mf">0.</span>
<span class="w">                </span><span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">)</span>
<span class="w">                    </span><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">)</span>
<span class="w">                        </span><span class="n">ii</span><span class="o">=</span><span class="n">crossreference_target_to_integral_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">x_dim_index</span><span class="p">);</span><span class="n">jj</span><span class="o">=</span><span class="n">crossreference_target_to_integral_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">y_dim_index</span><span class="p">);</span>
<span class="w">                        </span><span class="c">!In this case this is not the same for all</span>
<span class="w">                        </span><span class="n">temp_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,:)</span><span class="o">=</span><span class="n">temp_integral_subgrid</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,:)</span>
<span class="w">                    </span><span class="k">enddo</span>
<span class="k">                enddo</span>
<span class="k">                if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="w"> </span><span class="n">mean_mask</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">use_subgrid</span><span class="p">(:,:,</span><span class="n">allsource_index</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="w">                    </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                </span><span class="k">endif</span>
<span class="k">                if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                    </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                </span><span class="k">endif</span>
<span class="w">                </span><span class="c">!The same for all--------------------</span>

<span class="w">            </span><span class="k">endif</span>

<span class="k">            </span><span class="n">i_file</span><span class="o">=</span><span class="n">subgrid_invL_file_index</span>
<span class="w">            </span><span class="n">i_meteo</span><span class="o">=</span><span class="n">invL_subgrid_index</span>
<span class="w">            </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;1/m&quot;</span>
<span class="w">            </span><span class="c">!The same for all--------------------</span>
<span class="w">            </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span>
<span class="w">            </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="mf">0.</span>
<span class="w">            </span><span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">)</span>
<span class="w">                </span><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">)</span>
<span class="w">                    </span><span class="n">ii</span><span class="o">=</span><span class="n">crossreference_target_to_integral_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">x_dim_index</span><span class="p">);</span><span class="n">jj</span><span class="o">=</span><span class="n">crossreference_target_to_integral_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">y_dim_index</span><span class="p">);</span><span class="n">temp_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,:)</span><span class="o">=</span><span class="n">meteo_subgrid</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,:,</span><span class="n">i_meteo</span><span class="p">)</span>
<span class="w">                </span><span class="k">enddo</span>
<span class="k">            enddo</span>
<span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.4)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">            </span><span class="k">endif</span>
<span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.4)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">            </span><span class="k">endif</span>
<span class="w">            </span><span class="c">!The same for all--------------------</span>

<span class="w">            </span><span class="n">i_file</span><span class="o">=</span><span class="n">subgrid_logz0_file_index</span>
<span class="w">            </span><span class="n">i_meteo</span><span class="o">=</span><span class="n">logz0_subgrid_index</span>
<span class="w">            </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;log(m)&quot;</span>
<span class="w">            </span><span class="c">!The same for all--------------------</span>
<span class="w">            </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span>
<span class="w">            </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="mf">0.</span>
<span class="w">            </span><span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">)</span>
<span class="w">                </span><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">)</span>
<span class="w">                    </span><span class="n">ii</span><span class="o">=</span><span class="n">crossreference_target_to_integral_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">x_dim_index</span><span class="p">);</span><span class="n">jj</span><span class="o">=</span><span class="n">crossreference_target_to_integral_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">y_dim_index</span><span class="p">);</span><span class="n">temp_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,:)</span><span class="o">=</span><span class="n">meteo_subgrid</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,:,</span><span class="n">i_meteo</span><span class="p">)</span>
<span class="w">                </span><span class="k">enddo</span>
<span class="k">            enddo</span>
<span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="w"> </span><span class="n">mean_mask</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">use_subgrid</span><span class="p">(:,:,</span><span class="n">allsource_index</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="w">                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">            </span><span class="k">endif</span>
<span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">            </span><span class="k">endif</span>
<span class="w">            </span><span class="c">!The same for all--------------------</span>

<span class="w">            </span><span class="n">i_file</span><span class="o">=</span><span class="n">subgrid_ustar_file_index</span>
<span class="w">            </span><span class="n">i_meteo</span><span class="o">=</span><span class="n">ustar_subgrid_index</span>
<span class="w">            </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;m/s&quot;</span>
<span class="w">            </span><span class="c">!The same for all--------------------</span>
<span class="w">            </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span>
<span class="w">            </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="mf">0.</span>
<span class="w">            </span><span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">)</span>
<span class="w">                </span><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">)</span>
<span class="w">                    </span><span class="n">ii</span><span class="o">=</span><span class="n">crossreference_target_to_integral_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">x_dim_index</span><span class="p">);</span><span class="n">jj</span><span class="o">=</span><span class="n">crossreference_target_to_integral_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">y_dim_index</span><span class="p">);</span><span class="n">temp_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,:)</span><span class="o">=</span><span class="n">meteo_subgrid</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,:,</span><span class="n">i_meteo</span><span class="p">)</span>
<span class="w">                </span><span class="k">enddo</span>
<span class="k">            enddo</span>
<span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="w"> </span><span class="n">mean_mask</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">use_subgrid</span><span class="p">(:,:,</span><span class="n">allsource_index</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="w">                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">            </span><span class="k">endif</span>
<span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                    </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">            </span><span class="k">endif</span>
<span class="w">            </span><span class="c">!The same for all--------------------</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">annual_calculations</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>

<span class="k">                </span><span class="n">i_file</span><span class="o">=</span><span class="n">subgrid_invFFgrid_file_index</span>
<span class="w">                </span><span class="n">i_meteo</span><span class="o">=</span><span class="n">inv_FFgrid_subgrid_index</span>
<span class="w">                </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;s/m&quot;</span>
<span class="w">                </span><span class="c">!The same for all--------------------</span>
<span class="w">                </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span>
<span class="w">                </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="mf">0.</span>
<span class="w">                </span><span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">)</span>
<span class="w">                    </span><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">)</span>
<span class="w">                        </span><span class="n">ii</span><span class="o">=</span><span class="n">crossreference_target_to_integral_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">x_dim_index</span><span class="p">);</span><span class="n">jj</span><span class="o">=</span><span class="n">crossreference_target_to_integral_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">y_dim_index</span><span class="p">);</span><span class="n">temp_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,:)</span><span class="o">=</span><span class="n">meteo_subgrid</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,:,</span><span class="n">i_meteo</span><span class="p">)</span>
<span class="w">                    </span><span class="k">enddo</span>
<span class="k">                enddo</span>
<span class="k">                if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="w"> </span><span class="n">mean_mask</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">use_subgrid</span><span class="p">(:,:,</span><span class="n">allsource_index</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="w">                    </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                </span><span class="k">endif</span>
<span class="k">                if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                    </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                </span><span class="k">endif</span>
<span class="w">                </span><span class="c">!The same for all--------------------</span>

<span class="w">                </span><span class="n">i_file</span><span class="o">=</span><span class="n">subgrid_invFF10_file_index</span>
<span class="w">                </span><span class="n">i_meteo</span><span class="o">=</span><span class="n">inv_FF10_subgrid_index</span>
<span class="w">                </span><span class="n">unit_str</span><span class="o">=</span><span class="s2">&quot;s/m&quot;</span>
<span class="w">                </span><span class="c">!The same for all--------------------</span>
<span class="w">                </span><span class="n">var_name_temp</span><span class="o">=</span><span class="nb">trim</span><span class="p">(</span><span class="n">filename_grid</span><span class="p">(</span><span class="n">i_file</span><span class="p">))</span>
<span class="w">                </span><span class="n">temp_subgrid</span><span class="o">=</span><span class="mf">0.</span>
<span class="w">                </span><span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">)</span>
<span class="w">                    </span><span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">)</span>
<span class="w">                        </span><span class="n">ii</span><span class="o">=</span><span class="n">crossreference_target_to_integral_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">x_dim_index</span><span class="p">);</span><span class="n">jj</span><span class="o">=</span><span class="n">crossreference_target_to_integral_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">y_dim_index</span><span class="p">);</span><span class="n">temp_subgrid</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,:)</span><span class="o">=</span><span class="n">meteo_subgrid</span><span class="p">(</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,:,</span><span class="n">i_meteo</span><span class="p">)</span>
<span class="w">                    </span><span class="k">enddo</span>
<span class="k">                enddo</span>
<span class="k">                if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_file_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="w"> </span><span class="n">mean_mask</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="n">use_subgrid</span><span class="p">(:,:,</span><span class="n">allsource_index</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="w">                    </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str</span><span class="p">,</span><span class="n">create_file</span><span class="p">,</span><span class="n">valid_min</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                </span><span class="k">endif</span>
<span class="k">                if</span><span class="w"> </span><span class="p">(</span><span class="n">save_netcdf_receptor_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">n_valid_receptor</span><span class="p">.</span><span class="n">ne</span><span class="p">.</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">                    write</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="s1">&#39;(a,f12.3)&#39;</span><span class="p">)</span><span class="s1">&#39;Writing netcdf receptor variable: &#39;</span><span class="o">//</span><span class="nb">trim</span><span class="p">(</span><span class="n">var_name_temp</span><span class="p">),</span><span class="nb">sum</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">size</span><span class="p">(</span><span class="n">temp_subgrid</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="w">                    </span><span class="k">call </span><span class="n">uEMEP_save_netcdf_receptor_file</span><span class="p">(</span><span class="n">unit_logfile</span><span class="p">,</span><span class="n">temp_name_rec</span><span class="p">,</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">x_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">y_dim_index</span><span class="p">),</span><span class="n">subgrid_dim</span><span class="p">(</span><span class="n">t_dim_index</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">temp_subgrid</span><span class="p">(:,:,:),</span><span class="n">x_subgrid</span><span class="p">,</span><span class="n">y_subgrid</span><span class="p">,</span><span class="n">lon_subgrid</span><span class="p">,</span><span class="n">lat_subgrid</span><span class="p">,</span><span class="n">var_name_temp</span><span class="p">,</span><span class="n">unit_str</span><span class="p">,</span><span class="n">title_str_rec</span><span class="p">,</span><span class="n">create_file_rec</span><span class="p">,</span><span class="n">valid_min</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">x_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">y_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">lon_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">)),</span><span class="n">lat_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">))</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">z_rec</span><span class="p">(</span><span class="n">allsource_index</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">&amp;</span>
<span class="w">                        </span><span class="p">,</span><span class="n">name_receptor</span><span class="p">(</span><span class="n">valid_receptor_index</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">n_valid_receptor</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">n_valid_receptor</span><span class="p">,</span><span class="n">variable_type</span><span class="p">,</span><span class="n">scale_factor</span><span class="p">)</span>
<span class="w">                </span><span class="k">endif</span>
<span class="w">                </span><span class="c">!The same for all--------------------</span>

<span class="w">            </span><span class="k">endif</span>

<span class="k">        endif</span>

<span class="w">        </span><span class="c">!Deallocate the averaging arrays with each receptor grid</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">use_multiple_receptor_grids_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">..</span><span class="nb">not</span><span class="p">.</span><span class="n">use_single_time_loop_flag</span><span class="p">.</span><span class="nb">and</span><span class="p">.</span><span class="n">save_netcdf_average_flag</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">            if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">val_array_av</span><span class="p">))</span><span class="w"> </span><span class="k">deallocate</span><span class="p">(</span><span class="n">val_array_av</span><span class="p">)</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">allocated</span><span class="p">(</span><span class="n">time_seconds_output_av</span><span class="p">))</span><span class="w"> </span><span class="k">deallocate</span><span class="p">(</span><span class="n">time_seconds_output_av</span><span class="p">)</span>
<span class="w">            </span><span class="n">counter_av</span><span class="o">=</span><span class="mi">0</span>
<span class="w">        </span><span class="k">endif</span>


<span class="k">    end subroutine </span><span class="n">uEMEP_save_netcdf_control</span>
</pre></div>

    </section>
    <br>
    
    </div>
  </div>

      <hr>
    </div> <!-- /container -->
    <footer>
      <div class="container">
        <div class="row justify-content-between">
          <div class="col">
            <p>
              uEMEP
 was developed by Norwegian Meteorological Institute<br>              &copy; 2024 
</p>
          </div>
          <div class="col">
            <p class="text-end">
              Documentation generated by
              <a href="https://github.com/Fortran-FOSS-Programmers/ford">FORD</a>
            </p>
          </div>
        </div>
        <br>
      </div> <!-- /container -->
    </footer>

    <!-- Bootstrap core JavaScript -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>    

    <!-- MathJax JavaScript
             ================================================== -->
             <!-- Placed at the end of the document so the pages load faster -->
        <script type="text/x-mathjax-config">
          MathJax.Hub.Config({
          TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' } },
          jax: ['input/TeX','input/MathML','output/HTML-CSS'],
          extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']
          });
        </script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

          <script src="../tipuesearch/tipuesearch_content.js"></script>
          <script src="../tipuesearch/tipuesearch_set.js"></script>
          <script src="../tipuesearch/tipuesearch.js"></script>

  </body>
</html>